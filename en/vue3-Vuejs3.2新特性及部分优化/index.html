<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-xxxxxx-xx"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-xxxxxx-xx');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="It&#39;s an IT blog..."/>
  <meta name="keyword" content="HTML,JavaScript,CSS,TypeScript,VUE,WEBPACK,VITE"/>
  <link rel="shortcut icon" href="/img/avatar/logo.jpg"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css"/>
    <link rel="stylesheet" href="/css/widget.css"/>
    <link rel="stylesheet" href="/css/rocket.css"/>
    <link rel="stylesheet" href="/css/signature.css"/>
    <link rel="stylesheet" href="/css/catalog.css"/>
    <link rel="stylesheet" href="/css/livemylife.css"/>

    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
      <!-- gitalk start -->
      <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->
      <link rel="stylesheet" href="/css/gitalk.css"/>
      <!-- gitalk end -->
    
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="https://jasonluox.github.io/en/vue3-Vuejs3.2新特性及部分优化/">
  <title>
    
      [vue3 源码解读] Vuejs3.2新特性及优化 - 流年风尘 | 我的前端之路
    
  </title>
<meta name="generator" content="Hexo 5.4.0"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--dark">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'dark';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Jason Luo&#39;s Golden House</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">HOME</a>
          </li>

          
          
          
          
          <li>
            <a href="/about/">
              
              ABOUT
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/archive/">
              
              ARCHIVES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              CATEGORIES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/tags/">
              
              TAGS
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>SEARCH</a>
          </li>
          

          <!-- LangSelect -->
          
          
          
          
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('/img/header_img/comic/about_stars3.jpg');
      --intro-header-background-image-url-post: url('/img/header_img/scenery/tree_stars.jpg');
      --intro-header-background-image-url-page: url('//img/header_img/scenery/tree_stars.jpg');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/comic/about_stars3.jpg');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/scenery/tree_stars.jpg');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('//img/header_img/scenery/tree_stars.jpg');
    }

    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('/img/header_img/scenery/tree_stars.jpg'); */
      
    }

    
      #signature {/*signature*/
        background-image: url('/img/signature/jasonluo-white.png');
      }
    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading" style="height: 200px;">
            <div class="tags">
              
              <a class="tag" href="/tags/#vue3源码" title="vue3源码">vue3源码</a>
              
              <a class="tag" href="/tags/#vue3" title="vue3">vue3</a>
              
            </div>
            <h1>[vue3 源码解读] Vuejs3.2新特性及优化</h1>
            <h2 class="subheading"></h2>
            <span class="meta">
              Posted by Jason Luo on
              2021-09-05
            </span>


<!--            
            &lt;!&ndash; WordCount start &ndash;&gt;
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">14</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">3.3k</span> In Total
            </span>
            <div class="blank_box"></div>
            &lt;!&ndash; WordCount end &ndash;&gt;
            
            
            &lt;!&ndash; 不蒜子统计 start &ndash;&gt;
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            &lt;!&ndash; 不蒜子统计 end &ndash;&gt;
            -->


          </div>
          
        </div>
      </div>
    </div>
  </div>

  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <p>更新日志： <a target="_blank" rel="noopener" href="https://github.com/vuejs/vue-next/blob/master/CHANGELOG.md">https://github.com/vuejs/vue-next/blob/master/CHANGELOG.md</a></p>
<p>原版文章： <a target="_blank" rel="noopener" href="https://blog.vuejs.org/posts/vue-3.2.html">https://blog.vuejs.org/posts/vue-3.2.html</a></p>
<h3 id="新特性">新特性</h3>
<h4 id="新的单文件组件功能">新的单文件组件功能</h4>
<ul>
<li><code>&lt;script setup&gt;</code> 是一种编译时语法糖，可在 SFC 内使用 Composition API 时极大地提升工作效率。</li>
<li><code>&lt;style&gt; v-bind</code> 在 SFC 标签中启用组件状态驱动的动态 CSS 值。<code>&lt;style&gt;</code></li>
</ul>
<blockquote>
<p>注：SFC:  Single-File Component 即<strong>单文件组件</strong>的形式编写一个组件</p>
</blockquote>
<p>一起使用这两个新功能的示例组件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line">import &#123; ref &#125; from  vue </span><br><span class="line"></span><br><span class="line">const color &#x3D; ref( red )</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;button @click&#x3D;&quot;color &#x3D; color &#x3D;&#x3D;&#x3D;  red  ?  green  :  red &quot;&gt;</span><br><span class="line">    Color is: &#123;&#123; color &#125;&#125;</span><br><span class="line">  &lt;&#x2F;button&gt;</span><br><span class="line">&lt;&#x2F;template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">button &#123;</span><br><span class="line">  color: v-bind(color);</span><br><span class="line">&#125;</span><br><span class="line">&lt;&#x2F;style&gt;</span><br></pre></td></tr></table></figure>
<h4 id="网络组件">网络组件</h4>
<p>Vue 3.2 引入了一种使用 Vue 组件 API 轻松创建原生自定义元素的新方法：<code>defineCustomElement</code></p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineCustomElement &#125; <span class="keyword">from</span>  vue </span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> MyVueElement = defineCustomElement(&#123;</span><br><span class="line">  <span class="comment">// normal Vue component options here</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Register the custom element.</span></span><br><span class="line"><span class="comment">// After registration, all `&lt;my-vue-element&gt;` tags</span></span><br><span class="line"><span class="comment">// on the page will be upgraded.</span></span><br><span class="line">customElements.define( my-vue-element , MyVueElement)</span><br></pre></td></tr></table></figure>
<p>这个 API 允许开发者创建 Vue 驱动的 UI 组件库，这些库可以与任何框架一起使用，或者根本没有框架。我们还在文档中添加了一个关于在 Vue 中使用和创建 Web 组件的新部分。</p>
<h4 id="性能改进">性能改进</h4>
<p>由于 @basvanmeurs 的出色工作，3.2 对 Vue 的响应式系统进行了一些重大的性能改进。具体如下：</p>
<ul>
<li>更高效的 ref 实现（约 260% 的读取速度/约 50% 的写入速度）</li>
<li>约 40% 更快的依赖跟踪</li>
<li>内存使用量减少约 17%</li>
</ul>
<p>模板编译器也得到了一些改进：</p>
<ul>
<li>创建普通元素 VNode 的速度提高了约 200%</li>
<li>更激进的持续提升</li>
</ul>
<p>最后，有一个新的 <code>v-memo</code> 指令，它提供了记忆部分模板树的能力。<code>v-memo</code>允许 Vue 不仅能跳过虚拟 DOM 差异对比，而且完全跳过新 VNode 的创建。虽然几乎很少用到，但它提供了一个逃生舱来在某些情况下挤出最大性能，例如使用<code>v-for</code>遍历大数据量的列表。</p>
<p>单行添加的<code>v-memo</code>的使用是Vue成为了 <a target="_blank" rel="noopener" href="https://github.com/krausest/js-framework-benchmark">js-framework-benchmark</a>中最快的主流框架</p>
<p>使用单行添加<code>v-momo</code>，让 Vue 成为 <a target="_blank" rel="noopener" href="https://blog.vuejs.org/posts/vue-3.2.html">js-framework-benchmark</a> 中最快的主流框架</p>
<p><img src="image-20210818232506606.png" alt="image-20210818232506606"></p>
<h4 id="服务端渲染">服务端渲染</h4>
<p>3.2 中的包现在提供了一个 ES 模块构建，它也与 Node.js 内置模块分离。这使得捆绑和利用非 Node.js 运行时（例如 CloudFlare Workers 或 Service Workers）成为可能。<code>@vue/server-renderer</code> <code>@vue/server-renderer</code></p>
<p>我们还改进了流式渲染 API，提供了用于渲染到 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Streams_API">Web Streams API</a> 的新方法。查看 <a target="_blank" rel="noopener" href="https://github.com/vuejs/vue-next/tree/master/packages/server-renderer#streaming-api">documentation of <code>@vue/server-renderer</code></a> 以获取更多详细信息。</p>
<h4 id="Effect作用域API">Effect作用域API</h4>
<p>3.2 引入了一个新的  <a target="_blank" rel="noopener" href="https://v3.vuejs.org/api/effect-scope.html">Effect Scope API</a> ，用于直接控制reactive effects（computed and watchers）的处理时间。它可以更轻松地在组件上下文之外利用 Vue 的响应式 API，并且还解锁了组件内部的一些高级用例。</p>
<p>这是主要面向库作者的低级 API，因此建议阅读该功能的 RFC 以了解此功能的动机和用例。</p>
<p>有关 3.2 中所有更改的详细列表，请参阅完整的更改日志。</p>
<h3 id="响应式部分的优化">响应式部分的优化</h3>
<p>Vue3.2 minor 版本的升级主要体现在源码层级的优化。</p>
<p><code>ref</code> API 的读效率提升了大约260%，写效率提升了大约50%。依赖收集的效率提升约为40%，同时还减少了约17%的内存使用。</p>
<p>这个优化社区一位大佬 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fbasvanmeurs">@basvanmeurs</a> 提出的，相关的<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fvue-next%2Fpull%2F2345">优化代码</a>在 2020 年 10 月 9 号就已经提交了，但由于对内部的实现改动较大，官方一直等到了 Vue.js 3.2 发布，才把代码合入。</p>
<p>当初 Vue 3 在宣传的时候，官方宣称在响应式的实现性能上做了优化，那么优化体现在哪些方面呢？有部分小伙伴认为是 <code>Proxy</code> API 的性能要优于 <code>Object.defineProperty</code> 的，其实不然，实际上 <code>Proxy</code> 在性能上是要比 <code>Object.defineProperty</code> 差的，详情可以参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fthecodebarbarian.com%2Fthoughts-on-es6-proxies-performance">Thoughts on ES6 Proxies Performance</a> 这篇文章和这个 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fustbhuangyi%2FProxy-vs-DefineProperty">repo</a>。</p>
<p>既然 <code>Proxy</code> 慢，为啥 Vue 3 还是选择了它来实现数据响应式呢？因为 <code>Proxy</code> 本质上是对某个对象的劫持，这样它不仅仅可以监听对象某个属性值的变化，还可以监听对象属性的新增和删除；而 <code>Object.defineProperty</code> 是给对象的某个已存在的属性添加对应的 <code>getter</code> 和 <code>setter</code>，所以它只能监听这个属性值的变化，而不能去监听对象属性的新增和删除。</p>
<p>而响应式在性能方面的优化其实是体现在把嵌套层级较深的对象变成响应式的场景。在 Vue 2 的实现中，在组件初始化阶段把数据变成响应式时，遇到子属性仍然是对象的情况，会递归执行 <code>Object.defineProperty</code> 定义子对象的响应式；而在 Vue 3 的实现中，只有在对象属性被访问的时候才会判断子属性的类型来决定要不要递归执行 <code>reactive</code>，这其实是一种延时定义子对象响应式的实现，在性能上会有一定的提升。</p>
<p>因此，相比于 Vue 2，Vue 3 确实在响应式实现部分做了一定的优化，但实际上效果是有限的。而 Vue.js 3.2 这次在响应式性能方面的优化，是真的做到了质的飞跃，接下来我们就来上点硬菜，从源码层面分析具体做了哪些优化，以及这些优化背后带来的技术层面的思考。</p>
<p>详细查看 <code>【源码解读】响应式原理实现</code></p>
<h3 id="vnode-部分的优化">vnode 部分的优化</h3>
<h4 id="如何创建-vnode">如何创建 vnode</h4>
<p>我们知道，组件模板经过编译，会生成对应的 <code>render</code> 函数，在 <code>render</code> 函数内部，会执行 <code>createVNode</code> 函数创建 <code>vnode</code> 对象，我们来看一下 Vue.js 3.2 之前它的实现：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createVNode</span>(<span class="params"><span class="keyword">type</span>, props = <span class="literal">null</span>, children = <span class="literal">null</span>, patchFlag = <span class="number">0</span>, dynamicProps = <span class="literal">null</span>, isBlockNode = <span class="literal">false</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">type</span> || <span class="keyword">type</span> === NULL_DYNAMIC_COMPONENT) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((process.env.NODE_ENV !== <span class="string">&#x27;production&#x27;</span>) &amp;&amp; !<span class="keyword">type</span>) &#123;</span><br><span class="line">      warn(<span class="string">`Invalid vnode type when creating vnode: <span class="subst">$&#123;<span class="keyword">type</span>&#125;</span>.`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">type</span> = Comment</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isVNode(<span class="keyword">type</span>)) &#123;</span><br><span class="line">    <span class="keyword">const</span> cloned = cloneVNode(<span class="keyword">type</span>, props, <span class="literal">true</span> <span class="comment">/* mergeRef: true */</span>)</span><br><span class="line">    <span class="keyword">if</span> (children) &#123;</span><br><span class="line">      normalizeChildren(cloned, children)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cloned</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 类组件的标准化</span></span><br><span class="line">  <span class="keyword">if</span> (isClassComponent(<span class="keyword">type</span>)) &#123;</span><br><span class="line">    <span class="keyword">type</span> = <span class="keyword">type</span>.__vccOpts</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// class 和 style 标准化.</span></span><br><span class="line">  <span class="keyword">if</span> (props) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isProxy(props) || InternalObjectKey <span class="keyword">in</span> props) &#123;</span><br><span class="line">      props = extend(&#123;&#125;, props)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> &#123; <span class="attr">class</span>: klass, style &#125; = props</span><br><span class="line">    <span class="keyword">if</span> (klass &amp;&amp; !isString(klass)) &#123;</span><br><span class="line">      props.class = normalizeClass(klass)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isObject(style)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isProxy(style) &amp;&amp; !isArray(style)) &#123;</span><br><span class="line">        style = extend(&#123;&#125;, style)</span><br><span class="line">      &#125;</span><br><span class="line">      props.style = normalizeStyle(style)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 根据 vnode 的类型编码</span></span><br><span class="line">  <span class="keyword">const</span> shapeFlag = isString(<span class="keyword">type</span>)</span><br><span class="line">    ? <span class="number">1</span> <span class="comment">/* ELEMENT */</span></span><br><span class="line">    : isSuspense(<span class="keyword">type</span>)</span><br><span class="line">      ? <span class="number">128</span> <span class="comment">/* SUSPENSE */</span></span><br><span class="line">      : isTeleport(<span class="keyword">type</span>)</span><br><span class="line">        ? <span class="number">64</span> <span class="comment">/* TELEPORT */</span></span><br><span class="line">        : isObject(<span class="keyword">type</span>)</span><br><span class="line">          ? <span class="number">4</span> <span class="comment">/* STATEFUL_COMPONENT */</span></span><br><span class="line">          : isFunction(<span class="keyword">type</span>)</span><br><span class="line">            ? <span class="number">2</span> <span class="comment">/* FUNCTIONAL_COMPONENT */</span></span><br><span class="line">            : <span class="number">0</span></span><br><span class="line">  <span class="keyword">if</span> ((process.env.NODE_ENV !== <span class="string">&#x27;production&#x27;</span>) &amp;&amp; shapeFlag &amp; <span class="number">4</span> <span class="comment">/* STATEFUL_COMPONENT */</span> &amp;&amp; isProxy(<span class="keyword">type</span>)) &#123;</span><br><span class="line">    <span class="keyword">type</span> = toRaw(<span class="keyword">type</span>)</span><br><span class="line">    warn(<span class="string">`Vue received a Component which was made a reactive object. This can `</span> +</span><br><span class="line">      <span class="string">`lead to unnecessary performance overhead, and should be avoided by `</span> +</span><br><span class="line">      <span class="string">`marking the component with \`markRaw\` or using \`shallowRef\` `</span> +</span><br><span class="line">      <span class="string">`instead of \`ref\`.`</span>, <span class="string">`\nComponent that was made reactive: `</span>, <span class="keyword">type</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> vnode = &#123;</span><br><span class="line">    __v_isVNode: <span class="literal">true</span>,</span><br><span class="line">    __v_skip: <span class="literal">true</span>,</span><br><span class="line">    <span class="keyword">type</span>,</span><br><span class="line">    props,</span><br><span class="line">    key: props &amp;&amp; normalizeKey(props),</span><br><span class="line">    ref: props &amp;&amp; normalizeRef(props),</span><br><span class="line">    scopeId: currentScopeId,</span><br><span class="line">    slotScopeIds: <span class="literal">null</span>,</span><br><span class="line">    children: <span class="literal">null</span>,</span><br><span class="line">    component: <span class="literal">null</span>,</span><br><span class="line">    suspense: <span class="literal">null</span>,</span><br><span class="line">    ssContent: <span class="literal">null</span>,</span><br><span class="line">    ssFallback: <span class="literal">null</span>,</span><br><span class="line">    dirs: <span class="literal">null</span>,</span><br><span class="line">    transition: <span class="literal">null</span>,</span><br><span class="line">    el: <span class="literal">null</span>,</span><br><span class="line">    anchor: <span class="literal">null</span>,</span><br><span class="line">    target: <span class="literal">null</span>,</span><br><span class="line">    targetAnchor: <span class="literal">null</span>,</span><br><span class="line">    staticCount: <span class="number">0</span>,</span><br><span class="line">    shapeFlag,</span><br><span class="line">    patchFlag,</span><br><span class="line">    dynamicProps,</span><br><span class="line">    dynamicChildren: <span class="literal">null</span>,</span><br><span class="line">    appContext: <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ((process.env.NODE_ENV !== <span class="string">&#x27;production&#x27;</span>) &amp;&amp; vnode.key !== vnode.key) &#123;</span><br><span class="line">    warn(<span class="string">`VNode created with invalid key (NaN). VNode type:`</span>, vnode.type)</span><br><span class="line">  &#125;</span><br><span class="line">  normalizeChildren(vnode, children)</span><br><span class="line">  <span class="comment">// 标准化 suspense 子节点</span></span><br><span class="line">  <span class="keyword">if</span> (shapeFlag &amp; <span class="number">128</span> <span class="comment">/* SUSPENSE */</span>) &#123;</span><br><span class="line">    <span class="keyword">type</span>.normalize(vnode)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isBlockTreeEnabled &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">    !isBlockNode &amp;&amp;</span><br><span class="line">    currentBlock &amp;&amp;</span><br><span class="line">    (patchFlag &gt; <span class="number">0</span> || shapeFlag &amp; <span class="number">6</span> <span class="comment">/* COMPONENT */</span>) &amp;&amp;</span><br><span class="line">    patchFlag !== <span class="number">32</span> <span class="comment">/* HYDRATE_EVENTS */</span>) &#123;</span><br><span class="line">    currentBlock.push(vnode)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> vnode</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，创建 <code>vnode</code> 的过程做了很多事情，其中有很多判断的逻辑，比如判断 <code>type</code> 是否为空：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">type</span> || <span class="keyword">type</span> === NULL_DYNAMIC_COMPONENT) &#123;</span><br><span class="line">  <span class="keyword">if</span> ((process.env.NODE_ENV !== <span class="string">&#x27;production&#x27;</span>) &amp;&amp; !<span class="keyword">type</span>) &#123;</span><br><span class="line">    warn(<span class="string">`Invalid vnode type when creating vnode: <span class="subst">$&#123;<span class="keyword">type</span>&#125;</span>.`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">type</span> = Comment</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>判断 <code>type</code> 是不是一个 <code>vnode</code> 节点：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isVNode(<span class="keyword">type</span>)) &#123;</span><br><span class="line">  <span class="keyword">const</span> cloned = cloneVNode(<span class="keyword">type</span>, props, <span class="literal">true</span> <span class="comment">/* mergeRef: true */</span>)</span><br><span class="line">  <span class="keyword">if</span> (children) &#123;</span><br><span class="line">    normalizeChildren(cloned, children)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> cloned</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>判断 <code>type</code> 是不是一个 <code>class</code> 类型的组件：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isClassComponent(<span class="keyword">type</span>)) &#123;</span><br><span class="line">    <span class="keyword">type</span> = <span class="keyword">type</span>.__vccOpts</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>除此之外，还会对属性中的 <code>style</code> 和 <code>class</code> 执行标准化，其中也会有一些判断逻辑：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (props) &#123;</span><br><span class="line">  <span class="keyword">if</span> (isProxy(props) || InternalObjectKey <span class="keyword">in</span> props) &#123;</span><br><span class="line">    props = extend(&#123;&#125;, props)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> &#123; <span class="attr">class</span>: klass, style &#125; = props</span><br><span class="line">  <span class="keyword">if</span> (klass &amp;&amp; !isString(klass)) &#123;</span><br><span class="line">    props.class = normalizeClass(klass)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isObject(style)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isProxy(style) &amp;&amp; !isArray(style)) &#123;</span><br><span class="line">      style = extend(&#123;&#125;, style)</span><br><span class="line">    &#125;</span><br><span class="line">    props.style = normalizeStyle(style)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来还会根据 <code>vnode</code> 的类型编码：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> shapeFlag = isString(<span class="keyword">type</span>)</span><br><span class="line">  ? <span class="number">1</span> <span class="comment">/* ELEMENT */</span></span><br><span class="line">  : isSuspense(<span class="keyword">type</span>)</span><br><span class="line">    ? <span class="number">128</span> <span class="comment">/* SUSPENSE */</span></span><br><span class="line">    : isTeleport(<span class="keyword">type</span>)</span><br><span class="line">      ? <span class="number">64</span> <span class="comment">/* TELEPORT */</span></span><br><span class="line">      : isObject(<span class="keyword">type</span>)</span><br><span class="line">        ? <span class="number">4</span> <span class="comment">/* STATEFUL_COMPONENT */</span></span><br><span class="line">        : isFunction(<span class="keyword">type</span>)</span><br><span class="line">          ? <span class="number">2</span> <span class="comment">/* FUNCTIONAL_COMPONENT */</span></span><br><span class="line">          : <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>然后就是创建 <code>vnode</code> 对象，创建完后还会执行 <code>normalizeChildren</code> 去标准化子节点，这个过程也会有一系列的判断逻辑。</p>
<h4 id="创建-vnode-过程的优化">创建 vnode 过程的优化</h4>
<p>仔细想想，<code>vnode</code> 本质上就是一个 JavaScript 对象，之所以在创建过程中做很多判断，是因为要处理各种各样的情况。然而对于普通元素 <code>vnode</code> 而言，完全不需要这么多的判断逻辑，因此对于普通元素 <code>vnode</code>，使用 <code>createVNode</code> 函数创建就是一种浪费。</p>
<p>顺着这个思路，就可以在模板编译阶段，针对普通元素节点，使用新的函数来创建 <code>vnode</code>，Vue.js 3.2 就是这么做的，举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class&#x3D;&quot;home&quot;&gt;</span><br><span class="line">    &lt;img alt&#x3D;&quot;Vue logo&quot; src&#x3D;&quot;..&#x2F;assets&#x2F;logo.png&quot;&gt;</span><br><span class="line">    &lt;HelloWorld msg&#x3D;&quot;Welcome to Your Vue.js App&quot;&#x2F;&gt;</span><br><span class="line">  &lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;template&gt;</span><br></pre></td></tr></table></figure>
<p>借助于模板导出工具，可以看到它编译后的 <code>render</code> 函数：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createElementVNode <span class="keyword">as</span> _createElementVNode, resolveComponent <span class="keyword">as</span> _resolveComponent, createVNode <span class="keyword">as</span> _createVNode, openBlock <span class="keyword">as</span> _openBlock, createElementBlock <span class="keyword">as</span> _createElementBlock &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> _hoisted_1 = &#123; <span class="attr">class</span>: <span class="string">&quot;home&quot;</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_2 = <span class="comment">/*#__PURE__*/</span>_createElementVNode(<span class="string">&quot;img&quot;</span>, &#123;</span><br><span class="line">  alt: <span class="string">&quot;Vue logo&quot;</span>,</span><br><span class="line">  src: <span class="string">&quot;../assets/logo.png&quot;</span></span><br><span class="line">&#125;, <span class="literal">null</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">_ctx, _cache, $props, $setup, $data, $options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> _component_HelloWorld = _resolveComponent(<span class="string">&quot;HelloWorld&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (_openBlock(), _createElementBlock(<span class="string">&quot;template&quot;</span>, <span class="literal">null</span>, [</span><br><span class="line">    _createElementVNode(<span class="string">&quot;div&quot;</span>, _hoisted_1, [</span><br><span class="line">      _hoisted_2,</span><br><span class="line">      _createVNode(_component_HelloWorld, &#123; <span class="attr">msg</span>: <span class="string">&quot;Welcome to Your Vue.js App&quot;</span> &#125;)</span><br><span class="line">    ])</span><br><span class="line">  ]))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>针对于 <code>div</code> 节点，这里使用了 <code>createElementVNode</code> 方法而并非 <code>createVNode</code> 方法，而 <code>createElementVNode</code> 在内部是 <code>createBaseVNode</code> 的别名，来看它的实现：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createBaseVNode</span>(<span class="params"><span class="keyword">type</span>, props = <span class="literal">null</span>, children = <span class="literal">null</span>, patchFlag = <span class="number">0</span>, dynamicProps = <span class="literal">null</span>, shapeFlag = <span class="keyword">type</span> === Fragment ? <span class="number">0</span> : <span class="number">1</span> <span class="comment">/* ELEMENT */</span>, isBlockNode = <span class="literal">false</span>, needFullChildrenNormalization = <span class="literal">false</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> vnode = &#123;</span><br><span class="line">    __v_isVNode: <span class="literal">true</span>,</span><br><span class="line">    __v_skip: <span class="literal">true</span>,</span><br><span class="line">    <span class="keyword">type</span>,</span><br><span class="line">    props,</span><br><span class="line">    key: props &amp;&amp; normalizeKey(props),</span><br><span class="line">    ref: props &amp;&amp; normalizeRef(props),</span><br><span class="line">    scopeId: currentScopeId,</span><br><span class="line">    slotScopeIds: <span class="literal">null</span>,</span><br><span class="line">    children,</span><br><span class="line">    component: <span class="literal">null</span>,</span><br><span class="line">    suspense: <span class="literal">null</span>,</span><br><span class="line">    ssContent: <span class="literal">null</span>,</span><br><span class="line">    ssFallback: <span class="literal">null</span>,</span><br><span class="line">    dirs: <span class="literal">null</span>,</span><br><span class="line">    transition: <span class="literal">null</span>,</span><br><span class="line">    el: <span class="literal">null</span>,</span><br><span class="line">    anchor: <span class="literal">null</span>,</span><br><span class="line">    target: <span class="literal">null</span>,</span><br><span class="line">    targetAnchor: <span class="literal">null</span>,</span><br><span class="line">    staticCount: <span class="number">0</span>,</span><br><span class="line">    shapeFlag,</span><br><span class="line">    patchFlag,</span><br><span class="line">    dynamicProps,</span><br><span class="line">    dynamicChildren: <span class="literal">null</span>,</span><br><span class="line">    appContext: <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (needFullChildrenNormalization) &#123;</span><br><span class="line">    normalizeChildren(vnode, children)</span><br><span class="line">    <span class="keyword">if</span> (shapeFlag &amp; <span class="number">128</span> <span class="comment">/* SUSPENSE */</span>) &#123;</span><br><span class="line">      <span class="keyword">type</span>.normalize(vnode)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (children) &#123;</span><br><span class="line">    vnode.shapeFlag |= isString(children)</span><br><span class="line">      ? <span class="number">8</span> <span class="comment">/* TEXT_CHILDREN */</span></span><br><span class="line">      : <span class="number">16</span> <span class="comment">/* ARRAY_CHILDREN */</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ((process.env.NODE_ENV !== <span class="string">&#x27;production&#x27;</span>) &amp;&amp; vnode.key !== vnode.key) &#123;</span><br><span class="line">    warn(<span class="string">`VNode created with invalid key (NaN). VNode type:`</span>, vnode.type)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isBlockTreeEnabled &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">    !isBlockNode &amp;&amp;</span><br><span class="line">    currentBlock &amp;&amp;</span><br><span class="line">    (vnode.patchFlag &gt; <span class="number">0</span> || shapeFlag &amp; <span class="number">6</span> <span class="comment">/* COMPONENT */</span>) &amp;&amp;</span><br><span class="line">    vnode.patchFlag !== <span class="number">32</span> <span class="comment">/* HYDRATE_EVENTS */</span>) &#123;</span><br><span class="line">    currentBlock.push(vnode)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> vnode</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，<code>createBaseVNode</code> 内部仅仅是创建了 <code>vnode</code> 对象，然后做了一些 <code>block</code> 逻辑的处理。相比于之前的 <code>createVNode</code> 的实现，<code>createBaseVNode</code> 少执行了很多判断逻辑，自然性能就获得了提升。</p>
<p>而 <code>createVNode</code> 的实现，是基于 <code>createBaseVNode</code> 做的一层封装：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createVNode</span>(<span class="params"><span class="keyword">type</span>, props = <span class="literal">null</span>, children = <span class="literal">null</span>, patchFlag = <span class="number">0</span>, dynamicProps = <span class="literal">null</span>, isBlockNode = <span class="literal">false</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">type</span> || <span class="keyword">type</span> === NULL_DYNAMIC_COMPONENT) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((process.env.NODE_ENV !== <span class="string">&#x27;production&#x27;</span>) &amp;&amp; !<span class="keyword">type</span>) &#123;</span><br><span class="line">      warn(<span class="string">`Invalid vnode type when creating vnode: <span class="subst">$&#123;<span class="keyword">type</span>&#125;</span>.`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">type</span> = Comment$<span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isVNode(<span class="keyword">type</span>)) &#123;</span><br><span class="line">    <span class="keyword">const</span> cloned = cloneVNode(<span class="keyword">type</span>, props, <span class="literal">true</span> <span class="comment">/* mergeRef: true */</span>)</span><br><span class="line">    <span class="keyword">if</span> (children) &#123;</span><br><span class="line">      normalizeChildren(cloned, children)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cloned</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isClassComponent(<span class="keyword">type</span>)) &#123;</span><br><span class="line">    <span class="keyword">type</span> = <span class="keyword">type</span>.__vccOpts</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (props) &#123;</span><br><span class="line">    props = guardReactiveProps(props)</span><br><span class="line">    <span class="keyword">let</span> &#123; <span class="attr">class</span>: klass, style &#125; = props</span><br><span class="line">    <span class="keyword">if</span> (klass &amp;&amp; !isString(klass)) &#123;</span><br><span class="line">      props.class = normalizeClass(klass)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isObject$<span class="number">1</span>(style)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isProxy(style) &amp;&amp; !isArray(style)) &#123;</span><br><span class="line">        style = extend(&#123;&#125;, style)</span><br><span class="line">      &#125;</span><br><span class="line">      props.style = normalizeStyle(style)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> shapeFlag = isString(<span class="keyword">type</span>)</span><br><span class="line">    ? <span class="number">1</span> <span class="comment">/* ELEMENT */</span></span><br><span class="line">    : isSuspense(<span class="keyword">type</span>)</span><br><span class="line">      ? <span class="number">128</span> <span class="comment">/* SUSPENSE */</span></span><br><span class="line">      : isTeleport(<span class="keyword">type</span>)</span><br><span class="line">        ? <span class="number">64</span> <span class="comment">/* TELEPORT */</span></span><br><span class="line">        : isObject$<span class="number">1</span>(<span class="keyword">type</span>)</span><br><span class="line">          ? <span class="number">4</span> <span class="comment">/* STATEFUL_COMPONENT */</span></span><br><span class="line">          : isFunction$<span class="number">1</span>(<span class="keyword">type</span>)</span><br><span class="line">            ? <span class="number">2</span> <span class="comment">/* FUNCTIONAL_COMPONENT */</span></span><br><span class="line">            : <span class="number">0</span></span><br><span class="line">  <span class="keyword">if</span> ((process.env.NODE_ENV !== <span class="string">&#x27;production&#x27;</span>) &amp;&amp; shapeFlag &amp; <span class="number">4</span> <span class="comment">/* STATEFUL_COMPONENT */</span> &amp;&amp; isProxy(<span class="keyword">type</span>)) &#123;</span><br><span class="line">    <span class="keyword">type</span> = toRaw(<span class="keyword">type</span>)</span><br><span class="line">    warn(<span class="string">`Vue received a Component which was made a reactive object. This can `</span> +</span><br><span class="line">      <span class="string">`lead to unnecessary performance overhead, and should be avoided by `</span> +</span><br><span class="line">      <span class="string">`marking the component with \`markRaw\` or using \`shallowRef\` `</span> +</span><br><span class="line">      <span class="string">`instead of \`ref\`.`</span>, <span class="string">`\nComponent that was made reactive: `</span>, <span class="keyword">type</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> createBaseVNode(<span class="keyword">type</span>, props, children, patchFlag, dynamicProps, shapeFlag, isBlockNode, <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>createVNode</code> 的实现还是和之前类似，需要执行一堆判断逻辑，最终执行 <code>createBaseVNode</code> 函数创建 <code>vnode</code>，注意这里 <code>createBaseVNode</code> 函数最后一个参数传 <code>true</code>，也就是 <code>needFullChildrenNormalization</code> 为 <code>true</code>，那么在 <code>createBaseVNode</code> 的内部，还需要多执行 <code>normalizeChildren</code> 的逻辑。</p>
<p>组件 <code>vnode</code> 还是通过 <code>createVNode</code> 函数来创建。</p>
<p><strong>总结</strong></p>
<p>虽然看上去只是少执行了几行代码，但由于大部分页面都是由很多普通 DOM 元素构成，创建普通元素 <code>vnode</code> 过程的优化，对整体页面的渲染和更新都会有很大的性能提升。</p>
<p>由于存在模板编译的过程，Vue.js 可以利用编译 + 运行时优化，来实现整体的性能优化。比如 <code>Block Tree</code> 的设计，就优化了 <code>diff</code> 过程的性能。</p>
<h3 id="参考">参考</h3>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6995732683435278344">细说 Vue.js 3.2 关于响应式部分的优化</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/z2ZCUFfFzp3c1ly4IQrrMA">再聊 Vue.js 3.2 关于 vnode 部分的优化</a></p>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/en/vue3-【源码解读】侦听器的实现原理和使用场景/" data-toggle="tooltip" data-placement="top" title="[vue3 源码解读] 侦听器的实现原理和使用场景">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/en/vue3-【源码解读】计算属性/" data-toggle="tooltip" data-placement="top" title="[vue3 源码解读] 计算属性">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. If the images used in the blog infringe your copyright, please contact the author to delete them. Thank you !
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->

  <!-- gitalk start -->
  <!-- Docs:https://github.com/gitalk/gitalk/blob/master/readme-cn.md -->

  <div id="gitalk-container"></div>

  
    <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.js"></script> -->
    <script src="/js/comment/gitalk.js"></script>
  

  <script>
    var gitalk = new Gitalk({
      clientID: 'be77013e3cb3cb9e89f1',
      clientSecret: '39e9b02a8070f1366c5e87418220c8f375864ab8',
      repo: 'jasonluox',
      owner: 'JasonLuox',
      admin: 'JasonLuox',
      id: 'Sun Sep 05 2021 23:03:17 GMT+0800', // Ensure uniqueness and length less than 50
      distractionFreeMode: false, // Facebook-like distraction free mode
      perPage: 10,
      pagerDirection: 'last',
      createIssueManually: false,
      language: 'en',
      proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token'
    });
    gitalk.render('gitalk-container');

    var gtFolded = () => {
      setTimeout(function () {
        let markdownBody = document.getElementsByClassName("markdown-body");
        let list = Array.from(markdownBody);
        list.forEach(item => {
          if (item.clientHeight > 250) {
            item.classList.add('gt-comment-body-folded');
            item.style.maxHeight = '250px';
            item.title = 'Click to Expand';
            item.onclick = function () {
              item.classList.remove('gt-comment-body-folded');
              item.style.maxHeight = '';
              item.title = '';
              item.onclick = null;
            };
          }
        })
      }, 800);
    }
  </script>

  <!-- gitalk end -->


<!-- 2. gitment comment -->


<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%96%B0%E7%89%B9%E6%80%A7"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">新特性</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%96%B0%E7%9A%84%E5%8D%95%E6%96%87%E4%BB%B6%E7%BB%84%E4%BB%B6%E5%8A%9F%E8%83%BD"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">新的单文件组件功能</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">网络组件</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%80%A7%E8%83%BD%E6%94%B9%E8%BF%9B"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">性能改进</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93"><span class="toc-nav-number">1.4.</span> <span class="toc-nav-text">服务端渲染</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Effect%E4%BD%9C%E7%94%A8%E5%9F%9FAPI"><span class="toc-nav-number">1.5.</span> <span class="toc-nav-text">Effect作用域API</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%93%8D%E5%BA%94%E5%BC%8F%E9%83%A8%E5%88%86%E7%9A%84%E4%BC%98%E5%8C%96"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">响应式部分的优化</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#vnode-%E9%83%A8%E5%88%86%E7%9A%84%E4%BC%98%E5%8C%96"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">vnode 部分的优化</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%A6%82%E4%BD%95%E5%88%9B%E5%BB%BA-vnode"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">如何创建 vnode</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%9B%E5%BB%BA-vnode-%E8%BF%87%E7%A8%8B%E7%9A%84%E4%BC%98%E5%8C%96"><span class="toc-nav-number">3.2.</span> <span class="toc-nav-text">创建 vnode 过程的优化</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%8F%82%E8%80%83"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">参考</span></a></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">FEATURED TAGS</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#vue3源码" title="vue3源码">vue3源码</a>
            
            <a class="tag" href="/tags/#vue3" title="vue3">vue3</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          

          

          

          

          

          

          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          Jason Luo
          2021
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="/js/hux-blog.min.js"></script>
  <!-- catalog -->
  <script async="true" type="text/javascript" src="/js/catalog.js"></script>
  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="/js/scroll.js"></script>
    <!-- Scroll end -->
  

  
    <!-- LangSelect start -->
    <script type="text/javascript" src="/js/langselect.js"></script>
    <!-- LangSelect end -->
  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="/js/mouseclick.js" content='我要变强，为此不惜一切...,一念往，尽作尘泥罢...,玻璃晴朗，橘子辉煌...,我心即地狱，管他罪孽滔天...,我要这天，再遮不住我眼...,我要这地，再埋不了我心...,斯若晴空，何惧冰寒...,这灯红酒绿的世界啊...,不要放弃，哪怕付出所有...' color='#CDF0EA,#F9F9F9,#F7DBF0,#BEAEE2,#F38181,#FCE38A,#EAFFD0,#95E1D3,#80D6FF'></script>
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="/js/ribbonDynamic.js"></script>
  

  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("https://jasonluox.github.io/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="SEARCH..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"mobile":{"show":"fasle"},"display":{"hOffset":-40,"vOffset":-80},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
