<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-xxxxxx-xx"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-xxxxxx-xx');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="It&#39;s an IT blog..."/>
  <meta name="keyword" content="HTML,JavaScript,CSS,TypeScript,VUE,WEBPACK,VITE"/>
  <link rel="shortcut icon" href="/img/avatar/logo.jpg"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css"/>
    <link rel="stylesheet" href="/css/widget.css"/>
    <link rel="stylesheet" href="/css/rocket.css"/>
    <link rel="stylesheet" href="/css/signature.css"/>
    <link rel="stylesheet" href="/css/catalog.css"/>
    <link rel="stylesheet" href="/css/livemylife.css"/>

    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
      <!-- gitalk start -->
      <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->
      <link rel="stylesheet" href="/css/gitalk.css"/>
      <!-- gitalk end -->
    
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="https://jasonluox.github.io/en/vue3-渲染器原理及实现/">
  <title>
    
      [vue3] 渲染器原理及实现 - 流年风尘 | 我的前端之路
    
  </title>
<meta name="generator" content="Hexo 5.4.0"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--dark">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'dark';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Jason Luo&#39;s Golden House</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">HOME</a>
          </li>

          
          
          
          
          <li>
            <a href="/about/">
              
              ABOUT
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/archive/">
              
              ARCHIVES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              CATEGORIES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/tags/">
              
              TAGS
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>SEARCH</a>
          </li>
          

          <!-- LangSelect -->
          
          
          
          
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('/img/header_img/comic/about_stars3.jpg');
      --intro-header-background-image-url-post: url('/img/header_img/scenery/tree_stars.jpg');
      --intro-header-background-image-url-page: url('//img/header_img/scenery/tree_stars.jpg');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/comic/about_stars3.jpg');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/scenery/tree_stars.jpg');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('//img/header_img/scenery/tree_stars.jpg');
    }

    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('/img/header_img/scenery/tree_stars.jpg'); */
      
    }

    
      #signature {/*signature*/
        background-image: url('/img/signature/jasonluo-white.png');
      }
    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading" style="height: 200px;">
            <div class="tags">
              
              <a class="tag" href="/tags/#vue3源码" title="vue3源码">vue3源码</a>
              
            </div>
            <h1>[vue3] 渲染器原理及实现</h1>
            <h2 class="subheading">深度探究vue渲染器原理及实现</h2>
            <span class="meta">
              Posted by Jason Luo on
              2021-06-05
            </span>


<!--            
            &lt;!&ndash; WordCount start &ndash;&gt;
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">42</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">9k</span> In Total
            </span>
            <div class="blank_box"></div>
            &lt;!&ndash; WordCount end &ndash;&gt;
            
            
            &lt;!&ndash; 不蒜子统计 start &ndash;&gt;
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            &lt;!&ndash; 不蒜子统计 end &ndash;&gt;
            -->


          </div>
          
        </div>
      </div>
    </div>
  </div>

  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <p>深度好文 <a target="_blank" rel="noopener" href="http://hcysun.me/vue-design/zh/essence-of-comp.html">http://hcysun.me/vue-design/zh/essence-of-comp.html</a></p>
<h3 id="编译器和渲染器-API-初探">编译器和渲染器 API 初探</h3>
<h4 id="Complier和-Renderer">Complier和 Renderer</h4>
<ul>
<li>
<p>编译器 Complier 是用来处理模板（template）的，它把模板编译成 render 函数</p>
</li>
<li>
<p>渲染器 Render 处理 VNoder，把组件渲染到 web 页面上</p>
</li>
</ul>
<p>我们有这样一段 HTML</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;div&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;click&quot;</span>&gt;</span>click<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>编译器会先把他处理成 render 函数，类似下面的的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; h &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> h(<span class="string">&#x27;div&#x27;</span>, &#123;</span><br><span class="line">    id: <span class="string">&#x27;div&#x27;</span>,</span><br><span class="line">  &#125;, [</span><br><span class="line">    h(<span class="string">&#x27;button&#x27;</span>, &#123;</span><br><span class="line">      onClick: <span class="built_in">this</span>.click</span><br><span class="line">    &#125;, <span class="string">&#x27;click&#x27;</span>)</span><br><span class="line">  ])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>渲染器通过 <code>render</code> 函数获取对应的 <code>VNode</code>，类似这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vDom = &#123;</span><br><span class="line">  tag: <span class="string">&#x27;div&#x27;</span>,</span><br><span class="line">  id: <span class="string">&#x27;div&#x27;</span>,</span><br><span class="line">  children: [&#123;</span><br><span class="line">    tag: <span class="string">&#x27;button&#x27;</span>,</span><br><span class="line">    onClick: <span class="built_in">this</span>.click,</span><br><span class="line">    text: <span class="string">&#x27;click&#x27;</span></span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="编译器（Compiler）真实场景">编译器（Compiler）真实场景</h4>
<p>上面是一个很简单的例子，实际上，Vue 3中的编译器做了很多的<strong>优化</strong>工作，比如判断你的节点是静态的还是动态的、缓存事件的绑定等等。所以如果你的组件用 <code>template</code> 实现的话，反而会被 Vue 优化。</p>
<p>我们通过 <a target="_blank" rel="noopener" href="https://vue-next-template-explorer.netlify.app/">Vue 3在线模板编译系统</a> 生成一段真实代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createVNode <span class="keyword">as</span> _createVNode, openBlock <span class="keyword">as</span> _openBlock, createBlock <span class="keyword">as</span> _createBlock &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">_ctx, _cache</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (_openBlock(), _createBlock(<span class="string">&quot;div&quot;</span>, &#123; <span class="attr">id</span>: <span class="string">&quot;div&quot;</span> &#125;, [</span><br><span class="line">    _createVNode(<span class="string">&quot;button&quot;</span>, &#123; <span class="attr">onClick</span>: _ctx.click &#125;, <span class="string">&quot;click&quot;</span>, <span class="number">8</span> <span class="comment">/* PROPS */</span>, [<span class="string">&quot;onClick&quot;</span>])</span><br><span class="line">  ]))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check the console for the AST</span></span><br></pre></td></tr></table></figure>
<p>可以看到和我们手写的 <code>render</code> 函数还是有比较大的差异。</p>
<h3 id="设计-VNode">设计 VNode</h3>
<p>可参考 <a target="_blank" rel="noopener" href="https://github.com/vuejs/vue/blob/master/src/core/vdom/vnode.js">Vue3 VNode源码</a></p>
<p><code>render</code> 函数返回结果就是 <code>h</code> 函数执行的结果，因此 <code>h</code> 函数的输出为 <code>VNode</code>。</p>
<p>所以需要先设计一下我们的 <code>VNode</code>。</p>
<h4 id="用-VNode-描述-HTML">用 VNode 描述 HTML</h4>
<p>一个 <code>html</code> 标签有它的标签名、属性、事件、样式、子节点等诸多信息，这些内容都需要在 <code>VNode</code> 中体现。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;div&quot;</span>&gt;</span></span><br><span class="line">  div text</span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>p text<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> elementVNode = &#123;</span><br><span class="line">  tag: <span class="string">&#x27;div&#x27;</span>,</span><br><span class="line">  props: &#123;</span><br><span class="line">    id: <span class="string">&#x27;div&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  text: <span class="string">&#x27;div text&#x27;</span>,</span><br><span class="line">  children: [&#123;</span><br><span class="line">    tag: <span class="string">&#x27;p&#x27;</span>,</span><br><span class="line">    props: <span class="literal">null</span>,</span><br><span class="line">    text: <span class="string">&#x27;p text&#x27;</span></span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码显示了 DOM 变成 <code>VNode</code> 的表现形式，<code>VNode</code> 各属性解释：</p>
<ul>
<li><code>tag</code> ：表示 DOM 元素的标签名，如 <code>div</code>、<code>span</code> 等</li>
<li><code>props</code>：表示 DOM 元素上的属性，如<code>id</code>、<code>class</code> 等</li>
<li><code>children</code>：表示 DOM 元素的子节点</li>
<li><code>text</code>：表示 DOM 元素的文本节点</li>
</ul>
<p>这样设计 <code>VNode</code> 完全没有问题（实际上 Vue 2 就是这样设计的），但是 Vue 3 设计的 <code>VNode</code> 并不包含 <code>text</code> 属性，而是直接用 <code>children</code> 代替，因为 <code>text</code> 本质也是 DOM 的子节点。</p>
<p><strong>在保证语义讲得通的情况下尽可能复用属性，可以使 <code>VNode</code> 对象更加轻量</strong>。</p>
<p>基于此我们把刚才的 <code>VNode</code> 修改成如下形式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> elementVNode = &#123;</span><br><span class="line">  tag: <span class="string">&#x27;div&#x27;</span>,</span><br><span class="line">  props: &#123;</span><br><span class="line">    id: <span class="string">&#x27;div&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  children: [&#123;</span><br><span class="line">    tag: <span class="literal">null</span>,		<span class="comment">// 根据tag是否为 null 来区分文本节点和元素节点</span></span><br><span class="line">    props: <span class="literal">null</span>,</span><br><span class="line">    children: <span class="string">&#x27;div text&#x27;</span></span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    tag: <span class="string">&#x27;p&#x27;</span>,</span><br><span class="line">    props: <span class="literal">null</span>,</span><br><span class="line">    children: <span class="string">&#x27;p text&#x27;</span></span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="用-VNode-描述抽象内容">用 VNode 描述抽象内容</h4>
<p>什么是抽象内容呢？组件就属于抽象内容，比如下面这一段模板内容：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">MyComponent</span>&gt;</span><span class="tag">&lt;/<span class="name">MyComponent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>MyComponent</code> 是一个组件，我们预期渲染出 <code>MyComponent</code> 组件所有的内容，而不是一个 <code>MyComponent</code> 标签，这用 <code>VNode</code> 如何表示呢？</p>
<p>上一段内容我们其实已经通过 <code>tag</code> 是否为 <code>null</code> 来区分元素节点和文本节点了，那这里我们可以通过 <code>tag</code> 是否是字符串判断是标签还是组件呢？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> elementVNode = &#123;</span><br><span class="line">  tag: <span class="string">&#x27;div&#x27;</span>,</span><br><span class="line">  props: <span class="literal">null</span>,</span><br><span class="line">  children: [&#123;</span><br><span class="line">    tag: MyComponent,</span><br><span class="line">    props: <span class="literal">null</span></span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>理论上是可以的，Vue 2 中就是通过 <code>tag</code> 来判断的，具体过程如下，可以在这里看<a target="_blank" rel="noopener" href="https://github.com/vuejs/vue/blob/master/src/core/vdom/create-element.js#L92">源码</a>：</p>
<ol>
<li><code>VNode.tag</code> 如果不是字符串，则创建组件类型的 <code>VNode</code></li>
<li><code>VNode.tag</code>是字符串
<ol>
<li>若是内置的 <code>html</code> 或 <code>svg</code> 标签，则创建正常的 <code>VNode</code></li>
<li>若是属于某个组件的 id，则创建组件类型的 <code>VNode</code></li>
<li>未知或没有命名空间的组件，直接创建 <code>VNode</code></li>
</ol>
</li>
</ol>
<p>以上这些判断都是在挂载(或 <code>patch</code>)阶段进行的，换句话说，一个 <code>VNode</code> 表示的内容需要在代码运行阶段才知道。这就带来了两个难题：无法从 <code>AOT</code> 的层面优化、开发者无法手动优化。</p>
<p>如果可以提前知道 <code>VNode</code> 类型，那么就可以对其进行优化，所以这里我们可以定义好一套用来判断 <code>VNode</code> 类型的规则，随便是用 <code>FLAG = 1</code> 这样的数字表示还是其它方法。</p>
<h4 id="区分-VNode类型">区分 VNode类型</h4>
<p>这里我们给 <code>VNode</code> 增加一个字段 <code>shapeFlag</code>（这是为了和 Vue 3 保持一致），它是一个枚举类型变量，具体如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> enum ShapeFlags &#123;</span><br><span class="line">  <span class="comment">// html 或 svg 标签</span></span><br><span class="line">  ELEMENT = <span class="number">1</span>,</span><br><span class="line">  <span class="comment">// 函数式组件</span></span><br><span class="line">  FUNCTIONAL_COMPONENT = <span class="number">1</span> &lt;&lt; <span class="number">1</span>,</span><br><span class="line">  <span class="comment">// 普通有状态组件</span></span><br><span class="line">  STATEFUL_COMPONENT = <span class="number">1</span> &lt;&lt; <span class="number">2</span>,</span><br><span class="line">  <span class="comment">// 子节点是纯文本</span></span><br><span class="line">  TEXT_CHILDREN = <span class="number">1</span> &lt;&lt; <span class="number">3</span>,</span><br><span class="line">  <span class="comment">// 子节点是数组</span></span><br><span class="line">  ARRAY_CHILDREN = <span class="number">1</span> &lt;&lt; <span class="number">4</span>,</span><br><span class="line">  <span class="comment">// 子节点是 slots</span></span><br><span class="line">  SLOTS_CHILDREN = <span class="number">1</span> &lt;&lt; <span class="number">5</span>,</span><br><span class="line">  <span class="comment">// Portal</span></span><br><span class="line">  PORTAL = <span class="number">1</span> &lt;&lt; <span class="number">6</span>,</span><br><span class="line">  <span class="comment">// Suspense</span></span><br><span class="line">  SUSPENSE = <span class="number">1</span> &lt;&lt; <span class="number">7</span>,</span><br><span class="line">  <span class="comment">// 需要被keepAlive的有状态组件</span></span><br><span class="line">  COMPONENT_SHOULD_KEEP_ALIVE = <span class="number">1</span> &lt;&lt; <span class="number">8</span>,</span><br><span class="line">  <span class="comment">// 已经被keepAlive的有状态组件</span></span><br><span class="line">  COMPONENT_KEPT_ALIVE = <span class="number">1</span> &lt;&lt; <span class="number">9</span>,</span><br><span class="line">  <span class="comment">// 有状态组件和函数式组件都是“组件”，用 COMPONENT 表示</span></span><br><span class="line">  COMPONENT = ShapeFlags.STATEFUL_COMPONENT | ShapeFlags.FUNCTIONAL_COMPONENT</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们可以修改我们的 <code>VNode</code> 如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> elementVNode = &#123;</span><br><span class="line">  shapeFlag: ShapeFlags.ELEMENT,</span><br><span class="line">  tag: <span class="string">&#x27;div&#x27;</span>,</span><br><span class="line">  props: <span class="literal">null</span>,</span><br><span class="line">  children: [&#123;</span><br><span class="line">    shapeFlag: ShapeFlags.COMPONENT,</span><br><span class="line">    tag: MyComponent,</span><br><span class="line">    props: <span class="literal">null</span></span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>shapeFlag</code> 如何用来判断 <code>VNode</code> 类型呢？按位运算即可。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isComponent = vnode.shapeFlag &amp; ShapeFlags.COMPONENT</span><br></pre></td></tr></table></figure>
<p>熟悉一下按位运算。</p>
<ul>
<li><code>a &amp; b</code>：对于每一个比特位，只有两个操作数相应的比特位都是1时，结果才为1，否则为0。</li>
<li><code>a | b</code>：对于每一个比特位，当两个操作数相应的比特位至少有一个1时，结果为1，否则为0。</li>
</ul>
<p>我们把 <code>ShapeFlags</code> 对应的值列出来，如下：</p>
<table>
<thead>
<tr>
<th>ShapeFlags</th>
<th>操作</th>
<th>bitmap</th>
</tr>
</thead>
<tbody>
<tr>
<td>ELEMENT</td>
<td></td>
<td>000000000<code>1</code></td>
</tr>
<tr>
<td>FUNCTIONAL_COMPONENT</td>
<td>1 &lt;&lt; 1</td>
<td>00000000<code>1</code>0</td>
</tr>
<tr>
<td>STATEFUL_COMPONENT</td>
<td>1 &lt;&lt; 2</td>
<td>0000000<code>1</code>00</td>
</tr>
<tr>
<td>TEXT_CHILDREN</td>
<td>1 &lt;&lt; 3</td>
<td>000000<code>1</code>000</td>
</tr>
<tr>
<td>ARRAY_CHILDREN</td>
<td>1 &lt;&lt; 4</td>
<td>00000<code>1</code>0000</td>
</tr>
<tr>
<td>SLOTS_CHILDREN</td>
<td>1 &lt;&lt; 5</td>
<td>0000<code>1</code>00000</td>
</tr>
<tr>
<td>PORTAL</td>
<td>1 &lt;&lt; 6</td>
<td>000<code>1</code>000000</td>
</tr>
<tr>
<td>SUSPENSE</td>
<td>1 &lt;&lt; 7</td>
<td>00<code>1</code>0000000</td>
</tr>
<tr>
<td>COMPONENT_SHOULD_KEEP_ALIVE</td>
<td>1 &lt;&lt; 8</td>
<td>0<code>1</code>00000000</td>
</tr>
<tr>
<td>COMPONENT_KEPT_ALIVE</td>
<td>1 &lt;&lt; 9</td>
<td><code>1</code>000000000</td>
</tr>
</tbody>
</table>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COMPONENT = ShapeFlags.STATEFUL_COMPONENT | ShapeFlags.FUNCTIONAL_COMPONENT</span><br></pre></td></tr></table></figure>
<p>根据上表展示的基本 <code>flags</code> 值可以很容易地得出下表：</p>
<table>
<thead>
<tr>
<th>ShapeFlags</th>
<th>bitmap</th>
</tr>
</thead>
<tbody>
<tr>
<td>COMPONENT</td>
<td>0000000<code>1</code> <code>1</code>0</td>
</tr>
</tbody>
</table>
<h4 id="区分-children-的类型">区分 children 的类型</h4>
<p>上面我们已经看到了 <code>children</code> 可以是数组或纯文本，但真实场景可能是：</p>
<ul>
<li><code>null</code></li>
<li>纯文本</li>
<li>数组</li>
</ul>
<p>这里我们可以增加一个 <code>ChildrenShapeFlags</code> 的变量表示 <code>children</code> 的类型，但是基于之前的设计原则，我们完全可以用 <code>ShapeFlags</code> 来表示，那么同一个 <code>ShapeFlags</code> 如何既用来表示 <code>VNode</code> 的类型，又用来表示其 <code>children</code> 的类型呢？</p>
<p>仍然是按位运算，我们通过 JavaScript 代码判断 <code>children</code> 类型，然后和当前 <code>VNode</code> 进行按位或运算即可。</p>
<p>我们增加如下函数用来专门处理子节点类型，这和 Vue 3 中的处理一致：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">normalizeChildren</span>(<span class="params">vnode, children</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> type = <span class="number">0</span></span><br><span class="line">  <span class="keyword">if</span> (children == <span class="literal">null</span>) &#123;</span><br><span class="line">    children = <span class="literal">null</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(children)) &#123;</span><br><span class="line">    type = ShapeFlags.ARRAY_CHILDREN</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> children === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    children = <span class="built_in">String</span>(children)</span><br><span class="line">    type = ShapeFlags.TEXT_CHILDREN</span><br><span class="line">  &#125;</span><br><span class="line">  vnode.shapeFlag |= type</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样我们就可以直接通过 <code>shapeFlag</code> 同时判断 <code>VNode</code> 及其 <code>children</code> 类型了。</p>
<blockquote>
<p>为什么 <code>children</code> 也需要标识呢？原因只有一个：<strong>为了 <code>patch</code> 过程的优化</strong>。</p>
</blockquote>
<h4 id="定义-VNode">定义 VNode</h4>
<p>至此，我们可以定义 <code>VNode</code> 结构如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> VNodeProps &#123;</span><br><span class="line">  [key: <span class="built_in">string</span>]: <span class="built_in">any</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> VNode &#123;</span><br><span class="line">  <span class="comment">// _isVNode 是 VNode 对象</span></span><br><span class="line">  _isVNode: <span class="literal">true</span></span><br><span class="line">  <span class="comment">// el VNode 对应的真实 DOM</span></span><br><span class="line">  el: Element | <span class="literal">null</span></span><br><span class="line">  shapeFlag: ShapeFlags.ELEMENT,</span><br><span class="line">  tag: | <span class="built_in">string</span> | Component | <span class="literal">null</span>,</span><br><span class="line">  props: VNodeProps | <span class="literal">null</span>,</span><br><span class="line">  children: <span class="built_in">string</span> | <span class="built_in">Array</span>&lt;VNode&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际上，Vue 3 中对 <code>VNode</code> 的定义要复杂的多，这里就不去细看了。</p>
<h4 id="题外话">题外话</h4>
<p><strong>为什么vue2的<code>template</code>下只允许有一个根元素，vue3却允许有多个？</strong></p>
<p>如果模板中只有一个 <code>td</code> 标签，即只有一个根元素，这很容易表示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> elementVNode = &#123;</span><br><span class="line">  tag: <span class="string">&#x27;td&#x27;</span>,</span><br><span class="line">  data: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是模板中不仅仅只有一个 <code>td</code> 标签，而是有多个 <code>td</code> 标签，即多个根元素，这如何表示？此时我们就需要引入一个抽象元素，也就是我们要介绍的 <code>Fragment</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Fragment = <span class="built_in">Symbol</span>()</span><br><span class="line"><span class="keyword">const</span> fragmentVNode = &#123;</span><br><span class="line">  <span class="comment">// tag 属性值是一个唯一标识</span></span><br><span class="line">  tag: Fragment,</span><br><span class="line">  data: <span class="literal">null</span>,</span><br><span class="line">  children: [</span><br><span class="line">    &#123;</span><br><span class="line">      tag: <span class="string">&#x27;td&#x27;</span>,</span><br><span class="line">      data: <span class="literal">null</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      tag: <span class="string">&#x27;td&#x27;</span>,</span><br><span class="line">      data: <span class="literal">null</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      tag: <span class="string">&#x27;td&#x27;</span>,</span><br><span class="line">      data: <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上，我们把所有 <code>td</code> 标签都作为 <code>fragmentVNode</code> 的子节点，根元素并不是一个实实在在的真实 DOM，而是一个抽象的标识，即 <code>Fragment</code>。</p>
<p>当渲染器在渲染 <code>VNode</code> 时，如果发现该 <code>VNode</code> 的类型是 <code>Fragment</code>，就只需要把该 <code>VNode</code> 的子节点渲染到页面。</p>
<h3 id="生成-VNode-的-h-函数">生成 VNode 的 h 函数</h3>
<h4 id="基本的-h-函数">基本的 h 函数</h4>
<p>首先我们实现一个最简单的<code>h</code>函数，可以使这样的，接收三个参数：</p>
<ul>
<li><code>tag</code> 标签名</li>
<li><code>props</code> DOM 上的属性</li>
<li><code>children</code> 子节点</li>
</ul>
<p>我们新建一个文件<code>h.ts</code>，内容如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">h</span>(<span class="params">tag, props, children</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    tag,</span><br><span class="line">    props,</span><br><span class="line">    children</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们用如下的 <code>VNode</code> 来表示 <code>hello</code>：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; h &#125; <span class="keyword">from</span> <span class="string">&#x27;./h&#x27;</span></span><br><span class="line"><span class="keyword">const</span> vdom = h(<span class="string">&#x27;div&#x27;</span>, &#123;</span><br><span class="line">  class: &#x27;red&#x27;</span><br><span class="line">&#125;, [</span><br><span class="line">  h(<span class="string">&#x27;span&#x27;</span>, <span class="literal">null</span>, <span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<p>看一下实际输出内容：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vdom = &#123;</span><br><span class="line">  <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;div&quot;</span>,</span><br><span class="line">  <span class="string">&quot;props&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;class&quot;</span>: <span class="string">&quot;red&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;children&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;span&quot;</span>,</span><br><span class="line">      <span class="string">&quot;props&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="string">&quot;children&quot;</span>: <span class="string">&quot;hello&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>基本符合预期，但是这里有同学可能又要问了：“这个 <code>vdom</code> 和写的 <code>h</code> 函数没什么不同，为什么不直接写 <code>VNode</code>？”</p>
<p>这是因为我们现在的 <code>h</code> 函数所做的仅仅就是返回传入的参数，实际上根据我们对 <code>VNode</code> 的定义，还缺少一些字段，不过你也可以直接写 <code>VNode</code>，但这样会增加大量的额外工作。</p>
<h4 id="完整的-h-函数">完整的 h 函数</h4>
<p>现在我们补全 <code>h</code> 函数，添加 <code>_isVNode</code>、<code>el</code> 和 <code>shapeFlag</code> 字段。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">h</span>(<span class="params">tag, props = <span class="literal">null</span>, children = <span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    _isVNode: <span class="literal">true</span>,</span><br><span class="line">    el: <span class="literal">null</span>,</span><br><span class="line">    shapeFlag: <span class="literal">null</span>,</span><br><span class="line">    tag,</span><br><span class="line">    props,</span><br><span class="line">    children</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 <code>_isVNode</code> 永远为 <code>true</code>，<code>el</code> 不是在创建 <code>VNode</code> 的时候赋值，所以不用处理，我们主要处理 <code>shapeFlag</code>，实际上 <code>shapeFlag</code> 有 10 种类型，我们这里只实现一个最简单的判断：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">h</span>(<span class="params">tag, props = <span class="literal">null</span>, children = <span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> shapeFlag = <span class="literal">null</span></span><br><span class="line">  <span class="comment">// 这里为了简化，直接这样判断</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> tag === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    shapeFlag = ShapeFlags.ELEMENT</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">typeof</span> tag === <span class="string">&#x27;object&#x27;</span>)&#123;</span><br><span class="line">    shapeFlag = ShapeFlags.STATEFUL_COMPONENT</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">typeof</span> tag === <span class="string">&#x27;function&#x27;</span>)&#123;</span><br><span class="line">    shapeFlag = ShapeFlags.FUNCTIONAL_COMPONENT</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    _isVNode: <span class="literal">true</span>,</span><br><span class="line">    el: <span class="literal">null</span>,</span><br><span class="line">    shapeFlag,</span><br><span class="line">    tag,</span><br><span class="line">    props,</span><br><span class="line">    children</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们需要处理一下 <code>children</code> 的类型了，VNode 章节中我们讲过其判断逻辑，那么 <code>h</code> 函数现在完整逻辑如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">h</span>(<span class="params">tag, props = <span class="literal">null</span>, children = <span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> shapeFlag = <span class="literal">null</span></span><br><span class="line">  <span class="comment">// 这里为了简化，直接这样判断</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> tag === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    shapeFlag = ShapeFlags.ELEMENT</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">typeof</span> tag === <span class="string">&#x27;object&#x27;</span>)&#123;</span><br><span class="line">    shapeFlag = ShapeFlags.STATEFUL_COMPONENT</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">typeof</span> tag === <span class="string">&#x27;function&#x27;</span>)&#123;</span><br><span class="line">    shapeFlag = ShapeFlags.FUNCTIONAL_COMPONENT</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> vnode = &#123;</span><br><span class="line">    _isVNode: <span class="literal">true</span>,</span><br><span class="line">    el: <span class="literal">null</span>,</span><br><span class="line">    shapeFlag,</span><br><span class="line">    tag,</span><br><span class="line">    props,</span><br><span class="line">    children</span><br><span class="line">  &#125;</span><br><span class="line">  normalizeChildren(vnode, vnode.children)</span><br><span class="line">  <span class="keyword">return</span> vnode</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">normalizeChildren</span>(<span class="params">vnode, children</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="keyword">type</span> = <span class="number">0</span></span><br><span class="line">  <span class="keyword">if</span> (children == <span class="literal">null</span>) &#123;</span><br><span class="line">    children = <span class="literal">null</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(children)) &#123;</span><br><span class="line">    <span class="keyword">type</span> = ShapeFlags.ARRAY_CHILDREN</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> children === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">type</span> = ShapeFlags.SLOTS_CHILDREN</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> children === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    children = <span class="built_in">String</span>(children)</span><br><span class="line">    <span class="keyword">type</span> = ShapeFlags.TEXT_CHILDREN</span><br><span class="line">  &#125;</span><br><span class="line">  vnode.shapeFlag |= <span class="keyword">type</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们重新写一个测试代码看一下 <code>h</code> 函数输入结果：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; h &#125; <span class="keyword">from</span> <span class="string">&#x27;./h&#x27;</span></span><br><span class="line"><span class="keyword">const</span> MyComponent = &#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> vdom = h(<span class="string">&#x27;div&#x27;</span>, &#123;</span><br><span class="line">  class: &#x27;red&#x27;</span><br><span class="line">&#125;, [</span><br><span class="line">  h(<span class="string">&#x27;p&#x27;</span>, <span class="literal">null</span>, <span class="string">&#x27;hello&#x27;</span>),</span><br><span class="line">  h(<span class="string">&#x27;p&#x27;</span>, <span class="literal">null</span>, <span class="literal">null</span>),</span><br><span class="line">  h(MyComponent)</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(vdom);</span><br><span class="line"><span class="comment">// vdom:</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//   _isVNode: true,</span></span><br><span class="line"><span class="comment">//   el: null,</span></span><br><span class="line"><span class="comment">//   shapeFlag: 17,</span></span><br><span class="line"><span class="comment">//   tag: &#x27;div&#x27;,</span></span><br><span class="line"><span class="comment">//   props: &#123; class: &#x27;red&#x27; &#125;,</span></span><br><span class="line"><span class="comment">//   children: [</span></span><br><span class="line"><span class="comment">//     &#123;</span></span><br><span class="line"><span class="comment">//       _isVNode: true,</span></span><br><span class="line"><span class="comment">//       el: null,</span></span><br><span class="line"><span class="comment">//       shapeFlag: 9,</span></span><br><span class="line"><span class="comment">//       tag: &#x27;p&#x27;,</span></span><br><span class="line"><span class="comment">//       props: null,</span></span><br><span class="line"><span class="comment">//       children: &#x27;hello&#x27;</span></span><br><span class="line"><span class="comment">//     &#125;,</span></span><br><span class="line"><span class="comment">//     &#123;</span></span><br><span class="line"><span class="comment">//       _isVNode: true,</span></span><br><span class="line"><span class="comment">//       el: null,</span></span><br><span class="line"><span class="comment">//       shapeFlag: 1,</span></span><br><span class="line"><span class="comment">//       tag: &#x27;p&#x27;,</span></span><br><span class="line"><span class="comment">//       props: null,</span></span><br><span class="line"><span class="comment">//       children: null</span></span><br><span class="line"><span class="comment">//     &#125;,</span></span><br><span class="line"><span class="comment">//     &#123;</span></span><br><span class="line"><span class="comment">//       _isVNode: true,</span></span><br><span class="line"><span class="comment">//       el: null,</span></span><br><span class="line"><span class="comment">//       shapeFlag: 4,</span></span><br><span class="line"><span class="comment">//       tag: [Object],</span></span><br><span class="line"><span class="comment">//       props: null,</span></span><br><span class="line"><span class="comment">//       children: null</span></span><br><span class="line"><span class="comment">//     &#125;</span></span><br><span class="line"><span class="comment">//   ]</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="渲染-VNode-的-mount-函数">渲染 VNode 的 mount 函数</h3>
<p>得到 <code>VNode</code> 之后，我们需要把它渲染到页面上，这就是渲染器的 <code>Mount</code> 阶段。</p>
<h4 id="mount-函数基本原理">mount 函数基本原理</h4>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mount</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> el = <span class="built_in">document</span>.createElement(vnode.tag)</span><br><span class="line">  container.appendChild(el);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这就是挂载所做的核心事情，不过这里我们还缺少具体要实现的内容：</p>
<ol>
<li>根据不同 <code>shapeFlag</code> 生成不同 DOM</li>
<li>设置 DOM 的属性</li>
<li>DOM 子节点的处理</li>
<li>生成 DOM 后需将其赋值给 <code>vnode.el</code></li>
</ol>
<h4 id="解决-VNode-的类型问题">解决 VNode 的类型问题</h4>
<p>这里我们需要先了解一下普通有状态组件和函数式组件分别是什么，以下仅做理解用。</p>
<ul>
<li>普通有状态组件</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MyComponent = &#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> h(<span class="string">&#x27;div&#x27;</span>, <span class="literal">null</span>, <span class="string">&#x27;stateful component&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数式组件</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyFunctionalComponent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> h(<span class="string">&#x27;div&#x27;</span>, <span class="literal">null</span>, <span class="string">&#x27;function component&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们根据<code>vnode.shapeFlag</code>的值来对各种类型<code>VNode</code>进行渲染操作</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mount</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (vnode.tag === <span class="literal">null</span>) &#123;</span><br><span class="line">    mountTextElement(vnode, container)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vnode.shapeFlag &amp; ShapeFlags.ELEMENT) &#123;</span><br><span class="line">    mountElement(vnode, container)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vnode.shapeFlag &amp; ShapeFlags.STATEFUL_COMPONENT) &#123;</span><br><span class="line">    mountStatefulComponent(vnode, container)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vnode.shapeFlag &amp; ShapeFlags.FUNCTIONAL_COMPONENT) &#123;</span><br><span class="line">    mountFunctionalComponent(vnode, container)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountTextElement</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountElement</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountStatefulComponent</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountFunctionalComponent</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="渲染文本节点">渲染文本节点</h5>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountTextElement</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> el = <span class="built_in">document</span>.createTextNode(vnode.children)</span><br><span class="line">  container.appendChild(el)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="渲染标签节点">渲染标签节点</h5>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountElement</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> el = <span class="built_in">document</span>.createElement(vnode.tag)</span><br><span class="line">  container.appendChild(el)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="渲染普通有状态组件">渲染普通有状态组件</h5>
<p>普通有状态组件就是一个对象，通过<code>render</code>返回其<code>VNode</code>,因此其渲染方法如下</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountStatefulComponent</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> instance = vnode.tag</span><br><span class="line">  instance.$vnode = instance.render()</span><br><span class="line">  mount(instance.$vnode, container)</span><br><span class="line">  instance.$el = vnode.el = instance.$vnode.el</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="渲染函数式组件">渲染函数式组件</h5>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountFunctionalComponent</span>(<span class="params">vnode, container</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> $vnode = vnode.tag()</span><br><span class="line">  mount($vnode, container)</span><br><span class="line">  vnode.el = $vnode.el</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="设置-DOM-属性">设置 DOM 属性</h4>
<p>这里为了简化，我们假设<code>props</code>的每一项都是<code>DOM</code>的<code>attribute</code>，所以我们可以这样做</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountElement</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> el = <span class="built_in">document</span>.createElement(vnode.tag)</span><br><span class="line">  <span class="keyword">if</span>(vnode.props)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">const</span> key <span class="keyword">in</span> vnode.props)&#123;</span><br><span class="line">      <span class="keyword">const</span> value = vnode.props[key]</span><br><span class="line">      el.setAttribute(key, value)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  container.appendChild(el);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际上，Vue 3 中 <code>props</code> 是一个扁平化的结构，它同时包含了 <code>property</code>、<code>attribute</code>、<code>event listener</code>等，每一项都需要单独处理，如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">props: &#123;</span><br><span class="line">  id: <span class="string">&#x27;div&#x27;</span>,</span><br><span class="line">  class: &#x27;red&#x27;,</span><br><span class="line">  key: <span class="string">&#x27;key1&#x27;</span>,</span><br><span class="line">  onClick: <span class="built_in">this</span>.onClick</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单解释 <code>property</code>、<code>attribute</code> 的区别就是：<code>attribute</code> 是 DOM 自带的属性，如：<code>id</code>、<code>class</code>；<code>property</code> 是自定义的属性名，如：<code>key</code>、<code>data-xxx</code>。</p>
<p>这里我们简单处理一下事件绑定：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isOn = <span class="function">(<span class="params">key</span>) =&gt;</span> key[<span class="number">0</span>] === <span class="string">&#x27;o&#x27;</span> &amp;&amp; key[<span class="number">1</span>] === <span class="string">&#x27;n&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountElement</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> el = <span class="built_in">document</span>.createElement(vnode.tag)</span><br><span class="line">  <span class="keyword">if</span> (vnode.props) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> vnode.props) &#123;</span><br><span class="line">      <span class="keyword">const</span> value = vnode.props[key]</span><br><span class="line">      <span class="keyword">if</span> (isOn(key)) &#123;</span><br><span class="line">        el.addEventListener(key.slice(<span class="number">2</span>).toLowerCase(), value)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        el.setAttribute(key, value)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  container.appendChild(el);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="渲染子节点">渲染子节点</h4>
<p>我们知道 <code>children</code> 可以是字符串或数组，因此实现方法如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountElement</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> el = <span class="built_in">document</span>.createElement(vnode.tag)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// props</span></span><br><span class="line">  <span class="keyword">if</span>(vnode.props)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">const</span> key <span class="keyword">in</span> vnode.props)&#123;</span><br><span class="line">      <span class="keyword">const</span> value = vnode.props[key]</span><br><span class="line">      el.setAttribute(key, value)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// children</span></span><br><span class="line">  <span class="keyword">if</span>(vnode.children)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> vnode.children === <span class="string">&#x27;string&#x27;</span>)&#123;</span><br><span class="line">      el.textContent = vnode.children</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      vnode.children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">        mount(child, el)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  container.appendChild(el);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="关联-VNode-及其-DOM">关联 VNode 及其 DOM</h4>
<p>这个只需要增加一行代码即可，其它函数类似：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountTextElement</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> el = <span class="built_in">document</span>.createTextNode(vnode.children)</span><br><span class="line">  vnode.el = el <span class="comment">// （*）</span></span><br><span class="line">  container.appendChild(el)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="完整实现">完整实现</h4>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mount</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (vnode.tag === <span class="literal">null</span>) &#123;</span><br><span class="line">    mountTextElement(vnode, container)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vnode.shapeFlag &amp;&amp; ShapeFlags.ELEMENT) &#123;</span><br><span class="line">    mountElement(vnode, container)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vnode.shapeFlag &amp;&amp; ShapeFlags.STATEFUL_COMPONENT) &#123;</span><br><span class="line">    mountStatefulComponent(vnode, container)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vnode.shapeFlag &amp;&amp; ShapeFlags.FUNCTIONAL_COMPONENT) &#123;</span><br><span class="line">    mountFunctionalComponent(vnode, container)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountTextElement</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> el = <span class="built_in">document</span>.createTextNode(vnode.children)</span><br><span class="line">  vnode.el = el</span><br><span class="line">  container.appendChild(el)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountElement</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> el = <span class="built_in">document</span>.createElement(vnode.tag)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// props</span></span><br><span class="line">  <span class="keyword">if</span>(vnode.props)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">const</span> key <span class="keyword">in</span> vnode.props)&#123;</span><br><span class="line">      <span class="keyword">const</span> value = vnode.props[key]</span><br><span class="line">      el.setAttribute(key, value)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// children</span></span><br><span class="line">  <span class="keyword">if</span>(vnode.children)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> vnode.children === <span class="string">&#x27;string&#x27;</span>)&#123;</span><br><span class="line">      el.textContent = vnode.children</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      vnode.children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">        mount(child, el)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  vnode.el = el</span><br><span class="line">  container.appendChild(el)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountStatefulComponent</span>(<span class="params">vnode, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> instance = vnode.tag</span><br><span class="line">  instance.$vnode = instance.render()</span><br><span class="line">  mount(instance.$vnode, container)</span><br><span class="line">  instance.$el = vnode.el = instance.$vnode.el</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountFunctionalComponent</span>(<span class="params">vnode, container</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> $vnode = vnode.tag()</span><br><span class="line">  mount($vnode, container)</span><br><span class="line">  vnode.el = $vnode.el</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="完整示例">完整示例</h4>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Renderer Demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- &lt;script src=&quot;https://unpkg.com/vue@next&quot;&gt;&lt;/script&gt; --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">    .red &#123;</span><br><span class="line"><span class="css">      <span class="attribute">color</span>: red</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> ShapeFlags = &#123;</span></span><br><span class="line"><span class="javascript">      <span class="comment">// html 或 svg 标签</span></span></span><br><span class="line">      ELEMENT: 1,</span><br><span class="line"><span class="javascript">      <span class="comment">// 函数式组件</span></span></span><br><span class="line">      FUNCTIONAL_COMPONENT: 1 &lt;&lt; 1,</span><br><span class="line"><span class="javascript">      <span class="comment">// 普通有状态组件</span></span></span><br><span class="line">      STATEFUL_COMPONENT: 1 &lt;&lt; 2,</span><br><span class="line"><span class="javascript">      <span class="comment">// 子节点是纯文本</span></span></span><br><span class="line">      TEXT_CHILDREN: 1 &lt;&lt; 3,</span><br><span class="line"><span class="javascript">      <span class="comment">// 子节点是数组</span></span></span><br><span class="line">      ARRAY_CHILDREN: 1 &lt;&lt; 4,</span><br><span class="line"><span class="javascript">      <span class="comment">// 子节点是 slots</span></span></span><br><span class="line">      SLOTS_CHILDREN: 1 &lt;&lt; 5,</span><br><span class="line"><span class="javascript">      <span class="comment">// Portal</span></span></span><br><span class="line">      PORTAL: 1 &lt;&lt; 6,</span><br><span class="line"><span class="javascript">      <span class="comment">// Suspense</span></span></span><br><span class="line">      SUSPENSE: 1 &lt;&lt; 7,</span><br><span class="line"><span class="javascript">      <span class="comment">// 需要被keepAlive的有状态组件</span></span></span><br><span class="line">      COMPONENT_SHOULD_KEEP_ALIVE: 1 &lt;&lt; 8,</span><br><span class="line"><span class="javascript">      <span class="comment">// 已经被keepAlive的有状态组件</span></span></span><br><span class="line">      COMPONENT_KEPT_ALIVE: 1 &lt;&lt; 9,</span><br><span class="line"><span class="javascript">      <span class="comment">// 有状态组件和函数式组件都是“组件”，用 COMPONENT 表示</span></span></span><br><span class="line"><span class="javascript">      <span class="comment">// COMPONENT: ShapeFlags.STATEFUL_COMPONENT | ShapeFlags.FUNCTIONAL_COMPONENT</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ShapeFlags.COMPONENT = ShapeFlags.STATEFUL_COMPONENT | ShapeFlags.FUNCTIONAL_COMPONENT</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">h</span>(<span class="params">tag, props = <span class="literal">null</span>, children = <span class="literal">null</span></span>) </span>&#123;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> shapeFlag = <span class="literal">null</span></span></span><br><span class="line"><span class="javascript">      <span class="comment">// 这里为了简化，直接这样判断</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">if</span> (<span class="keyword">typeof</span> tag === <span class="string">&#x27;string&#x27;</span>) &#123;</span></span><br><span class="line">        shapeFlag = ShapeFlags.ELEMENT</span><br><span class="line"><span class="javascript">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> tag === <span class="string">&#x27;object&#x27;</span>) &#123;</span></span><br><span class="line">        shapeFlag = ShapeFlags.STATEFUL_COMPONENT</span><br><span class="line"><span class="javascript">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> tag === <span class="string">&#x27;function&#x27;</span>) &#123;</span></span><br><span class="line">        shapeFlag = ShapeFlags.FUNCTIONAL_COMPONENT</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> vnode = &#123;</span></span><br><span class="line"><span class="javascript">        _isVNode: <span class="literal">true</span>,</span></span><br><span class="line"><span class="javascript">        el: <span class="literal">null</span>,</span></span><br><span class="line">        shapeFlag,</span><br><span class="line">        tag,</span><br><span class="line">        props,</span><br><span class="line">        children</span><br><span class="line">      &#125;</span><br><span class="line">      normalizeChildren(vnode, vnode.children)</span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> vnode</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">normalizeChildren</span>(<span class="params">vnode, children</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> type = <span class="number">0</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">if</span> (children == <span class="literal">null</span>) &#123;</span></span><br><span class="line"><span class="javascript">        children = <span class="literal">null</span></span></span><br><span class="line"><span class="javascript">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(children)) &#123;</span></span><br><span class="line">        type = ShapeFlags.ARRAY_CHILDREN</span><br><span class="line"><span class="javascript">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> children === <span class="string">&#x27;object&#x27;</span>) &#123;</span></span><br><span class="line">        type = ShapeFlags.SLOTS_CHILDREN</span><br><span class="line"><span class="javascript">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> children === <span class="string">&#x27;string&#x27;</span>) &#123;</span></span><br><span class="line"><span class="javascript">        children = <span class="built_in">String</span>(children)</span></span><br><span class="line">        type = ShapeFlags.TEXT_CHILDREN</span><br><span class="line">      &#125;</span><br><span class="line">      vnode.shapeFlag |= type</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">mount</span>(<span class="params">vnode, container</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">if</span> (vnode.tag === <span class="literal">null</span>) &#123;</span></span><br><span class="line">        mountTextElement(vnode, container)</span><br><span class="line"><span class="javascript">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vnode.shapeFlag &amp; ShapeFlags.ELEMENT) &#123;</span></span><br><span class="line">        mountElement(vnode, container)</span><br><span class="line"><span class="javascript">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vnode.shapeFlag &amp; ShapeFlags.STATEFUL_COMPONENT) &#123;</span></span><br><span class="line">        mountStatefulComponent(vnode, container)</span><br><span class="line"><span class="javascript">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vnode.shapeFlag &amp; ShapeFlags.FUNCTIONAL_COMPONENT) &#123;</span></span><br><span class="line">        mountFunctionalComponent(vnode, container)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">mountTextElement</span>(<span class="params">vnode, container</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> el = <span class="built_in">document</span>.createTextNode(vnode.children)</span></span><br><span class="line">      vnode.el = el</span><br><span class="line">      container.appendChild(el)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">mountElement</span>(<span class="params">vnode, container</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> el = <span class="built_in">document</span>.createElement(vnode.tag)</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">      <span class="comment">// props</span></span></span><br><span class="line">      if (vnode.props) &#123;</span><br><span class="line"><span class="javascript">        <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> vnode.props) &#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">const</span> value = vnode.props[key]</span></span><br><span class="line">          el.setAttribute(key, value)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">      <span class="comment">// children</span></span></span><br><span class="line">      if (vnode.children) &#123;</span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (<span class="keyword">typeof</span> vnode.children === <span class="string">&#x27;string&#x27;</span>) &#123;</span></span><br><span class="line">          el.textContent = vnode.children</span><br><span class="line"><span class="javascript">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">          vnode.children.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span></span><br><span class="line">            mount(child, el)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      vnode.el = el</span><br><span class="line">      container.appendChild(el)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">mountStatefulComponent</span>(<span class="params">vnode, container</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> instance = vnode.tag</span></span><br><span class="line">      instance.$vnode = instance.render()</span><br><span class="line">      mount(instance.$vnode, container)</span><br><span class="line">      instance.$el = vnode.el = instance.$vnode.el</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">mountFunctionalComponent</span>(<span class="params">vnode, container</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> $vnode = vnode.tag()</span></span><br><span class="line">      mount($vnode, container)</span><br><span class="line">      vnode.el = $vnode.el</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> MyComponent = &#123;</span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> h(<span class="string">&#x27;div&#x27;</span>, <span class="literal">null</span>, <span class="string">&#x27;stateful component&#x27;</span>)</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">MyFunctionalComponent</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> h(<span class="string">&#x27;div&#x27;</span>, <span class="literal">null</span>, <span class="string">&#x27;function component&#x27;</span>)</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> vdom = h(<span class="string">&#x27;div&#x27;</span>, &#123;</span></span><br><span class="line">      class: &#x27;red&#x27;</span><br><span class="line">    &#125;, [</span><br><span class="line"><span class="javascript">      h(<span class="string">&#x27;p&#x27;</span>, <span class="literal">null</span>, <span class="string">&#x27;text children&#x27;</span>),</span></span><br><span class="line"><span class="javascript">      h(<span class="string">&#x27;p&#x27;</span>, <span class="literal">null</span>, <span class="literal">null</span>),</span></span><br><span class="line">      h(MyComponent),</span><br><span class="line">      h(MyFunctionalComponent)</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(vdom);</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">    mount(vdom, <span class="built_in">document</span>.querySelector(<span class="string">&quot;#app&quot;</span>))</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>浏览器渲染结果如下图</p>
<p><img src="image-20210617102649572.png" alt="image"></p>
<h3 id="实现-patch-函数">实现 patch 函数</h3>
<h4 id="patch-的作用">patch 的作用</h4>
<p>渲染器的第三个阶段就是 <code>Patch</code> 阶段，它所做的就是通过比较新旧 <code>VNode</code> 的区别，来局部更新页面的变化。</p>
<p>举个例子，假设我们想要修改家里的一些家具位置，或者增加减少一些家具，我们可以用两种方式完成：</p>
<ol>
<li>清空所有，然后按照新的设计开始布局</li>
<li>我们提前做好两份设计蓝图，比较其中的差别，然后仅仅更新这些有变化的地方</li>
</ol>
<p>很显然我们应该选择第二种方式来实现，这样工作量最少，效率最高。</p>
<p>这里的蓝图我们可以理解为 <code>VNode</code>，真实的房间理解为真实 DOM（即 <code>VNode.el</code>），比较差别的过程就是 <code>patch</code> 函数所做的。<code>patch</code> 直接更新 <code>VNode.el</code> 现有的相关属性，这样就避免了摧毁并重建带来的性能问题。</p>
<p>我们在 <code>render.ts</code> 中增加一个 <code>patch</code> 函数，它接收两个参数 <code>n1</code> 表示旧的 <code>VNode</code>，<code>n2</code> 表示新的 <code>VNode</code>：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patch</span>(<span class="params">n1, n2</span>)</span>&#123;</span><br><span class="line">  <span class="comment">// TODO</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>举个例子，页面首先渲染一个红色的 <code>hello</code> 文本，当进行某种操作更新时，会触发 <code>patch</code> 函数，它比较前后 <code>VNode</code> 发现 <code>class</code> 和 <code>children</code> 不同，因此修改这两部分内容为新的并重新渲染。代码如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; h &#125; <span class="keyword">from</span> <span class="string">&#x27;./h&#x27;</span> </span><br><span class="line"><span class="keyword">import</span> &#123; mount, patch &#125; <span class="keyword">from</span> <span class="string">&#x27;./render&#x27;</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vdom = h(<span class="string">&#x27;div&#x27;</span>, &#123; <span class="attr">class</span>: <span class="string">&#x27;red&#x27;</span> &#125;, <span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">mount(vdom)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vdom2 = h(<span class="string">&#x27;div&#x27;</span>, &#123; <span class="attr">class</span>: <span class="string">&#x27;green&#x27;</span> &#125;, <span class="string">&#x27;changed&#x27;</span>)</span><br><span class="line">patch(vdom, vdom2)</span><br></pre></td></tr></table></figure>
<p>思考一下，怎么实现这样的 <code>patch</code> 函数？你可以先尝试着自己实现它。</p>
<p>你可能需要注意的就是：</p>
<ul>
<li><code>tag</code> 的对比</li>
<li><code>props</code> 的对比</li>
<li><code>children</code> 的对比</li>
</ul>
<h4 id="patch-函数实现">patch 函数实现</h4>
<p>我们知道 <code>VNode</code> 有很多类别，可以用 <code>vnode.shapeFlag</code> 来判断，这里为了简化实现过程，我们先假设它们是同一类的 <code>VNode</code>，这里我们认为 <code>VNode</code> 都是 <code>ELEMENT</code> 类型。 如下，我们需要实现更新属性和子节点：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patch</span>(<span class="params">n1, n2</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(n1.tag === n2.tag)&#123;</span><br><span class="line">    <span class="comment">// update props</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// update children</span></span><br><span class="line">    </span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// replace</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="比较-props">比较 props</h5>
<p><code>props</code> 其实就是一个对象，而比较两个 <code>object</code> 不同时，我们需要考虑：</p>
<ul>
<li>增加了属性</li>
<li>减少了属性</li>
<li>修改了属性</li>
</ul>
<p>所以具体实现如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patch</span>(<span class="params">n1, n2</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(n1.tag === n2.tag)&#123;</span><br><span class="line">    <span class="keyword">const</span> el = n1.el <span class="comment">// (*)</span></span><br><span class="line">    <span class="comment">// update props</span></span><br><span class="line">    <span class="comment">// `n1` 和 `n2` 都存在有无 `props` 的情况</span></span><br><span class="line">    <span class="keyword">const</span> oldProps = n1.props || &#123;&#125;</span><br><span class="line">    <span class="keyword">const</span> newProps = n2.props || &#123;&#125;</span><br><span class="line">    <span class="comment">// add prop or update prop</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> newProps) &#123;</span><br><span class="line">      <span class="keyword">const</span> oldVal = oldProps[key]</span><br><span class="line">      <span class="keyword">const</span> newVal = newProps[key]</span><br><span class="line">      <span class="keyword">if</span>(newVal !== oldVal)&#123;</span><br><span class="line">        el.setAttribute(key, newVal)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// remove prop</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> oldProps) &#123;</span><br><span class="line">      <span class="keyword">if</span>(!newProps.hasOwnProperty(key))&#123;</span><br><span class="line">        el.removeAttribute(key)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update children</span></span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// replace</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们只更新了 <code>n1.el</code> 的属性，假如之后 <code>n2</code> 变成了所谓的 <code>oldVNode</code>，其属性是没有被修改的，所以我们需要修改一行代码：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 把新 VNode 的元素同时赋值给旧 VNode 元素</span></span><br><span class="line"><span class="keyword">const</span> el = n2.el = n1.el <span class="comment">// (*) </span></span><br></pre></td></tr></table></figure>
<h5 id="比较-children">比较 children</h5>
<p>同样的，<code>children</code> 也分为如下形式：</p>
<ul>
<li><code>null</code></li>
<li>纯文本</li>
<li>数组</li>
</ul>
<p>为了避免 <code>patch</code> 函数太长难以阅读，我们先把它按照如下方式修改：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patch</span>(<span class="params">n1, n2</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(n1.tag === n2.tag)&#123;</span><br><span class="line">    <span class="keyword">const</span> el = n2.el = n1.el <span class="comment">// (*)</span></span><br><span class="line">    patchProps(n1, n2, el)</span><br><span class="line">    patchChildren(n1, n2, el)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// replace</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchProps</span>(<span class="params">n1, n2, el</span>) </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchChildren</span>(<span class="params">n1, n2, el</span>)</span>&#123;</span><br><span class="line">  <span class="comment">// update children</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先如果新 <code>children</code> 是 <code>String</code> 的情况：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchChildren</span>(<span class="params">n1, n2, el</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// update children</span></span><br><span class="line">  <span class="keyword">const</span> oldChildren = n1.children</span><br><span class="line">  <span class="keyword">const</span> newChildren = n2.children</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 有人说这里为什么不处理 null 的情况？因为不想处理</span></span><br><span class="line">  <span class="keyword">if</span> (isString(newChildren)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isString(oldChildren)) &#123;</span><br><span class="line">      oldChildren !== newChildren &amp;&amp; (el.textContent = newChildren)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      el.textContent = newChildren</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(isArray(newChildren)) &#123;</span><br><span class="line">    <span class="comment">// TODO </span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来处理新 <code>children</code> 是 <code>Array</code> 的情况，同样的，我们需要判断旧 <code>children</code> 的类型：</p>
<ul>
<li><code>null</code>，直接渲染新子节点</li>
<li>纯文本，清除节点内容，并重新渲染子节点</li>
<li>数组，核心 <code>diff</code> 算法</li>
</ul>
<p>现在我们剩下新旧 <code>children</code> 均为数组要处理的情况，这里我们可以有如下方式来实现：</p>
<ol>
<li>将旧的子节点全部移除，再将所有新的子节点添加</li>
<li>核心 <code>diff</code> 算法，同层级比较</li>
</ol>
<p>这里为了更容易理解 <code>patch</code> 过程，我们直接选择第一种方式实现：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (isArray(oldChildren)) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; oldChildren.length; i++) &#123;</span><br><span class="line">    el.removeChild(oldChildren[i].el)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; newChildren.length; i++) &#123;</span><br><span class="line">    mount(newChildren[i], el)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="完整实现-2">完整实现</h4>
<p>现在我们实现的简易版本 <code>patch</code> 函数完整代码如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>n1 old VNode</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>n2 new VNode</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patch</span>(<span class="params">n1, n2</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (n1.tag === n2.tag) &#123;</span><br><span class="line">    <span class="keyword">const</span> el = n2.el = n1.el <span class="comment">// (*)</span></span><br><span class="line">    patchProps(n1, n2, el)</span><br><span class="line">    patchChildren(n1, n2, el)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// replace</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchProps</span>(<span class="params">n1, n2, el</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// update props</span></span><br><span class="line">  <span class="comment">// `n1` 和 `n2` 都存在有无 `props` 的情况</span></span><br><span class="line">  <span class="keyword">const</span> oldProps = n1.props || &#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> newProps = n2.props || &#123;&#125;</span><br><span class="line">  <span class="comment">// add prop or update prop</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> newProps) &#123;</span><br><span class="line">    <span class="keyword">const</span> oldVal = oldProps[key]</span><br><span class="line">    <span class="keyword">const</span> newVal = newProps[key]</span><br><span class="line">    <span class="keyword">if</span> (newVal !== oldVal) &#123;</span><br><span class="line">      el.setAttribute(key, newVal)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// remove prop</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> oldProps) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!newProps.hasOwnProperty(key)) &#123;</span><br><span class="line">      el.removeAttribute(key)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchChildren</span>(<span class="params">n1, n2, el</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// update children</span></span><br><span class="line">  <span class="keyword">const</span> oldChildren = n1.children</span><br><span class="line">  <span class="keyword">const</span> newChildren = n2.children</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isString(newChildren)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isString(oldChildren)) &#123;</span><br><span class="line">      oldChildren !== newChildren &amp;&amp; (el.textContent = newChildren)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      el.textContent = newChildren</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isArray(newChildren)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isString(oldChildren)) &#123;</span><br><span class="line">      el.innerHTML = <span class="string">&#x27;&#x27;</span></span><br><span class="line">      newChildren.forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">        mount(child, el)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isArray(oldChildren)) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; oldChildren.length; i++) &#123;</span><br><span class="line">        el.removeChild(oldChildren[i].el)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; newChildren.length; i++) &#123;</span><br><span class="line">        mount(newChildren[i], el)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际上我们还需要考虑：</p>
<ul>
<li><code>patch</code> 中处理不同 <code>shapeFlag</code></li>
<li><code>patchChildren</code> 中新旧 <code>children</code> 均为数组时的优化，保证 DOM 节点尽可能多的被重复使用，也即是 <code>diff</code> 算法。</li>
</ul>
<h4 id="完整示例-2">完整示例</h4>
<p>新建 <a target="_blank" rel="noopener" href="https://github.com/natee/build-your-own-vue-next/blob/master/demo/patch.html">patch.html</a>，添加如下代码，并在浏览器中打开：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; h &#125; <span class="keyword">from</span> <span class="string">&#x27;./h&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; mount, patch &#125; <span class="keyword">from</span> <span class="string">&#x27;./render&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vdom = h(<span class="string">&#x27;div&#x27;</span>, &#123; <span class="attr">class</span>: <span class="string">&#x27;red&#x27;</span> &#125;, [h(<span class="string">&#x27;p&#x27;</span>, <span class="literal">null</span>, <span class="string">&#x27;text children&#x27;</span>)])</span><br><span class="line">mount(vdom, <span class="built_in">document</span>.querySelector(<span class="string">&quot;#app&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> vdom2 = h(<span class="string">&#x27;div&#x27;</span>, &#123; <span class="attr">class</span>: <span class="string">&#x27;green&#x27;</span> &#125;, [h(<span class="string">&#x27;p&#x27;</span>, <span class="literal">null</span>, <span class="string">&#x27;changed text children&#x27;</span>)])</span><br><span class="line">  patch(vdom, vdom2);</span><br><span class="line">&#125;, <span class="number">2000</span>)</span><br></pre></td></tr></table></figure>
<p>我们可以看到效果是：页面显示红色文字 <code>text children</code>，2s 后显示绿色文字 <code>changed text children</code>。</p>
<p>至此我们已经了解了 Vue 中渲染器的 <code>patch</code> 过程，并实现了一个最简单版本的 <code>patch</code> 函数。</p>
<h3 id="patch-函数优化">patch 函数优化</h3>
<h4 id="准备工作">准备工作</h4>
<p>为了便于后续代码书写，我们先把处理数组 <code>children</code> 的功能挪至 <code>diffArrayChildren</code> 函数中，如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">diffArrayChildren</span>(<span class="params">oldChildren, newChildren, el</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; oldChildren.length; i++) &#123;</span><br><span class="line">    el.removeChild(oldChildren[i].el)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; newChildren.length; i++) &#123;</span><br><span class="line">    mount(newChildren[i], el)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>准备一个小小的示例。</p>
<h5 id="示例A">示例A</h5>
<p>我们假设有这样一段 <code>html</code>：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>1<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>2<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>3<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>对应的<code>VNode</code>如下，</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vdom1 = h(<span class="string">&#x27;ul&#x27;</span>, <span class="literal">null</span>, [</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, <span class="literal">null</span>, <span class="number">1</span>),</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, <span class="literal">null</span>, <span class="number">2</span>),</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, <span class="literal">null</span>, <span class="number">3</span>)</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<p>当数据变化时，其顺序改变成了</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vdom2 = h(<span class="string">&#x27;ul&#x27;</span>, <span class="literal">null</span>, [</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, <span class="literal">null</span>, <span class="number">3</span>),</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, <span class="literal">null</span>, <span class="number">2</span>),</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, <span class="literal">null</span>, <span class="number">1</span>)</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<h4 id="简单的-diff-算法">简单的 diff 算法</h4>
<p>当前 <code>diffArrayChildren</code> 函数直接把这三个 <code>li</code> 进行了替换，并没有做什么复用，这是性能最差的一种方式。</p>
<p>我们有什么办法可以让这些 <code>li</code> 复用呢？<code>patch</code> 函数就是让 DOM 复用的，所以我们可以直接调用 <code>patch</code> 来比较新旧 <code>children</code> 的每一项，</p>
<p>用 <code>patch</code> 函数对其进行优化，优化后如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">diffArrayChildren</span>(<span class="params">oldChildren, newChildren</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; newChildren.length; i++) &#123;</span><br><span class="line">    patch(oldChildren[i], newChildren[i])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当前示例中由于新旧 <code>children</code> 长度相同，所以该方法完全行得通，但这里还有另外两种情况需要考虑：</p>
<ul>
<li><code>newChildren.length &gt; oldChldren.length</code></li>
<li><code>oldChldren.length &gt; newChildren.length</code></li>
</ul>
<p>这也很好实现，只对比共有长度的自己点，多出来的子节点调用 <code>mount</code> 挂载，减少的子节点就从其父元素上删除。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">diffArrayChildren</span>(<span class="params">oldChildren, newChildren, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> commonLen = <span class="built_in">Math</span>.min(newChildren.length, oldChildren.length)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; commonLen; i++) &#123;</span><br><span class="line">    patch(oldChildren[i], newChildren[i])</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (newChildren.length &gt; oldChildren.length) &#123;</span><br><span class="line">    newChildren.slice(oldChildren.length).forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">      mount(child, container)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newChildren.length &lt; oldChildren.length) &#123;</span><br><span class="line">    oldChildren.slice(newChildren.length).forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">      container.removeChild(child.el)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在的 <code>diffArrayChildren</code> 就算是<strong>一个简单的 <code>diff</code> 算法</strong>了，实际上，这个算法就是在没有 <code>key</code> 时所采用的算法，我们将其重新命名为 <code>patchUnkeyedChildren</code>：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>c1 old old children</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>c2 new new children</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchUnkeyedChildren</span>(<span class="params">c1, c2, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> commonLen = <span class="built_in">Math</span>.min(c2.length, c1.length)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; commonLen; i++) &#123;</span><br><span class="line">    patch(c1[i], c2[i])</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (c2.length &gt; c1.length) &#123;</span><br><span class="line">    c2.slice(c1.length).forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">      mount(child, container)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c2.length &lt; c1.length) &#123;</span><br><span class="line">    c1.slice(c2.length).forEach(<span class="function"><span class="params">child</span> =&gt;</span> &#123;</span><br><span class="line">      container.removeChild(child.el)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="优化版本的-dff-算法">优化版本的 dff 算法</h4>
<p>实际上，上面的示例中，很容易发现这三个<code>li</code>标签本质上只是顺序发生了变化，即使是最简单的替换<code>textContent</code>我们可以省略，所以最佳的操作应该是<strong>通过移动元素的位置来达到更新</strong>的目的。</p>
<p>下图所呈现的就是当前新旧 <code>children</code> 直接的关系，我们怎么判断其先后顺序呢？判断不了，因为其缺乏映射关系。</p>
<p><img src="chapter3-diff-nokey.png" alt="image"></p>
<p>答案就是增加一个唯一标识来判断，这就是 Vue 中的<code>key</code>属性。</p>
<p><code>h</code> 函数创建 <code>VNode</code> 是这样的：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vdom = h(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;a&#x27;</span> &#125;, <span class="number">1</span>)</span><br><span class="line"><span class="comment">// vdom =</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//   _isVNode: true</span></span><br><span class="line"><span class="comment">//   el: null</span></span><br><span class="line"><span class="comment">//   shapeFlag: 1</span></span><br><span class="line"><span class="comment">//   tag: &quot;li&quot;</span></span><br><span class="line"><span class="comment">//   props: &#123;key: &#x27;a&#x27;&#125;</span></span><br><span class="line"><span class="comment">//   children: 1</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure>
<p><code>props</code> 中增加了 <code>key</code> 属性，但是为了方便读取，我们直接把 <code>key</code> 放到 <code>VNode</code> 本身上，修改 <code>h</code> 函数如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">h</span>(<span class="params">tag, props = <span class="literal">null</span>, children = <span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">const</span> vnode = &#123;</span><br><span class="line">    _isVNode: <span class="literal">true</span>,</span><br><span class="line">    el: <span class="literal">null</span>,</span><br><span class="line">    shapeFlag,</span><br><span class="line">    tag,</span><br><span class="line">    props,</span><br><span class="line">    key: props &amp;&amp; props.key !== <span class="literal">undefined</span> ? props.key : <span class="literal">null</span>,</span><br><span class="line">    children</span><br><span class="line">  &#125;</span><br><span class="line">  normalizeChildren(vnode, vnode.children)</span><br><span class="line">  <span class="keyword">return</span> vnode</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>增加 <code>key</code> 后其先后 <code>children</code> 变成了如下，这里的示例代码计作“示例B”：</p>
<h5 id="示例B">示例B</h5>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vdom1 = h(<span class="string">&#x27;ul&#x27;</span>, [</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;a&#x27;</span> &#125;, <span class="number">1</span>),</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;b&#x27;</span> &#125;, <span class="number">2</span>),</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;c&#x27;</span> &#125;, <span class="number">3</span>)</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vdom2 = h(<span class="string">&#x27;ul&#x27;</span>, <span class="literal">null</span>, [</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;c&#x27;</span> &#125;, <span class="number">3</span>),</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;b&#x27;</span> &#125;, <span class="number">2</span>),</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;a&#x27;</span> &#125;, <span class="number">1</span>)</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意这里 <code>key</code> 尽量不用 <code>index</code>，否则仍然无法获得其映射关系。</p>
</blockquote>
<p>有了 <code>key</code> 我们就能够明确的知道新旧 <code>children</code> 中节点的映射关系，如下图所示：</p>
<p><img src="image-20210618143241913.png" alt="image"></p>
<p>有了这层映射关系，我们就很容易找到同一个 <code>key</code> 对应的先后节点能否复用。</p>
<p>首先 <code>patchChildren</code> 中增加有无 <code>key</code> 的判断，如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchChildren</span>(<span class="params">n1, n2, el</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span> (isString(oldChildren)) &#123;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isArray(oldChildren)) &#123;</span><br><span class="line">    <span class="keyword">const</span> hasKey = newChildren[<span class="number">0</span>].key !== <span class="literal">null</span></span><br><span class="line">    <span class="keyword">if</span> (hasKey) &#123;</span><br><span class="line">      patchUnkeyedChildren(oldChildren, newChildren, el)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      patchKeyedChildren(oldChildren, newChildren, el)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>实际上 Vue 中判断有无 <code>key</code> 是给 <code>VNode</code> 增加一个 <code>patchFlag</code> 参数，在编译 <code>v-for</code> 时判断赋值。</p>
</blockquote>
<p>我们通过 <code>key</code> 来找到前后对应的 <code>VNode</code>，代码如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchKeyedChildren</span>(<span class="params">c1, c2, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; c2.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> newChild = c2[i];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; c1.length; j++) &#123;</span><br><span class="line">      <span class="keyword">const</span> oldChild = c1[j];</span><br><span class="line">      <span class="keyword">if</span>(newChild.key === oldChild.key)&#123;</span><br><span class="line">        patch(oldChild, newChild)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们在浏览器中打开“示例B”所示的代码，可以看到页面先显示了 <code>1,2,3</code>，1s 后变仍然显示 <code>1,2,3</code>，什么情况？其实现在节点的内容已经更新了，只是前后内容都是一样的，所以看不出效果，我们现在缺少的一步就是把更新后的节点放到正确的位置。</p>
<p>我们可以通过新旧节点的索引判断节点更新顺序，如 <code>abc -&gt; cba</code>，其索引 <code>012 -&gt; 210</code>，我们以新 <code>children</code> 的最后一个为基准，那么我们要做的额额就是把旧 <code>children[1].el</code> 插入到索引为 <code>children[0].el</code> 之前，把旧 <code>children[2].el</code> 插入到索引为 <code>children[1].el</code> 之前，依次类推。</p>
<p>实现代码如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchKeyedChildren</span>(<span class="params">c1, c2, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> indexArr = []</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; c2.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> newChild = c2[i];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; c1.length; j++) &#123;</span><br><span class="line">      <span class="keyword">const</span> oldChild = c1[j];</span><br><span class="line">      <span class="keyword">if</span> (newChild.key === oldChild.key) &#123;</span><br><span class="line">        patch(oldChild, newChild)</span><br><span class="line">        indexArr.push(j)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sortChildrenElements(c1, c2, container, indexArr)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// n1.children = [el-a, el-b, el-c] =&gt; [el-c, el-b, el-a]</span></span><br><span class="line"><span class="comment">// indexArr 为新 children 索引列表[2,1,0]</span></span><br><span class="line"><span class="comment">// 这表示要把旧 children 中索引为1的元素插入到索引为0之前</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sortChildrenElements</span>(<span class="params">c1, c2, container, indexArr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> index = indexArr.length - <span class="number">1</span></span><br><span class="line">  <span class="keyword">while</span> (index &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 把新children</span></span><br><span class="line">    <span class="keyword">const</span> lastChildNode = c1[indexArr[index]].el</span><br><span class="line">    <span class="keyword">const</span> prevChildNode = c1[indexArr[index - <span class="number">1</span>]].el</span><br><span class="line">    container.insertBefore(prevChildNode, lastChildNode)</span><br><span class="line">    index--</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先在 <code>patchKeyedChildren</code> 函数中能够轻松获得新 <code>children</code> 的顺序，然后对 DOM 进行排序。现在在浏览器中查看效果，显示 <code>123</code>，1s 后变成了 <code>321</code>，符合预期。</p>
<p>和 <code>patchUnkeyedChildren</code> 一样，这里我们也需要考虑新旧 <code>children</code> 长度不一致的问题，也就是新增或删除了节点。</p>
<h5 id="新增节点">新增节点</h5>
<p><strong>新增节点</strong>，具体实现如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchKeyedChildren</span>(<span class="params">c1, c2, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> indexArr = []</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; c2.length; i++) &#123;</span><br><span class="line">    <span class="keyword">let</span> find = <span class="literal">false</span> <span class="comment">// (*)</span></span><br><span class="line">    <span class="keyword">const</span> newChild = c2[i];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; c1.length; j++) &#123;</span><br><span class="line">      <span class="keyword">const</span> oldChild = c1[j];</span><br><span class="line">      <span class="keyword">if</span> (newChild.key === oldChild.key) &#123;</span><br><span class="line">        patch(oldChild, newChild)</span><br><span class="line">        find = <span class="literal">true</span> <span class="comment">// (*)</span></span><br><span class="line">        indexArr.push(j)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!find)&#123; <span class="comment">// (*)</span></span><br><span class="line">      mount(newChild, container)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sortChildrenElements(c1, c2, container, indexArr)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们增加示例代码计作“示例C”，测试一下：</p>
<h5 id="示例C">示例C</h5>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vdom1 = h(<span class="string">&#x27;ul&#x27;</span>, <span class="literal">null</span>, [</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;a&#x27;</span>, <span class="attr">class</span>: <span class="string">&#x27;red&#x27;</span> &#125;, <span class="number">1</span>),</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;b&#x27;</span> &#125;, <span class="number">2</span>),</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;c&#x27;</span> &#125;, <span class="number">3</span>)</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vdom2 = h(<span class="string">&#x27;ul&#x27;</span>, <span class="literal">null</span>, [</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;c&#x27;</span> &#125;, <span class="number">3</span>),</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;d&#x27;</span> &#125;, <span class="number">4</span>),</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;b&#x27;</span> &#125;, <span class="number">2</span>),</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;a&#x27;</span>, <span class="attr">class</span>: <span class="string">&#x27;green&#x27;</span> &#125;, <span class="number">1</span>),</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<p>可以看到页面先显示了 <code>1,2,3</code>，1s 后变仍然显示 <code>3,2,1,4</code>，新增的节点渲染出来了，但其位置并不符合预期，因为 <code>mount</code> 函数始终是往 <code>container</code> 的末尾添加元素。对于这种情况，我们可以用 <code>insertBefore</code> 的方式代替 <code>appendChild</code> 方法来达成目的，那么我们现在就需要知道把新增的节点插入到哪个节点之前。</p>
<p>思路：通过 <code>sortChildrenElements</code> 函数处理后现有复用节点都能够正常显示，比如“示例C”这样的，现在 <code>patchKeyedChildren</code> 得到的 <code>indexArr</code> 就应该是 <code>[2, 1, 0]</code>，但实际上我们需要的是 <code>[2, new1, 1, 0]</code> 这样的。现在我们只需要想办法找到 <code>new1</code> 处插入 <code>4</code> 即可，我们可以在发现新增节点时将其在新 <code>children</code> 中对应的位置存下来，最后挂载到相应位置。</p>
<p>我们的逻辑类似这样：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchKeyedChildren</span>(<span class="params">c1, c2, container</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> indexArr = []</span><br><span class="line">  <span class="keyword">let</span> addElements = []</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; c2.length; i++) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span>(!find)&#123;</span><br><span class="line">      addElements.push(i)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sortChildrenElements(c1, c2, container, indexArr)</span><br><span class="line">  insertNewElements(c1, c2, container, addElements)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sortChildrenElements</span>(<span class="params">c1, c2, container, indexArr</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insertNewElements</span>(<span class="params">c1, c2, container, addElements</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; addElements.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> addElementIndex = addElements[i];</span><br><span class="line">    <span class="comment">// 先把新增节点渲染出来</span></span><br><span class="line">    mount(c2[addElementIndex], container)</span><br><span class="line">    <span class="comment">// 然后调整新增节点位置</span></span><br><span class="line">    container.insertBefore(c2[addElementIndex].el, container.children[addElementIndex - <span class="number">1</span>].nextSibling)  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在浏览器中查看“示例C”的表现，新增的节点已经正常显示了。但是注意 <code>addElementIndex - 1</code>，如果新 <code>children</code> 第一项即为新增节点，这里显然会出错的，所以我们把这里修改成如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insertNewElements</span>(<span class="params">c1, c2, container, addElements</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; addElements.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> addElementIndex = addElements[i];</span><br><span class="line">    mount(c2[addElementIndex], container)</span><br><span class="line">    <span class="keyword">if</span> (addElementIndex === <span class="number">0</span>) &#123;</span><br><span class="line">      container.insertBefore(c2[addElementIndex].el, container.children[<span class="number">0</span>])</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      container.insertBefore(c2[addElementIndex].el, container.children[addElementIndex - <span class="number">1</span>].nextSibling)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此，一切都好了起来。</p>
<h5 id="删除节点">删除节点</h5>
<p>接下来我们看一下<strong>删除节点</strong>的情况，具体实现如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patchKeyedChildren</span>(<span class="params">c1, c2, container</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 删除节点</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; c1.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> exist = c2.find(<span class="function"><span class="params">child</span> =&gt;</span> child.key === c1[i].key)</span><br><span class="line">    <span class="keyword">if</span>(!exist)&#123;</span><br><span class="line">      container.removeChild(c1[i].el)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sortChildrenElements(c1, c2, container, indexArr)</span><br><span class="line">  insertNewElements(c1, c2, container, addElements)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在修改“示例C”代码如下：</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vdom1 = h(<span class="string">&#x27;ul&#x27;</span>, <span class="keyword">null</span>, [</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="built_in">key</span>: <span class="string">&#x27;a&#x27;</span>, class: <span class="string">&#x27;red&#x27;</span> &#125;, <span class="number">1</span>),</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="built_in">key</span>: <span class="string">&#x27;b&#x27;</span> &#125;, <span class="number">2</span>),</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="built_in">key</span>: <span class="string">&#x27;c&#x27;</span> &#125;, <span class="number">3</span>)</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vdom2 = h(<span class="string">&#x27;ul&#x27;</span>, <span class="keyword">null</span>, [</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="built_in">key</span>: <span class="string">&#x27;e&#x27;</span> &#125;, <span class="number">5</span>),</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="built_in">key</span>: <span class="string">&#x27;c&#x27;</span> &#125;, <span class="number">3</span>),</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="built_in">key</span>: <span class="string">&#x27;d&#x27;</span> &#125;, <span class="number">4</span>),</span><br><span class="line">  h(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="built_in">key</span>: <span class="string">&#x27;a&#x27;</span>, class: <span class="string">&#x27;green&#x27;</span> &#125;, <span class="number">1</span>),</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<p>浏览器结果表现正常。</p>
<p>至此我们了解了 <code>patch</code> 函数在更新 DOM 时都做了什么样的操作，也就是所谓的 <code>diff</code> 算法，我们已经基本实现了一个渲染器。</p>
<h4 id="关于核心-diff-算法">关于核心 diff 算法</h4>
<p>以上内容简单地对上一节提出的 <code>patch</code> 函数进行了优化，实际上这并不是 Vue 3 所采用的 <code>diff</code> 算法。但无论怎样，<code>diff</code> 算法的目的就是减少比较次数，增加 DOM 复用。</p>
<h5 id="Vue-2-diff-算法">Vue 2 diff 算法</h5>
<p>Vue 2 核心 diff 算法采用的是双端比较。</p>
<h5 id="Vue-3-diff-算法">Vue 3 diff 算法</h5>
<p>Vue 3 在 Vue 2 的基础上进行了大幅度的优化，在创建 <code>VNode</code> 时增加了 <code>patchFlag</code> 属性，这是<strong>编译器生成</strong>的优化性提示，当一个 <code>VNode</code> 带有动态子节点时，进入 <code>diff</code> 算法时会自动进入“优化模式”，它只会处理这些具有 <code>patchFlag</code> 标识的更新。而在 Vue 2 中是直接对整个 <code>VNode</code> 全面 <code>diff</code>。</p>
<p>在 Vue3 中将采用另外一种核心 Diff 算法，它借鉴于 <a target="_blank" rel="noopener" href="https://github.com/localvoid/ivi">ivi</a> 和 <a target="_blank" rel="noopener" href="https://github.com/infernojs/inferno">inferno</a></p>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/en/vue3-vue2与vue3常用方法对比/" data-toggle="tooltip" data-placement="top" title="[vue3] vue2与vue3常用方法对比">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/en/vue3-渲染器的核心diff算法/" data-toggle="tooltip" data-placement="top" title="[vue3] 渲染器的核心diff算法">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. If the images used in the blog infringe your copyright, please contact the author to delete them. Thank you !
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->

  <!-- gitalk start -->
  <!-- Docs:https://github.com/gitalk/gitalk/blob/master/readme-cn.md -->

  <div id="gitalk-container"></div>

  
    <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.js"></script> -->
    <script src="/js/comment/gitalk.js"></script>
  

  <script>
    var gitalk = new Gitalk({
      clientID: 'be77013e3cb3cb9e89f1',
      clientSecret: '39e9b02a8070f1366c5e87418220c8f375864ab8',
      repo: 'jasonluox',
      owner: 'JasonLuox',
      admin: 'JasonLuox',
      id: 'Sat Jun 05 2021 12:34:17 GMT+0800', // Ensure uniqueness and length less than 50
      distractionFreeMode: false, // Facebook-like distraction free mode
      perPage: 10,
      pagerDirection: 'last',
      createIssueManually: false,
      language: 'en',
      proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token'
    });
    gitalk.render('gitalk-container');

    var gtFolded = () => {
      setTimeout(function () {
        let markdownBody = document.getElementsByClassName("markdown-body");
        let list = Array.from(markdownBody);
        list.forEach(item => {
          if (item.clientHeight > 250) {
            item.classList.add('gt-comment-body-folded');
            item.style.maxHeight = '250px';
            item.title = 'Click to Expand';
            item.onclick = function () {
              item.classList.remove('gt-comment-body-folded');
              item.style.maxHeight = '';
              item.title = '';
              item.onclick = null;
            };
          }
        })
      }, 800);
    }
  </script>

  <!-- gitalk end -->


<!-- 2. gitment comment -->


<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%BC%96%E8%AF%91%E5%99%A8%E5%92%8C%E6%B8%B2%E6%9F%93%E5%99%A8-API-%E5%88%9D%E6%8E%A2"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">编译器和渲染器 API 初探</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Complier%E5%92%8C-Renderer"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">Complier和 Renderer</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E7%BC%96%E8%AF%91%E5%99%A8%EF%BC%88Compiler%EF%BC%89%E7%9C%9F%E5%AE%9E%E5%9C%BA%E6%99%AF"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">编译器（Compiler）真实场景</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%AE%BE%E8%AE%A1-VNode"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">设计 VNode</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E7%94%A8-VNode-%E6%8F%8F%E8%BF%B0-HTML"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">用 VNode 描述 HTML</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E7%94%A8-VNode-%E6%8F%8F%E8%BF%B0%E6%8A%BD%E8%B1%A1%E5%86%85%E5%AE%B9"><span class="toc-nav-number">2.2.</span> <span class="toc-nav-text">用 VNode 描述抽象内容</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%8C%BA%E5%88%86-VNode%E7%B1%BB%E5%9E%8B"><span class="toc-nav-number">2.3.</span> <span class="toc-nav-text">区分 VNode类型</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%8C%BA%E5%88%86-children-%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="toc-nav-number">2.4.</span> <span class="toc-nav-text">区分 children 的类型</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%AE%9A%E4%B9%89-VNode"><span class="toc-nav-number">2.5.</span> <span class="toc-nav-text">定义 VNode</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E9%A2%98%E5%A4%96%E8%AF%9D"><span class="toc-nav-number">2.6.</span> <span class="toc-nav-text">题外话</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%94%9F%E6%88%90-VNode-%E7%9A%84-h-%E5%87%BD%E6%95%B0"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">生成 VNode 的 h 函数</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%9A%84-h-%E5%87%BD%E6%95%B0"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">基本的 h 函数</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%AE%8C%E6%95%B4%E7%9A%84-h-%E5%87%BD%E6%95%B0"><span class="toc-nav-number">3.2.</span> <span class="toc-nav-text">完整的 h 函数</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%B8%B2%E6%9F%93-VNode-%E7%9A%84-mount-%E5%87%BD%E6%95%B0"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">渲染 VNode 的 mount 函数</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#mount-%E5%87%BD%E6%95%B0%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="toc-nav-number">4.1.</span> <span class="toc-nav-text">mount 函数基本原理</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%A7%A3%E5%86%B3-VNode-%E7%9A%84%E7%B1%BB%E5%9E%8B%E9%97%AE%E9%A2%98"><span class="toc-nav-number">4.2.</span> <span class="toc-nav-text">解决 VNode 的类型问题</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E6%B8%B2%E6%9F%93%E6%96%87%E6%9C%AC%E8%8A%82%E7%82%B9"><span class="toc-nav-number">4.2.1.</span> <span class="toc-nav-text">渲染文本节点</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E6%B8%B2%E6%9F%93%E6%A0%87%E7%AD%BE%E8%8A%82%E7%82%B9"><span class="toc-nav-number">4.2.2.</span> <span class="toc-nav-text">渲染标签节点</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E6%B8%B2%E6%9F%93%E6%99%AE%E9%80%9A%E6%9C%89%E7%8A%B6%E6%80%81%E7%BB%84%E4%BB%B6"><span class="toc-nav-number">4.2.3.</span> <span class="toc-nav-text">渲染普通有状态组件</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BB%84%E4%BB%B6"><span class="toc-nav-number">4.2.4.</span> <span class="toc-nav-text">渲染函数式组件</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%AE%BE%E7%BD%AE-DOM-%E5%B1%9E%E6%80%A7"><span class="toc-nav-number">4.3.</span> <span class="toc-nav-text">设置 DOM 属性</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%B8%B2%E6%9F%93%E5%AD%90%E8%8A%82%E7%82%B9"><span class="toc-nav-number">4.4.</span> <span class="toc-nav-text">渲染子节点</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%85%B3%E8%81%94-VNode-%E5%8F%8A%E5%85%B6-DOM"><span class="toc-nav-number">4.5.</span> <span class="toc-nav-text">关联 VNode 及其 DOM</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%AE%8C%E6%95%B4%E5%AE%9E%E7%8E%B0"><span class="toc-nav-number">4.6.</span> <span class="toc-nav-text">完整实现</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%AE%8C%E6%95%B4%E7%A4%BA%E4%BE%8B"><span class="toc-nav-number">4.7.</span> <span class="toc-nav-text">完整示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%AE%9E%E7%8E%B0-patch-%E5%87%BD%E6%95%B0"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">实现 patch 函数</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#patch-%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-nav-number">5.1.</span> <span class="toc-nav-text">patch 的作用</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#patch-%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0"><span class="toc-nav-number">5.2.</span> <span class="toc-nav-text">patch 函数实现</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E6%AF%94%E8%BE%83-props"><span class="toc-nav-number">5.2.1.</span> <span class="toc-nav-text">比较 props</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E6%AF%94%E8%BE%83-children"><span class="toc-nav-number">5.2.2.</span> <span class="toc-nav-text">比较 children</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%AE%8C%E6%95%B4%E5%AE%9E%E7%8E%B0-2"><span class="toc-nav-number">5.3.</span> <span class="toc-nav-text">完整实现</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%AE%8C%E6%95%B4%E7%A4%BA%E4%BE%8B-2"><span class="toc-nav-number">5.4.</span> <span class="toc-nav-text">完整示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#patch-%E5%87%BD%E6%95%B0%E4%BC%98%E5%8C%96"><span class="toc-nav-number">6.</span> <span class="toc-nav-text">patch 函数优化</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-nav-number">6.1.</span> <span class="toc-nav-text">准备工作</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E7%A4%BA%E4%BE%8BA"><span class="toc-nav-number">6.1.1.</span> <span class="toc-nav-text">示例A</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E7%AE%80%E5%8D%95%E7%9A%84-diff-%E7%AE%97%E6%B3%95"><span class="toc-nav-number">6.2.</span> <span class="toc-nav-text">简单的 diff 算法</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E4%BC%98%E5%8C%96%E7%89%88%E6%9C%AC%E7%9A%84-dff-%E7%AE%97%E6%B3%95"><span class="toc-nav-number">6.3.</span> <span class="toc-nav-text">优化版本的 dff 算法</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E7%A4%BA%E4%BE%8BB"><span class="toc-nav-number">6.3.1.</span> <span class="toc-nav-text">示例B</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E6%96%B0%E5%A2%9E%E8%8A%82%E7%82%B9"><span class="toc-nav-number">6.3.2.</span> <span class="toc-nav-text">新增节点</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E7%A4%BA%E4%BE%8BC"><span class="toc-nav-number">6.3.3.</span> <span class="toc-nav-text">示例C</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E5%88%A0%E9%99%A4%E8%8A%82%E7%82%B9"><span class="toc-nav-number">6.3.4.</span> <span class="toc-nav-text">删除节点</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%85%B3%E4%BA%8E%E6%A0%B8%E5%BF%83-diff-%E7%AE%97%E6%B3%95"><span class="toc-nav-number">6.4.</span> <span class="toc-nav-text">关于核心 diff 算法</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#Vue-2-diff-%E7%AE%97%E6%B3%95"><span class="toc-nav-number">6.4.1.</span> <span class="toc-nav-text">Vue 2 diff 算法</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#Vue-3-diff-%E7%AE%97%E6%B3%95"><span class="toc-nav-number">6.4.2.</span> <span class="toc-nav-text">Vue 3 diff 算法</span></a></li></ol></li></ol></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">FEATURED TAGS</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#vue3源码" title="vue3源码">vue3源码</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          

          

          

          

          

          

          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          Jason Luo
          2021
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="/js/hux-blog.min.js"></script>
  <!-- catalog -->
  <script async="true" type="text/javascript" src="/js/catalog.js"></script>
  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="/js/scroll.js"></script>
    <!-- Scroll end -->
  

  
    <!-- LangSelect start -->
    <script type="text/javascript" src="/js/langselect.js"></script>
    <!-- LangSelect end -->
  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="/js/mouseclick.js" content='我要变强，为此不惜一切...,一念往，尽作尘泥罢...,玻璃晴朗，橘子辉煌...,我心即地狱，管他罪孽滔天...,我要这天，再遮不住我眼...,我要这地，再埋不了我心...,斯若晴空，何惧冰寒...,这灯红酒绿的世界啊...,不要放弃，哪怕付出所有...' color='#CDF0EA,#F9F9F9,#F7DBF0,#BEAEE2,#F38181,#FCE38A,#EAFFD0,#95E1D3,#80D6FF'></script>
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="/js/ribbonDynamic.js"></script>
  

  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("https://jasonluox.github.io/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="SEARCH..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"mobile":{"show":"fasle"},"display":{"hOffset":-40,"vOffset":-80},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
