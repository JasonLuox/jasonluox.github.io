<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-xxxxxx-xx"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-xxxxxx-xx');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="It&#39;s an IT blog..."/>
  <meta name="keyword" content="HTML,JavaScript,CSS,TypeScript,VUE,WEBPACK,VITE"/>
  <link rel="shortcut icon" href="/img/avatar/logo.jpg"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css"/>
    <link rel="stylesheet" href="/css/widget.css"/>
    <link rel="stylesheet" href="/css/rocket.css"/>
    <link rel="stylesheet" href="/css/signature.css"/>
    <link rel="stylesheet" href="/css/catalog.css"/>
    <link rel="stylesheet" href="/css/livemylife.css"/>

    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
      <!-- gitalk start -->
      <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->
      <link rel="stylesheet" href="/css/gitalk.css"/>
      <!-- gitalk end -->
    
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="https://jasonluox.github.io/en/vue3-深入响应式原理/">
  <title>
    
      [vue3] 深入响应式原理 - 流年风尘 | 我的前端之路
    
  </title>
<meta name="generator" content="Hexo 5.4.0"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--dark">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'dark';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Jason Luo&#39;s Golden House</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">HOME</a>
          </li>

          
          
          
          
          <li>
            <a href="/archive/">
              
              ARCHIVES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/about/">
              
              ABOUT
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              CATEGORIES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/tags/">
              
              TAGS
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>SEARCH</a>
          </li>
          

          <!-- LangSelect -->
          
          
          
          
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('/img/header_img/comic/about_stars3.jpg');
      --intro-header-background-image-url-post: url('/img/header_img/scenery/tree_stars.jpg');
      --intro-header-background-image-url-page: url('//img/header_img/scenery/tree_stars.jpg');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/comic/about_stars3.jpg');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/scenery/tree_stars.jpg');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('//img/header_img/scenery/tree_stars.jpg');
    }

    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('/img/header_img/scenery/tree_stars.jpg'); */
      
    }

    
      #signature {/*signature*/
        background-image: url('/img/signature/jasonluo-white.png');
      }
    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading" style="height: 200px;">
            <div class="tags">
              
              <a class="tag" href="/tags/#vue3源码" title="vue3源码">vue3源码</a>
              
              <a class="tag" href="/tags/#vue3" title="vue3">vue3</a>
              
            </div>
            <h1>[vue3] 深入响应式原理</h1>
            <h2 class="subheading">一文带你深入理解响应式原理</h2>
            <span class="meta">
              Posted by Jason Luo on
              2021-06-08
            </span>


<!--            
            &lt;!&ndash; WordCount start &ndash;&gt;
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">25</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">5.4k</span> In Total
            </span>
            <div class="blank_box"></div>
            &lt;!&ndash; WordCount end &ndash;&gt;
            
            
            &lt;!&ndash; 不蒜子统计 start &ndash;&gt;
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            &lt;!&ndash; 不蒜子统计 end &ndash;&gt;
            -->


          </div>
          
        </div>
      </div>
    </div>
  </div>

  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <h2 id="深入响应式原理">深入响应式原理</h2>
<p>Vue 最独特的特性之一，是其非侵入性的响应性系统。数据模型是被代理的 JavaScript 对象。而当你修改它们时，视图会进行更新。这让状态管理非常简单直观</p>
<h3 id="概述">概述</h3>
<p>响应式原理主要由 3 个部分构成：1. 初始化；2. 收集依赖；3. 触发依赖</p>
<p>Vue3.0 观测数据提供4个方法：reactive, shallowReactive, readonly, shallowReadonly</p>
<p>示例demo:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;demo&quot;</span>&gt;</span><br><span class="line">  &lt;!-- <span class="number">2.</span> 收集依赖 --&gt;</span><br><span class="line">  &lt;h1 @click=<span class="string">&quot;handleAddCount&quot;</span>&gt; Vue.js Count: &#123;&#123;state.count&#125;&#125;&lt;/h1&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; reactive &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span>&#123;</span><br><span class="line">  <span class="function"><span class="title">setup</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 初始化</span></span><br><span class="line">    <span class="keyword">const</span> state = reactive(&#123; <span class="attr">count</span>: <span class="number">1</span> &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> handleAddCount = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 3. 触发依赖</span></span><br><span class="line">      state.count ++</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      state,</span><br><span class="line">      handleAddCount</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h3 id="实现响应式">实现响应式</h3>
<h4 id="响应基本类型变量">响应基本类型变量</h4>
<p>首先看一下响应式预期应该是什么样的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这种写成一行完全是为了节省空间，实际上我会一行一个变量</span></span><br><span class="line"><span class="keyword">let</span> a = <span class="number">1</span>, b = <span class="number">2</span>, c = a * b</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;c:&#x27;</span> + c) <span class="comment">// 2</span></span><br><span class="line">a = <span class="number">2</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;c:&#x27;</span> + c) <span class="comment">// c仍然是2，但期望是得到4,</span></span><br></pre></td></tr></table></figure>
<p>那么，如何才能做到但a变化时<code>c</code>跟着变化</p>
<p>显然，我们需要做的就是重新执行一下 <code>c = a * b</code> 即可，像这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="number">1</span>, b = <span class="number">2</span>, c = a * b</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;c:&#x27;</span> + c) <span class="comment">// 2</span></span><br><span class="line">a = <span class="number">2</span></span><br><span class="line">c = a * b</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;c:&#x27;</span> + c) <span class="comment">// 4</span></span><br></pre></td></tr></table></figure>
<p>现在我们把需要重新执行的代码写成一个函数，代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="number">1</span>, b = <span class="number">2</span>, c = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> effect = <span class="function">() =&gt;</span> &#123; c = a * b &#125;</span><br><span class="line">effect() <span class="comment">// 首次执行更新c的值</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;c:&#x27;</span> + c) <span class="comment">// 2</span></span><br><span class="line">a = <span class="number">2</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;c:&#x27;</span> + c) <span class="comment">// 期望得到4</span></span><br></pre></td></tr></table></figure>
<p>现在仍然没有达成预期的效果，实际上我们还需要两个方法，一个用来存储所有需要依赖更新的 <code>effect</code>，我们假设叫 <code>track</code>，一个用来触发执行这些 <code>effect</code> 函数，假设叫做 <code>trigger</code>。</p>
<p><strong>注意：</strong> 这里我们的函数命名和 Vue 3 中保持一致，从而可以更容易理解 Vue 3 源码。</p>
<p>代码类似这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="number">1</span>, b = <span class="number">2</span>, c = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> effect = <span class="function">() =&gt;</span> &#123; c = a * b &#125;</span><br><span class="line"></span><br><span class="line">track() <span class="comment">// 收集 effect </span></span><br><span class="line">effect() <span class="comment">// 首次执行更新c的值</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;c:&#x27;</span> + c) <span class="comment">// 2</span></span><br><span class="line">a = <span class="number">2</span></span><br><span class="line">trigger() <span class="comment">// a变化时，触发effect的执行</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;c:&#x27;</span> + c) <span class="comment">// 期望得到4</span></span><br></pre></td></tr></table></figure>
<p>那么 <code>track</code> 和 <code>trigger</code> 分别做了什么，是如何实现的呢？</p>
<p>我们暂且可以简单理解为一个“发布-订阅者模式”，<code>track</code> 就是不断给一个数组 <code>dep</code> 添加 <code>effect</code>，<code>trigger</code> 用来遍历执行 <code>dep</code> 的每一项 <code>effect</code>。</p>
<p>现在来完成这两个函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="number">1</span>, b = <span class="number">2</span>, c = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> effect = <span class="function">() =&gt;</span> &#123; c = a * b &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> dep = <span class="keyword">new</span> <span class="built_in">Set</span>()</span><br><span class="line"><span class="keyword">let</span> track = <span class="function">() =&gt;</span> &#123; dep.add(effect) &#125;</span><br><span class="line"><span class="keyword">let</span> trigger = <span class="function">() =&gt;</span> &#123; dep.forEach(<span class="function"><span class="params">effect</span> =&gt;</span> effect()) &#125;</span><br><span class="line"></span><br><span class="line">track()	 <span class="comment">// 收集依赖</span></span><br><span class="line">effect() <span class="comment">// 首次执行更新c的值</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;c:&#x27;</span> + c) <span class="comment">// 2</span></span><br><span class="line">a = <span class="number">2</span></span><br><span class="line">trigger() <span class="comment">// a变化时，触发effect的执行</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;c:&#x27;</span> + c) <span class="comment">// 期望得到4，实际得到4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 现在代码的执行结果已经符合预期了。输出如下</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">c:2</span></span><br><span class="line"><span class="comment">c:4</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>注意这里我们使用 <code>Set</code> 来定义 <code>dep</code>，原因就是 <code>Set</code> 本身不能添加重复的 <code>key</code>，读写都非常方便。</p>
<h4 id="响应对象的不同属性">响应对象的不同属性</h4>
<p>通常情况，我们定义的对象都有很多的属性，每一个属性都需要有自己的 <code>dep</code>（即每个属性都需要把那些依赖了自己的effect记录下来放进自己的 <code>new Set()</code> 中），如何来实现这样的功能呢？</p>
<p>有一段代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123; <span class="attr">a</span>: <span class="number">10</span>, <span class="attr">b</span>: <span class="number">20</span> &#125;</span><br><span class="line"><span class="keyword">let</span> timesA = obj.a * <span class="number">10</span></span><br><span class="line"><span class="keyword">let</span> divideA = obj.a / <span class="number">10</span></span><br><span class="line"><span class="keyword">let</span> timesB = obj.b * <span class="number">10</span></span><br><span class="line"><span class="keyword">let</span> divideB = obj.b / <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 100, 1, 200, 2</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;timesA&#125;</span>, <span class="subst">$&#123;divideA&#125;</span>, <span class="subst">$&#123;timesB&#125;</span>, <span class="subst">$&#123;divideB&#125;</span>`</span>)</span><br><span class="line">obj.a = <span class="number">100</span></span><br><span class="line">obj.b = <span class="number">200</span></span><br><span class="line"><span class="comment">// 期望得到 1000, 10, 2000, 20</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;timesA&#125;</span>, <span class="subst">$&#123;divideA&#125;</span>, <span class="subst">$&#123;timesB&#125;</span>, <span class="subst">$&#123;divideB&#125;</span>`</span>)</span><br></pre></td></tr></table></figure>
<p>这段代码中，按照上文讲解的，属性<code>a</code>和<code>b</code>的<code>dep</code>应该是如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> depA = [</span><br><span class="line">  () =&gt; &#123; timesA = obj.a * <span class="number">10</span> &#125;,</span><br><span class="line">  () =&gt; &#123; divideA = obj.a / <span class="number">10</span> &#125;</span><br><span class="line">]</span><br><span class="line"><span class="keyword">let</span> depB = [ </span><br><span class="line">  () =&gt; &#123; timesB = obj.b * <span class="number">10</span> &#125;,</span><br><span class="line">  () =&gt; &#123; divideB = obj.b / <span class="number">10</span> &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>如果代码还是按照前文的方式来写显然是不科学的，这里就要开始做一点点抽象了，收集依赖我们可以假想用<code>track('a')</code> <code>track('b')</code>这种形式分别记录对象不同<code>key</code>的依赖项，那么显然我们还需要一个东西来存放这些 <code>key</code> 及相应的<code>dep</code>。</p>
<p>现在我们来实现这样的 <code>track</code> 函数及对应的 <code>trigger</code> 函数，代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> depsMap = <span class="keyword">new</span> <span class="built_in">Map</span>() <span class="comment">// 每一项都是一个 Set 对象</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">track</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> dep = depsMap.get(key)</span><br><span class="line">  <span class="keyword">if</span>(!dep) &#123;</span><br><span class="line">    depsMap.set(key, dep = <span class="keyword">new</span> <span class="built_in">Set</span>());</span><br><span class="line">  &#125;</span><br><span class="line">  dep.add(effect)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> dep = depsMap.get(key)</span><br><span class="line">  <span class="keyword">if</span>(dep) &#123;</span><br><span class="line">    dep.forEach(<span class="function"><span class="params">effect</span> =&gt;</span> effect())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样就实现了对一个对象不同属性的依赖收集，那么现在这个代码最简单的使用方法将是下面这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> depsMap = <span class="keyword">new</span> <span class="built_in">Map</span>() <span class="comment">// 每一项都是一个 Set 对象</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">track</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// only for usage demo</span></span><br><span class="line">  <span class="keyword">if</span>(key === <span class="string">&#x27;a&#x27;</span>)&#123;</span><br><span class="line">    dep.add(effectTimesA)</span><br><span class="line">    dep.add(effectDivideA)</span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span>(key === <span class="string">&#x27;b&#x27;</span>)&#123;</span><br><span class="line">    dep.add(effectTimesB)</span><br><span class="line">    dep.add(effectDivideB)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj = &#123; <span class="attr">a</span>: <span class="number">10</span>, <span class="attr">b</span>: <span class="number">20</span> &#125;</span><br><span class="line"><span class="keyword">let</span> timesA = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> divideA = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> timesB = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> divideB = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> effectTimesA = <span class="function">() =&gt;</span> &#123; timesA = obj.a * <span class="number">10</span> &#125;</span><br><span class="line"><span class="keyword">let</span> effectDivideA = <span class="function">() =&gt;</span> &#123; divideA = obj.a / <span class="number">10</span> &#125;</span><br><span class="line"><span class="keyword">let</span> effectTimesB = <span class="function">() =&gt;</span> &#123; timesB = obj.b * <span class="number">10</span> &#125;</span><br><span class="line"><span class="keyword">let</span> effectDivideB = <span class="function">() =&gt;</span> &#123; divideB = obj.b / <span class="number">10</span> &#125;</span><br><span class="line"></span><br><span class="line">track(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">track(<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为了省事直接改成调用trigger，后文同样</span></span><br><span class="line">trigger(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">trigger(<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 100, 1, 200, 2</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;timesA&#125;</span>, <span class="subst">$&#123;divideA&#125;</span>, <span class="subst">$&#123;timesB&#125;</span>, <span class="subst">$&#123;divideB&#125;</span>`</span>)</span><br><span class="line">obj.a = <span class="number">100</span></span><br><span class="line">obj.b = <span class="number">200</span></span><br><span class="line"></span><br><span class="line">trigger(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">trigger(<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line"><span class="comment">// 期望得到：1000, 10, 2000, 20 实际得到：1000, 10, 2000, 20</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;timesA&#125;</span>, <span class="subst">$&#123;divideA&#125;</span>, <span class="subst">$&#123;timesB&#125;</span>, <span class="subst">$&#123;divideB&#125;</span>`</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>代码看起来仍然是臃肿无比，别着急，后面的设计会优化这个问题。</p>
<h4 id="响应多个对象">响应多个对象</h4>
<p>我们已经实现了对一个对象的响应编程，那么要对多个对象实现响应式编程该怎么做呢？</p>
<p>脑袋一拍，继续往外嵌套一层对象不就可以了吗？没错，你可以用 ES6 中的 <code>WeakMap</code> 轻松实现，<code>WeakMap</code> 刚好可以（只能）把对象当作 <code>key</code>。（题外话，<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/4220272051e2">Map 和 WeakMap 的区别</a>）</p>
<p>我们假想实现后是这样的效果：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj1 = &#123; <span class="attr">a</span>: <span class="number">10</span>, <span class="attr">b</span>: <span class="number">20</span> &#125;</span><br><span class="line"><span class="keyword">let</span> obj2 = &#123; <span class="attr">c</span>: <span class="number">30</span>, <span class="attr">d</span>: <span class="number">40</span> &#125;</span><br><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="built_in">WeakMap</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 省略代码</span></span><br><span class="line"><span class="comment">// 获取 obj1 的 depsMap</span></span><br><span class="line"><span class="comment">// 获取 obj2 的 depsMap</span></span><br><span class="line"></span><br><span class="line">targetMap.set(obj1, <span class="string">&quot;obj1&#x27;s depsMap&quot;</span>)</span><br><span class="line">targetMap.set(obj2, <span class="string">&quot;obj2&#x27;s depsMap&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>这里暂且不纠结为什么叫 <code>targetMap</code>，现在整体依赖关系如下：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>类型</th>
<th>key</th>
<th style="text-align:left">值</th>
</tr>
</thead>
<tbody>
<tr>
<td>targetMap</td>
<td>WeakMap</td>
<td>object</td>
<td style="text-align:left">depsMap</td>
</tr>
<tr>
<td>depsMap</td>
<td>Map</td>
<td>property</td>
<td style="text-align:left">dep</td>
</tr>
<tr>
<td>dep</td>
<td>Set</td>
<td></td>
<td style="text-align:left">effect</td>
</tr>
</tbody>
</table>
<ul>
<li>targetMap: 存放每个响应式对象（所有属性）的依赖项</li>
<li>targetMap: 存放响应式对象每个属性对应的依赖项</li>
<li>dep: 存放某个属性对应的所有依赖项（当这个对象对应属性的值发生变化时，这些依赖项函数会重新执行）</li>
</ul>
<p>现在我们可以实现这个功能了，核心代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">track</span>(<span class="params">target, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> depsMap = targetMap.get(target)</span><br><span class="line">  <span class="keyword">if</span>(!depsMap)&#123;</span><br><span class="line">    targetMap.set(target, depsMap = <span class="keyword">new</span> <span class="built_in">Map</span>())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> dep = depsMap.get(key)</span><br><span class="line">  <span class="keyword">if</span>(!dep) &#123;</span><br><span class="line">    depsMap.set(key, dep = <span class="keyword">new</span> <span class="built_in">Set</span>());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 先忽略这个</span></span><br><span class="line">  dep.add(effect)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params">target, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> depsMap = targetMap.get(target)</span><br><span class="line">  <span class="keyword">if</span>(depsMap)&#123;</span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.get(key)</span><br><span class="line">    <span class="keyword">if</span>(dep) &#123;</span><br><span class="line">      dep.forEach(<span class="function"><span class="params">effect</span> =&gt;</span> effect())</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么现在这个代码最简单的使用方法将是下面这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">track</span>(<span class="params">target, key</span>) </span>&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">// only for usage demo</span></span><br><span class="line">  <span class="keyword">if</span>(key === <span class="string">&#x27;a&#x27;</span>)&#123;</span><br><span class="line">    dep.add(effectTimesA)</span><br><span class="line">    dep.add(effectDivideA)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params">target, key</span>) </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj = &#123; <span class="attr">a</span>: <span class="number">10</span>, <span class="attr">b</span>: <span class="number">20</span> &#125;</span><br><span class="line"><span class="keyword">let</span> timesA = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> divideA = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> effectTimesA = <span class="function">() =&gt;</span> &#123; timesA = obj.a * <span class="number">10</span> &#125;</span><br><span class="line"><span class="keyword">let</span> effectDivideA = <span class="function">() =&gt;</span> &#123; divideA = obj.a / <span class="number">10</span> &#125;</span><br><span class="line"></span><br><span class="line">track(obj, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">trigger(obj, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;timesA&#125;</span>, <span class="subst">$&#123;divideA&#125;</span>`</span>) <span class="comment">// 100, 1</span></span><br><span class="line">obj.a = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">trigger(obj, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;timesA&#125;</span>, <span class="subst">$&#123;divideA&#125;</span>`</span>) <span class="comment">// 1000, 10</span></span><br></pre></td></tr></table></figure>
<p>至此，我们对响应式的基本概念有了了解，我们已经做到了收集所有响应式对象的依赖项，但是现在你可以看到代码的使用是极其繁琐的，主要是因为我们还没实现自动收集依赖项、自动触发修改。</p>
<h3 id="Proxy和Reflect">Proxy和Reflect</h3>
<p>上一节讲到了我们实现了基本的响应功能，但是我们目前还是手动进行依赖收集和触发更新的。</p>
<p>解决这个问题的方法应该是：</p>
<ul>
<li>当访问（<code>GET</code>）一个属性时，我们就调用 <code>track(obj, )</code> 自动收集依赖项（存储 <code>effect</code>）</li>
<li>当修改（<code>SET</code>）一个属性时，我们就调用 <code>trigger(obj, </code> 自动触发更新（执行存储的<code>effect</code>）</li>
</ul>
<p>那么现在问题就是，我们如何在访问或修改一个属性时做到这样的事情？也即是如何拦截这种 <code>GET</code> 和 <code>SET</code> 操作？</p>
<p>Vue 2中我们使用 ES5 中的 <code>Object.defineProperty</code> 来拦截 <code>GET</code> 和 <code>SET</code>。 Vue 3中我们将使用 ES6 中的 <code>Reflect</code> 和 <code>Proxy</code>。（注意：Vue 3不再支持IE浏览器，所以可以用比较多的高级特性）</p>
<p>我们先来看一下怎么输出一个对象的一个属性值，可以用下面这三种方法：</p>
<ul>
<li>使用 <code>.</code> =&gt; <code>obj.a</code></li>
<li>使用 <code>[]</code> =&gt; <code>obj['a']</code></li>
<li>使用 ES6 中的 <code>Reflect</code> =&gt; <code>Reflect.get(obj, 'a')</code></li>
</ul>
<p>这三种方法都是可行的，但是 <code>Reflect</code> 有非常强大的能力。</p>
<p><code>Reflect</code>可以看做<code>Object.defineProperty</code>的上位替代</p>
<p>todo</p>
<p>文章指路： proxy和reflect</p>
<h4 id="实现reactive函数">实现<code>reactive</code>函数</h4>
<p>示例代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123; <span class="attr">a</span>: <span class="number">1</span>&#125;</span><br><span class="line"><span class="keyword">let</span> proxiedObj = <span class="keyword">new</span> <span class="built_in">Proxy</span>(obj, &#123;</span><br><span class="line">  <span class="function"><span class="title">get</span>(<span class="params">target, key, receiver</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;Get&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Reflect</span>.get(target, key, receiver)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">set</span>(<span class="params">target, key, value, receiver</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;Set&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Reflect</span>.set(target, key, value, receiver)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(proxiedObj.a) <span class="comment">// Get 1</span></span><br></pre></td></tr></table></figure>
<p>接下来我们要做的就是结合 <code>Proxy</code> 的 <code>handler</code> 和 之前实现了的 <code>track</code>、<code>trigger</code> 来完成一个响应式模块。</p>
<p>首先，我们来封装一下 <code>Proxy</code> 相关代码，和Vue 3保持一致叫<code>reactive</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reactive</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> handler = &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params">target, key, receiver</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Reflect</span>.get(target, key, receiver)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">target, key, value, receiver</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Reflect</span>.set(target, key, value, receiver)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Proxy</span>(target, handler)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有一个问题，当我们每次调用 <code>reactive</code> 时都会重新定义一个 <code>handler</code> 的对象，为了优化这个，我们把 <code>handler</code> 提出去，代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> reactiveHandler = &#123;</span><br><span class="line">  <span class="function"><span class="title">get</span>(<span class="params">target, key, receiver</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Reflect</span>.get(target, key, receiver)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">set</span>(<span class="params">target, key, value, receiver</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Reflect</span>.set(target, key, value, receiver)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reactive</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Proxy</span>(target, reactiveHandler)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在把<code>reactive</code>引入到我们的第一节中最后的示例代码中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = reactive(&#123; <span class="attr">a</span>: <span class="number">10</span>, <span class="attr">b</span>: <span class="number">20</span> &#125;)</span><br><span class="line"><span class="keyword">let</span> timesA = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> divideA = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> effectTimesA = <span class="function">() =&gt;</span> &#123; timesA = obj.a * <span class="number">10</span> &#125;</span><br><span class="line"><span class="keyword">let</span> effectDivideA = <span class="function">() =&gt;</span> &#123; divideA = obj.a / <span class="number">10</span> &#125;</span><br><span class="line"></span><br><span class="line">track(obj, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">trigger(obj, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;timesA&#125;</span>, <span class="subst">$&#123;divideA&#125;</span>`</span>) <span class="comment">// 100, 1</span></span><br><span class="line">obj.a = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">trigger(obj, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;timesA&#125;</span>, <span class="subst">$&#123;divideA&#125;</span>`</span>) <span class="comment">// 1000, 10</span></span><br></pre></td></tr></table></figure>
<p>现在我们要做的是去掉示例代码中的 <code>track</code> 和 <code>trigger</code>。</p>
<p>回到本节开头提出的解决方案，我们已经可以拦截 <code>GET</code> 和 <code>SET</code> 操作了，只需要在适当的时候调用 <code>track</code> 和 <code>trigger</code> 方法即可，我们修改 <code>reactiveHandler</code> 代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> reactiveHandler = &#123;</span><br><span class="line">  <span class="function"><span class="title">get</span>(<span class="params">target, key, receiver</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="built_in">Reflect</span>.get(target, key, receiver)</span><br><span class="line">    track(target, key)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">set</span>(<span class="params">target, key, value, receiver</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> oldVal = target[key]</span><br><span class="line">    <span class="keyword">const</span> result = <span class="built_in">Reflect</span>.set(target, key, value, receiver)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里判断条件不对，result为一个布尔值</span></span><br><span class="line">    <span class="keyword">if</span>(oldVal !== result)&#123;</span><br><span class="line">      trigger(target, key)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们的示例代码可以精简为这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = reactive(&#123; <span class="attr">a</span>: <span class="number">10</span>, <span class="attr">b</span>: <span class="number">20</span> &#125;)</span><br><span class="line"><span class="keyword">let</span> timesA = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> divideA = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> effectTimesA = <span class="function">() =&gt;</span> &#123; timesA = obj.a * <span class="number">10</span> &#125;</span><br><span class="line"><span class="keyword">let</span> effectDivideA = <span class="function">() =&gt;</span> &#123; divideA = obj.a / <span class="number">10</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 恢复调用 effect 的形式</span></span><br><span class="line">effectTimesA()</span><br><span class="line">effectDivideA()</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;timesA&#125;</span>, <span class="subst">$&#123;divideA&#125;</span>`</span>) <span class="comment">// 100, 1</span></span><br><span class="line">obj.a = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;timesA&#125;</span>, <span class="subst">$&#123;divideA&#125;</span>`</span>) <span class="comment">// 1000, 10</span></span><br></pre></td></tr></table></figure>
<p>我们已经去掉了手动 <code>track</code> 和 <code>trigger</code> 代码，至此，我们已经实现了 <code>reactive</code> 函数，看起来和Vue 3源码差不多了。</p>
<p>但这还有点问题：</p>
<ul>
<li><code>track</code> 函数中的 <code>effect</code> 现在还没处理，只能手动添加</li>
<li><code>reactive</code> 现在只能作用于对象，基本类型变量怎么处理？</li>
</ul>
<p>下一个章节我们将解决这个问题，让我们的代码更加接近Vue 3。</p>
<h3 id="activeEffect和ref">activeEffect和ref</h3>
<p>首先，我们修改一下示例代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = reactive(&#123; <span class="attr">a</span>: <span class="number">10</span>, <span class="attr">b</span>: <span class="number">20</span> &#125;)</span><br><span class="line"><span class="keyword">let</span> timesA = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> effect = <span class="function">() =&gt;</span> &#123; timesA = obj.a * <span class="number">10</span> &#125;</span><br><span class="line">effect()</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(timesA) <span class="comment">// 100</span></span><br><span class="line">obj.a = <span class="number">100</span></span><br><span class="line"><span class="comment">// 新增一行，使用到obj.a</span></span><br><span class="line"><span class="built_in">console</span>.log(obj.a)</span><br><span class="line"><span class="built_in">console</span>.log(timesA) <span class="comment">// 1000</span></span><br></pre></td></tr></table></figure>
<p>由上节知识可以知道，当 <code>effect</code> 执行时我们访问到了 <code>obj.a</code>，因此会触发 <code>track</code> 收集该依赖 <code>effect</code>。同理，<code>console.log(obj.a)</code> 这一行也同样触发了 <code>track</code>，但这并不是响应式代码，我们预期不触发 <code>track</code>。</p>
<p><strong>我们想要的是只在 <code>effect</code> 中的代码才触发 <code>track</code></strong>。</p>
<p>能想到怎么来实现吗？</p>
<h4 id="activeEffect">activeEffect</h4>
<p>只响应需要依赖更新的代码（effect）</p>
<p>首先，我们定义一个变量 <code>shouldTrack</code>，<strong>暂且</strong>认为它表示是否需要执行 <code>track</code>，我们修改 <code>track</code> 代码，只需要增加一层判断条件，如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line"><span class="keyword">let</span> shouldTrack = <span class="literal">null</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">track</span>(<span class="params">target, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(shouldTrack)&#123;</span><br><span class="line">    <span class="keyword">let</span> depsMap = targetMap.get(target)</span><br><span class="line">    <span class="keyword">if</span>(!depsMap)&#123;</span><br><span class="line">      targetMap.set(target, depsMap = <span class="keyword">new</span> <span class="built_in">Map</span>())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.get(key)</span><br><span class="line">    <span class="keyword">if</span>(!dep) &#123;</span><br><span class="line">      depsMap.set(key, dep = <span class="keyword">new</span> <span class="built_in">Set</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里的 effect 为使用时定义的 effect</span></span><br><span class="line">    <span class="comment">// shouldTrack 时应该把对应的 effect 传进来</span></span><br><span class="line">    dep.add(effect)</span><br><span class="line">    <span class="comment">// 如果有多个就手写多个</span></span><br><span class="line">    <span class="comment">// dep.add(effect1)</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们需要解决的就是 <code>shouldTrack</code> 赋值问题，当有需要响应式变动的地方，我们就写一个 <code>effect</code> 并赋值给 <code>shouldTrack</code>，然后 <code>effect</code> 执行完后重置 <code>shouldTrack</code> 为 <code>null</code>，这样结合刚才修改的 <code>track</code> 函数就解决了这个问题，思路如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> shouldTrack = <span class="literal">null</span></span><br><span class="line"><span class="comment">// 这里省略 track trigger reactive 代码</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj = reactive(&#123; <span class="attr">a</span>: <span class="number">10</span>, <span class="attr">b</span>: <span class="number">20</span> &#125;)</span><br><span class="line"><span class="keyword">let</span> timesA = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> effect = <span class="function">() =&gt;</span> &#123; timesA = obj.a * <span class="number">10</span> &#125;</span><br><span class="line">shouldTrack = effect <span class="comment">// (*)</span></span><br><span class="line">effect()</span><br><span class="line">shouldTrack = <span class="literal">null</span> <span class="comment">// (*)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(timesA) <span class="comment">// 100</span></span><br><span class="line">obj.a = <span class="number">100</span></span><br><span class="line"><span class="built_in">console</span>.log(obj.a)</span><br><span class="line"><span class="built_in">console</span>.log(timesA) <span class="comment">// 1000</span></span><br></pre></td></tr></table></figure>
<p>此时，执行到 <code>console.log(obj.a)</code> 时，由于 <code>shouldTrack</code> 值为 <code>null</code>，所以并不会执行 <code>track</code>，完美。</p>
<p>完美了吗？显然不是，当有很多的 <code>effect</code> 时，你的代码会变成下面这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> effect1 = <span class="function">() =&gt;</span> &#123; timesA = obj.a * <span class="number">10</span> &#125;</span><br><span class="line">shouldTrack = effect1 <span class="comment">// (*)</span></span><br><span class="line">effect1()</span><br><span class="line">shouldTrack = <span class="literal">null</span> <span class="comment">// (*)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> effect2 = <span class="function">() =&gt;</span> &#123; timesB = obj.a * <span class="number">10</span> &#125;</span><br><span class="line">shouldTrack = effect1 <span class="comment">// (*)</span></span><br><span class="line">effect2()</span><br><span class="line">shouldTrack = <span class="literal">null</span> <span class="comment">// (*)</span></span><br></pre></td></tr></table></figure>
<p>我们来优化一下这个问题，为了和Vue 3保持一致，这里我们修改 <code>shouldTrack</code> 为 <code>activeEffect</code>，现在它<strong>表示当前运行的 <code>effect</code></strong>。</p>
<p>我们把这段重复使用的代码封装成函数，如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> activeEffect = <span class="literal">null</span></span><br><span class="line"><span class="comment">// 这里省略 track trigger reactive 代码</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">effect</span>(<span class="params">eff</span>) </span>&#123;</span><br><span class="line">  activeEffect = eff</span><br><span class="line">  activeEffect()</span><br><span class="line">  activeEffect = <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时我们还需要修改一下 <code>track</code> 函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">track</span>(<span class="params">target, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(activeEffect)&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 这里不用再根据条件手动添加不同的 effect 了！</span></span><br><span class="line">    dep.add(activeEffect)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么现在的使用方法就变成了：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line"><span class="keyword">let</span> activeEffect = <span class="literal">null</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">effect</span> (<span class="params">eff</span>) </span>&#123; ... &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">track</span>(<span class="params"></span>) </span>&#123; ... &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params"></span>) </span>&#123; ... &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reactive</span>(<span class="params"></span>) </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj = reactive(&#123; <span class="attr">a</span>: <span class="number">10</span>, <span class="attr">b</span>: <span class="number">20</span> &#125;)</span><br><span class="line"><span class="keyword">let</span> timesA = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> timesB = <span class="number">0</span></span><br><span class="line">effect(<span class="function">() =&gt;</span> &#123; timesA = obj.a * <span class="number">10</span> &#125;)</span><br><span class="line">effect(<span class="function">() =&gt;</span> &#123; timesB = obj.b * <span class="number">10</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(timesA) <span class="comment">// 100</span></span><br><span class="line">obj.a = <span class="number">100</span></span><br><span class="line"><span class="built_in">console</span>.log(obj.a)</span><br><span class="line"><span class="built_in">console</span>.log(timesA) <span class="comment">// 1000</span></span><br></pre></td></tr></table></figure>
<h4 id="现阶段完整代码">现阶段完整代码</h4>
<p>现在新建一个文件<code>reactive.ts</code>，内容就是当前实现的完整响应式代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line"><span class="keyword">let</span> activeEffect = <span class="literal">null</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">effect</span>(<span class="params">eff</span>) </span>&#123;</span><br><span class="line">  activeEffect = eff</span><br><span class="line">  activeEffect()</span><br><span class="line">  activeEffect = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">track</span>(<span class="params">target, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(activeEffect)&#123;</span><br><span class="line">    <span class="keyword">let</span> depsMap = targetMap.get(target)</span><br><span class="line">    <span class="keyword">if</span>(!depsMap)&#123;</span><br><span class="line">      targetMap.set(target, depsMap = <span class="keyword">new</span> <span class="built_in">Map</span>())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.get(key)</span><br><span class="line">    <span class="keyword">if</span>(!dep) &#123;</span><br><span class="line">      depsMap.set(key, dep = <span class="keyword">new</span> <span class="built_in">Set</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    dep.add(activeEffect)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params">target, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> depsMap = targetMap.get(target)</span><br><span class="line">  <span class="keyword">if</span>(depsMap)&#123;</span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.get(key)</span><br><span class="line">    <span class="keyword">if</span>(dep) &#123;</span><br><span class="line">      dep.forEach(<span class="function"><span class="params">effect</span> =&gt;</span> effect())</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> reactiveHandler = &#123;</span><br><span class="line">  <span class="function"><span class="title">get</span>(<span class="params">target, key, receiver</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="built_in">Reflect</span>.get(target, key, receiver)</span><br><span class="line">    track(target, key)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">set</span>(<span class="params">target, key, value, receiver</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> oldVal = target[key]</span><br><span class="line">    <span class="keyword">const</span> result = <span class="built_in">Reflect</span>.set(target, key, value, receiver)</span><br><span class="line">    <span class="keyword">if</span>(oldVal !== result)&#123;</span><br><span class="line">      trigger(target, key)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reactive</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Proxy</span>(target, reactiveHandler)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们已经解决了非响应式代码也触发<code>track</code>的问题，同时也解决了上节中留下的问题：<code>track</code> 函数中的 <code>effect</code> 只能手动添加。</p>
<p>接下来我们解决上节中留下的另一个问题：<code>reactive</code> 现在只能作用于对象，基本类型变量怎么处理？</p>
<h4 id="实现ref">实现ref</h4>
<p>修改 <code>demo.js</code> 代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; effect, reactive &#125; <span class="keyword">from</span> <span class="string">&quot;./reactive&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj = reactive(&#123; <span class="attr">a</span>: <span class="number">10</span>, <span class="attr">b</span>: <span class="number">20</span> &#125;)</span><br><span class="line"><span class="keyword">let</span> timesA = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> sum = <span class="number">0</span></span><br><span class="line">effect(<span class="function">() =&gt;</span> &#123; timesA = obj.a * <span class="number">10</span> &#125;)</span><br><span class="line">effect(<span class="function">() =&gt;</span> &#123; sum = timesA + obj.b &#125;)</span><br><span class="line"></span><br><span class="line">obj.a = <span class="number">100</span></span><br><span class="line"><span class="built_in">console</span>.log(sum) <span class="comment">// 期望: 1020</span></span><br></pre></td></tr></table></figure>
<p>这段代码并不能实现预期效果，因为当 <code>timesA</code> 正常更新时，我们希望能更新 <code>sum</code>（即重新执行 <code>() =&gt; &#123; sum = timesA + obj.b &#125;</code>），而实际上由于 <code>timesA</code> 并不是一个响应式对象，没有 <code>track</code> 其依赖，所以这一行代码并不会执行。</p>
<p>那我们如何才能让这段代码正常工作呢？其实我们把基本类型变量包装成一个对象去调用 <code>reactive</code> 即可。 看过 <code>Vue composition API</code> 的同学可能知道，Vue 3中用一个 <code>ref</code> 函数来实现把基本类型变量变成响应式对象，通过 <code>.value</code> 获取值，<code>ref</code> 返回的就是一个 <code>reactive</code> 对象。</p>
<p>实现这样的一个有 <code>value</code> 属性的对象有这两种方法：</p>
<ol>
<li>直接给一个对象添加 <code>value</code> 属性</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ref</span>(<span class="params">intialValue</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> reactive(&#123;</span><br><span class="line">    value: intialValue</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>用 <code>getter</code> 和 <code>setter</code> 来实现</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ref</span>(<span class="params">raw</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> r = &#123;</span><br><span class="line">    <span class="keyword">get</span> <span class="title">value</span>() &#123;</span><br><span class="line">      track(r, <span class="string">&#x27;value&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> raw</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">set</span> <span class="title">value</span>(<span class="params">newVal</span>) &#123;</span><br><span class="line">      raw = newVal</span><br><span class="line">      trigger(r, <span class="string">&#x27;value)</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  return r</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>现在我们的示例代码修改成：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; effect, reactive &#125; <span class="keyword">from</span> <span class="string">&quot;./reactive&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ref</span>(<span class="params">intialValue</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> reactive(&#123;</span><br><span class="line">    value: intialValue</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj = reactive(&#123; <span class="attr">a</span>: <span class="number">10</span>, <span class="attr">b</span>: <span class="number">20</span> &#125;)</span><br><span class="line"><span class="keyword">let</span> timesA = ref(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">let</span> sum = <span class="number">0</span></span><br><span class="line">effect(<span class="function">() =&gt;</span> &#123; timesA.value = obj.a * <span class="number">10</span> &#125;)</span><br><span class="line">effect(<span class="function">() =&gt;</span> &#123; sum = timesA.value + obj.b &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 期望: timesA: 100  sum: 120 实际：timesA: 100  sum: 120</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`timesA: <span class="subst">$&#123;timesA.value&#125;</span>  sum: <span class="subst">$&#123;sum&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">obj.a = <span class="number">100</span></span><br><span class="line"><span class="comment">// 期望: timesA: 1000  sum: 1020 实际：timesA: 1000  sum: 1020</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`timesA: <span class="subst">$&#123;timesA&#125;</span>  sum: <span class="subst">$&#123;sum&#125;</span>`</span>)</span><br></pre></td></tr></table></figure>
<p>增加了 <code>ref</code> 处理基本类型变量后，我们的示例代码运行结果符合预期了。至此我们已经解决了遗留问题：<code>reactive</code> 只能作用于对象，基本类型变量怎么处理？</p>
<p>Vue 3中的 <code>ref</code> 是用<strong>第二种</strong>方法来实现的，现在我们整理一下代码，把 <code>ref</code> 放到 <code>reactive.j</code> 中。</p>
<h4 id="现阶段完整代码-2">现阶段完整代码</h4>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line"><span class="keyword">let</span> activeEffect = <span class="literal">null</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">effect</span>(<span class="params">eff</span>) </span>&#123;</span><br><span class="line">  activeEffect = eff</span><br><span class="line">  activeEffect()</span><br><span class="line">  activeEffect = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">track</span>(<span class="params">target, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(activeEffect)&#123;</span><br><span class="line">    <span class="keyword">let</span> depsMap = targetMap.get(target)</span><br><span class="line">    <span class="keyword">if</span>(!depsMap)&#123;</span><br><span class="line">      targetMap.set(target, depsMap = <span class="keyword">new</span> <span class="built_in">Map</span>())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.get(key)</span><br><span class="line">    <span class="keyword">if</span>(!dep) &#123;</span><br><span class="line">      depsMap.set(key, dep = <span class="keyword">new</span> <span class="built_in">Set</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    dep.add(activeEffect)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params">target, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> depsMap = targetMap.get(target)</span><br><span class="line">  <span class="keyword">if</span>(depsMap)&#123;</span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.get(key)</span><br><span class="line">    <span class="keyword">if</span>(dep) &#123;</span><br><span class="line">      dep.forEach(<span class="function"><span class="params">effect</span> =&gt;</span> effect())</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> reactiveHandler = &#123;</span><br><span class="line">  <span class="function"><span class="title">get</span>(<span class="params">target, key, receiver</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="built_in">Reflect</span>.get(target, key, receiver)</span><br><span class="line">    track(target, key)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">set</span>(<span class="params">target, key, value, receiver</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> oldVal = target[key]</span><br><span class="line">    <span class="keyword">const</span> result = <span class="built_in">Reflect</span>.set(target, key, value, receiver)</span><br><span class="line">    <span class="keyword">if</span>(oldVal !== result)&#123;</span><br><span class="line">      trigger(target, key)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reactive</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Proxy</span>(target, reactiveHandler)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ref</span>(<span class="params">raw</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> r = &#123;</span><br><span class="line">    <span class="keyword">get</span> <span class="title">value</span>() &#123;</span><br><span class="line">      track(r, <span class="string">&#x27;value&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> raw</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">set</span> <span class="title">value</span>(<span class="params">newVal</span>) &#123;</span><br><span class="line">      raw = newVal</span><br><span class="line">      trigger(r, <span class="string">&#x27;value)</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  return r</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>有同学可能就要问了，为什么不直接用第一种方法实现 <code>ref</code>，而是选择了比较复杂的第二种方法呢？ 主要有三方面原因：</p>
<ol>
<li>根据定义，<code>ref</code> 应该只有一个公开的属性，即 <code>value</code>，如果使用了 <code>reactive</code> 你可以给这个变量增加新的属性，这其实就破坏了 <code>ref</code> 的设计目的，它应该只用来包装一个内部的 <code>value</code> 而不应该作为一个通用的 <code>reactive</code> 对象；</li>
<li>Vue 3中有一个 <code>isRef</code> 函数，用来判断一个对象是 <code>ref</code> 对象而不是 <code>reactive</code> 对象，这种判断在很多场景都是非常有必要的；</li>
<li>性能方面考虑，Vue 3中的 <code>reactive</code> 做的事情远比第二种实现 <code>ref</code> 的方法多，比如有各种检查。</li>
</ol>
<h3 id="Computed">Computed</h3>
<p>我们拿 <code>timesA</code> 前后的改动来说明，思考一下 <code>computed</code> 应该是什么样的？</p>
<ol>
<li>返回响应式对象，也就是 <code>ref()</code></li>
<li>内部需要执行 <code>effect</code> 函数以收集依赖</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">computed</span>(<span class="params">getter</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> result = ref();</span><br><span class="line">  effect(<span class="function">() =&gt;</span> result.value = getter())</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在测试一下示例代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; effect, reactive, ref &#125; <span class="keyword">from</span> <span class="string">&quot;./reactive&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj = reactive(&#123; <span class="attr">a</span>: <span class="number">10</span>, <span class="attr">b</span>: <span class="number">20</span> &#125;)</span><br><span class="line"><span class="keyword">let</span> timesA = computed(<span class="function">() =&gt;</span> obj.a * <span class="number">10</span>)</span><br><span class="line"><span class="keyword">let</span> sum = computed(<span class="function">() =&gt;</span> timesA.value + obj.b)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 期望: timesA: 1000  sum: 1020 实际：timesA: 1000  sum: 1020</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`timesA: <span class="subst">$&#123;timesA.value&#125;</span>  sum: <span class="subst">$&#123;sum.value&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">obj.a = <span class="number">100</span></span><br><span class="line"> <span class="comment">// 期望: timesA: 1000  sum: 1020</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`timesA: <span class="subst">$&#123;timesA.value&#125;</span>  sum: <span class="subst">$&#123;sum.value&#125;</span>`</span>)</span><br></pre></td></tr></table></figure>
<p>结果符合预期。 这样实现看起来很容易，实际上Vue 3中的 <code>computed</code> 支持传入一个 <code>getter</code> 函数或传入一个有 <code>get</code> 和 <code>set</code> 的对象，并且有其它操作，这里我们不做实现，感兴趣可以去看<a target="_blank" rel="noopener" href="https://github.com/vuejs/vue-next/blob/master/packages/reactivity/src/computed.ts">源码</a>。</p>
<h4 id="现阶段完整代码-3">现阶段完整代码</h4>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line"><span class="keyword">let</span> activeEffect = <span class="literal">null</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">effect</span>(<span class="params">eff</span>) </span>&#123;</span><br><span class="line">  activeEffect = eff</span><br><span class="line">  activeEffect()</span><br><span class="line">  activeEffect = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">track</span>(<span class="params">target, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(activeEffect)&#123;</span><br><span class="line">    <span class="keyword">let</span> depsMap = targetMap.get(target)</span><br><span class="line">    <span class="keyword">if</span>(!depsMap)&#123;</span><br><span class="line">      targetMap.set(target, depsMap = <span class="keyword">new</span> <span class="built_in">Map</span>())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.get(key)</span><br><span class="line">    <span class="keyword">if</span>(!dep) &#123;</span><br><span class="line">      depsMap.set(key, dep = <span class="keyword">new</span> <span class="built_in">Set</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    dep.add(activeEffect)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params">target, key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> depsMap = targetMap.get(target)</span><br><span class="line">  <span class="keyword">if</span>(depsMap)&#123;</span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.get(key)</span><br><span class="line">    <span class="keyword">if</span>(dep) &#123;</span><br><span class="line">      dep.forEach(<span class="function"><span class="params">effect</span> =&gt;</span> effect())</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> reactiveHandler = &#123;</span><br><span class="line">  <span class="function"><span class="title">get</span>(<span class="params">target, key, receiver</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="built_in">Reflect</span>.get(target, key, receiver)</span><br><span class="line">    track(target, key)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">set</span>(<span class="params">target, key, value, receiver</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> oldVal = target[key]</span><br><span class="line">    <span class="keyword">const</span> result = <span class="built_in">Reflect</span>.set(target, key, value, receiver)</span><br><span class="line">    <span class="keyword">if</span>(oldVal !== result)&#123;</span><br><span class="line">      trigger(target, key)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reactive</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Proxy</span>(target, reactiveHandler)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ref</span>(<span class="params">raw</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> r = &#123;</span><br><span class="line">    <span class="keyword">get</span> <span class="title">value</span>() &#123;</span><br><span class="line">      track(r, <span class="string">&#x27;value&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> raw</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">set</span> <span class="title">value</span>(<span class="params">newVal</span>) &#123;</span><br><span class="line">      raw = newVal</span><br><span class="line">      trigger(r, <span class="string">&#x27;value&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">computed</span>(<span class="params">getter</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> result = ref();</span><br><span class="line">  effect(<span class="function">() =&gt;</span> result.value = getter())</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="尚存问题">尚存问题</h4>
<p>我们现在的代码非常简易，有很多细节尚未实现，你都可以在源码中学习到，比如：</p>
<ul>
<li>操作一些内置的属性，如 <code>Symbol.iterator</code>、<code>Array.length</code> 等触发了 <code>track</code> 如何处理</li>
<li>嵌套的对象，如何递归响应</li>
<li>对象某个 <code>key</code> 对应的 <code>value</code> 本身是一个 <code>reactive</code> 对象，如何处理</li>
</ul>
<p>你也可以自己尝试着实现它们。</p>
<h3 id="参考">参考</h3>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6922376557701005319#heading-3">https://juejin.cn/post/6922376557701005319#heading-3</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6854573206838673421">https://juejin.cn/post/6854573206838673421</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/natee/build-your-own-vue-next">https://github.com/natee/build-your-own-vue-next</a></p>
<p><a target="_blank" rel="noopener" href="https://v3.cn.vuejs.org/guide/reactivity.html#%E4%BB%80%E4%B9%88%E6%98%AF%E5%93%8D%E5%BA%94%E6%80%A7">https://v3.cn.vuejs.org/guide/reactivity.html#什么是响应性</a></p>
<p>vue3源码https://github.com/vuejs/vue-next/</p>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/en/vue3-响应性API/" data-toggle="tooltip" data-placement="top" title="[vue3] 响应性API">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/en/vue3-vue3源码结构、核心模块及运行过程/" data-toggle="tooltip" data-placement="top" title="[vue3] vue3源码结构、核心模块及运行过程">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. If the images used in the blog infringe your copyright, please contact the author to delete them. Thank you !
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->

  <!-- gitalk start -->
  <!-- Docs:https://github.com/gitalk/gitalk/blob/master/readme-cn.md -->

  <div id="gitalk-container"></div>

  
    <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.js"></script> -->
    <script src="/js/comment/gitalk.js"></script>
  

  <script>
    var gitalk = new Gitalk({
      clientID: 'be77013e3cb3cb9e89f1',
      clientSecret: '39e9b02a8070f1366c5e87418220c8f375864ab8',
      repo: 'jasonluox',
      owner: 'JasonLuox',
      admin: 'JasonLuox',
      id: 'Tue Jun 08 2021 12:34:17 GMT+0800', // Ensure uniqueness and length less than 50
      distractionFreeMode: false, // Facebook-like distraction free mode
      perPage: 10,
      pagerDirection: 'last',
      createIssueManually: false,
      language: 'en',
      proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token'
    });
    gitalk.render('gitalk-container');

    var gtFolded = () => {
      setTimeout(function () {
        let markdownBody = document.getElementsByClassName("markdown-body");
        let list = Array.from(markdownBody);
        list.forEach(item => {
          if (item.clientHeight > 250) {
            item.classList.add('gt-comment-body-folded');
            item.style.maxHeight = '250px';
            item.title = 'Click to Expand';
            item.onclick = function () {
              item.classList.remove('gt-comment-body-folded');
              item.style.maxHeight = '';
              item.title = '';
              item.onclick = null;
            };
          }
        })
      }, 800);
    }
  </script>

  <!-- gitalk end -->


<!-- 2. gitment comment -->


<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%B7%B1%E5%85%A5%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">深入响应式原理</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">概述</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%AE%9E%E7%8E%B0%E5%93%8D%E5%BA%94%E5%BC%8F"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">实现响应式</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%93%8D%E5%BA%94%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B%E5%8F%98%E9%87%8F"><span class="toc-nav-number">1.2.1.</span> <span class="toc-nav-text">响应基本类型变量</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%93%8D%E5%BA%94%E5%AF%B9%E8%B1%A1%E7%9A%84%E4%B8%8D%E5%90%8C%E5%B1%9E%E6%80%A7"><span class="toc-nav-number">1.2.2.</span> <span class="toc-nav-text">响应对象的不同属性</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%93%8D%E5%BA%94%E5%A4%9A%E4%B8%AA%E5%AF%B9%E8%B1%A1"><span class="toc-nav-number">1.2.3.</span> <span class="toc-nav-text">响应多个对象</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Proxy%E5%92%8CReflect"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">Proxy和Reflect</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%AE%9E%E7%8E%B0reactive%E5%87%BD%E6%95%B0"><span class="toc-nav-number">1.3.1.</span> <span class="toc-nav-text">实现reactive函数</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#activeEffect%E5%92%8Cref"><span class="toc-nav-number">1.4.</span> <span class="toc-nav-text">activeEffect和ref</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#activeEffect"><span class="toc-nav-number">1.4.1.</span> <span class="toc-nav-text">activeEffect</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E7%8E%B0%E9%98%B6%E6%AE%B5%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="toc-nav-number">1.4.2.</span> <span class="toc-nav-text">现阶段完整代码</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%AE%9E%E7%8E%B0ref"><span class="toc-nav-number">1.4.3.</span> <span class="toc-nav-text">实现ref</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E7%8E%B0%E9%98%B6%E6%AE%B5%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81-2"><span class="toc-nav-number">1.4.4.</span> <span class="toc-nav-text">现阶段完整代码</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Computed"><span class="toc-nav-number">1.5.</span> <span class="toc-nav-text">Computed</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E7%8E%B0%E9%98%B6%E6%AE%B5%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81-3"><span class="toc-nav-number">1.5.1.</span> <span class="toc-nav-text">现阶段完整代码</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%B0%9A%E5%AD%98%E9%97%AE%E9%A2%98"><span class="toc-nav-number">1.5.2.</span> <span class="toc-nav-text">尚存问题</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%8F%82%E8%80%83"><span class="toc-nav-number">1.6.</span> <span class="toc-nav-text">参考</span></a></li></ol></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">FEATURED TAGS</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#vue3源码" title="vue3源码">vue3源码</a>
            
            <a class="tag" href="/tags/#vue3" title="vue3">vue3</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          

          

          

          

          

          

          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          Jason Luo
          2021
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="/js/hux-blog.min.js"></script>
  <!-- catalog -->
  <script async="true" type="text/javascript" src="/js/catalog.js"></script>
  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="/js/scroll.js"></script>
    <!-- Scroll end -->
  

  
    <!-- LangSelect start -->
    <script type="text/javascript" src="/js/langselect.js"></script>
    <!-- LangSelect end -->
  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="/js/mouseclick.js" content='我要变强，为此不惜一切...,一念往，尽作尘泥罢...,玻璃晴朗，橘子辉煌...,我心即地狱，管他罪孽滔天...,我要这天，再遮不住我眼...,我要这地，再埋不了我心...,斯若晴空，何惧冰寒...,这灯红酒绿的世界啊...,不要放弃，哪怕付出所有...' color='#CDF0EA,#F9F9F9,#F7DBF0,#BEAEE2,#F38181,#FCE38A,#EAFFD0,#95E1D3,#80D6FF'></script>
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="/js/ribbonDynamic.js"></script>
  

  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("https://jasonluox.github.io/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="SEARCH..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"mobile":{"show":"fasle"},"display":{"hOffset":-40,"vOffset":-80},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
