<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-xxxxxx-xx"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-xxxxxx-xx');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="It&#39;s an IT blog..."/>
  <meta name="keyword" content="HTML,JavaScript,CSS,TypeScript,VUE,WEBPACK,VITE"/>
  <link rel="shortcut icon" href="/img/avatar/logo.jpg"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css"/>
    <link rel="stylesheet" href="/css/widget.css"/>
    <link rel="stylesheet" href="/css/rocket.css"/>
    <link rel="stylesheet" href="/css/signature.css"/>
    <link rel="stylesheet" href="/css/catalog.css"/>
    <link rel="stylesheet" href="/css/livemylife.css"/>

    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
      <!-- gitalk start -->
      <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->
      <link rel="stylesheet" href="/css/gitalk.css"/>
      <!-- gitalk end -->
    
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="https://jasonluox.github.io/en/vue3-【源码解读】AST 生成可运行代码/">
  <title>
    
      [vue3 源码解读] AST生成可运行代码 - 流年风尘 | 我的前端之路
    
  </title>
<meta name="generator" content="Hexo 5.4.0"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--dark">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'dark';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Jason Luo&#39;s Golden House</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">HOME</a>
          </li>

          
          
          
          
          <li>
            <a href="/about/">
              
              ABOUT
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/archive/">
              
              ARCHIVES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              CATEGORIES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/tags/">
              
              TAGS
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>SEARCH</a>
          </li>
          

          <!-- LangSelect -->
          
          
          
          
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('/img/header_img/comic/about_stars3.jpg');
      --intro-header-background-image-url-post: url('/img/header_img/scenery/tree_stars.jpg');
      --intro-header-background-image-url-page: url('//img/header_img/scenery/tree_stars.jpg');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/comic/about_stars3.jpg');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/scenery/tree_stars.jpg');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('//img/header_img/scenery/tree_stars.jpg');
    }

    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('/img/header_img/scenery/tree_stars.jpg'); */
      
    }

    
      #signature {/*signature*/
        background-image: url('/img/signature/jasonluo-white.png');
      }
    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading" style="height: 200px;">
            <div class="tags">
              
              <a class="tag" href="/tags/#vue3源码" title="vue3源码">vue3源码</a>
              
              <a class="tag" href="/tags/#vue3" title="vue3">vue3</a>
              
            </div>
            <h1>[vue3 源码解读] AST生成可运行代码</h1>
            <h2 class="subheading"></h2>
            <span class="meta">
              Posted by Jason Luo on
              2021-09-25
            </span>


<!--            
            &lt;!&ndash; WordCount start &ndash;&gt;
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">42</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">9.2k</span> In Total
            </span>
            <div class="blank_box"></div>
            &lt;!&ndash; WordCount end &ndash;&gt;
            
            
            &lt;!&ndash; 不蒜子统计 start &ndash;&gt;
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            &lt;!&ndash; 不蒜子统计 end &ndash;&gt;
            -->


          </div>
          
        </div>
      </div>
    </div>
  </div>

  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <h3 id="源码地址">源码地址</h3>
<blockquote>
<p>本节课的相关代码在源代码中的位置如下：<br>
packages/compiler-core/src/codegen.ts<br>
packages/runtime-core/src/vnode.ts<br>
packages/runtime-core/src/renderer.ts</p>
</blockquote>
<p>上一节课我们分析了 AST 节点转换的过程，也知道了 AST 节点转换的作用是通过语法分析，创建了语义和信息更加丰富的代码生成节点 codegenNode，便于后续生成代码。</p>
<p>那么这一节课，我们就来分析整个编译的过程的最后一步——代码生成的实现原理。</p>
<p>同样的，代码生成阶段由于要处理的场景很多，所以代码也非常多而复杂。为了方便你理解它的核心流程，我们还是通过这个示例来演示整个代码生成的过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class&#x3D;&quot;app&quot;&gt;</span><br><span class="line">  &lt;hello v-if&#x3D;&quot;flag&quot;&gt;&lt;&#x2F;hello&gt;</span><br><span class="line">  &lt;div v-else&gt;</span><br><span class="line">    &lt;p&gt;hello &#123;&#123; msg + test &#125;&#125;&lt;&#x2F;p&gt;</span><br><span class="line">    &lt;p&gt;static&lt;&#x2F;p&gt;</span><br><span class="line">    &lt;p&gt;static&lt;&#x2F;p&gt;</span><br><span class="line">  &lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure>
<p>代码生成的结果是和编译配置相关的，你可以打开官方提供的<a target="_blank" rel="noopener" href="https://vue-next-template-explorer.netlify.app/">模板导出工具平台</a>，点击右上角的 Options 修改编译配置。为了让你理解核心的流程，这里我只分析一种配置方案，当然当你理解整个编译核心流程后，也可以修改这些配置分析其他的分支逻辑。</p>
<p>我们分析的编译配置是：mode 为 module，prefixIdentifiers 开启，hoistStatic 开启，其他配置均不开启。</p>
<p>为了让你有个大致印象，我们先来看一下上述例子生成代码的结果：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; resolveComponent <span class="keyword">as</span> _resolveComponent, createVNode <span class="keyword">as</span> _createVNode, createCommentVNode <span class="keyword">as</span> _createCommentVNode, toDisplayString <span class="keyword">as</span> _toDisplayString, openBlock <span class="keyword">as</span> _openBlock, createBlock <span class="keyword">as</span> _createBlock &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"><span class="keyword">const</span> _hoisted_1 = &#123; <span class="attr">class</span>: <span class="string">&quot;app&quot;</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_2 = &#123; <span class="attr">key</span>: <span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_3 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">const</span> _hoisted_4 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">_ctx, _cache</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> _component_hello = _resolveComponent(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> (_openBlock(), _createBlock(<span class="string">&quot;div&quot;</span>, _hoisted_1, [</span><br><span class="line">    (_ctx.flag)</span><br><span class="line">      ? _createVNode(_component_hello, &#123; <span class="attr">key</span>: <span class="number">0</span> &#125;)</span><br><span class="line">      : (_openBlock(), _createBlock(<span class="string">&quot;div&quot;</span>, _hoisted_2, [</span><br><span class="line">          _createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;hello &quot;</span> + _toDisplayString(_ctx.msg + _ctx.test), <span class="number">1</span> <span class="comment">/* TEXT */</span>),</span><br><span class="line">          _hoisted_3,</span><br><span class="line">          _hoisted_4</span><br><span class="line">        ]))</span><br><span class="line">  ]))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例的模板是如何转换生成这样的代码的？在 AST 转换后，会执行 generate 函数生成代码：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> generate(ast, extend(&#123;&#125;, options, &#123;</span><br><span class="line">  prefixIdentifiers</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>
<h3 id="generate-函数">generate 函数</h3>
<p>generate 函数的输入就是转换后的 AST 根节点，我们看一下它的实现：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generate</span>(<span class="params">ast, options = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 创建代码生成上下文</span></span><br><span class="line">  <span class="keyword">const</span> context = createCodegenContext(ast, options);</span><br><span class="line">  <span class="keyword">const</span> &#123; mode, push, prefixIdentifiers, indent, deindent, newline, scopeId, ssr &#125; = context;</span><br><span class="line">  <span class="keyword">const</span> hasHelpers = ast.helpers.length &gt; <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">const</span> useWithBlock = !prefixIdentifiers &amp;&amp; mode !== <span class="string">&#x27;module&#x27;</span>;</span><br><span class="line">  <span class="keyword">const</span> genScopeId = scopeId != <span class="literal">null</span> &amp;&amp; mode === <span class="string">&#x27;module&#x27;</span>;</span><br><span class="line">  <span class="comment">// 生成预设代码</span></span><br><span class="line">  <span class="keyword">if</span> ( mode === <span class="string">&#x27;module&#x27;</span>) &#123;</span><br><span class="line">    genModulePreamble(ast, context, genScopeId);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    genFunctionPreamble(ast, context);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!ssr) &#123;</span><br><span class="line">    push(<span class="string">`function render(_ctx, _cache) &#123;`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    push(<span class="string">`function ssrRender(_ctx, _push, _parent, _attrs) &#123;`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  indent();</span><br><span class="line">  <span class="keyword">if</span> (useWithBlock) &#123;</span><br><span class="line">    <span class="comment">// 处理带 with 的情况，Web 端运行时编译</span></span><br><span class="line">    push(<span class="string">`with (_ctx) &#123;`</span>);</span><br><span class="line">    indent();</span><br><span class="line">    <span class="keyword">if</span> (hasHelpers) &#123;</span><br><span class="line">      push(<span class="string">`const &#123; <span class="subst">$&#123;ast.helpers</span></span></span><br><span class="line"><span class="string"><span class="subst">        .map(s =&gt; <span class="string">`<span class="subst">$&#123;helperNameMap[s]&#125;</span>: _<span class="subst">$&#123;helperNameMap[s]&#125;</span>`</span>)</span></span></span><br><span class="line"><span class="string"><span class="subst">        .join(<span class="string">&#x27;, &#x27;</span>)&#125;</span> &#125; = _Vue`</span>);</span><br><span class="line">      push(<span class="string">`\n`</span>);</span><br><span class="line">      newline();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 生成自定义组件声明代码</span></span><br><span class="line">  <span class="keyword">if</span> (ast.components.length) &#123;</span><br><span class="line">    genAssets(ast.components, <span class="string">&#x27;component&#x27;</span>, context);</span><br><span class="line">    <span class="keyword">if</span> (ast.directives.length || ast.temps &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      newline();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 生成自定义指令声明代码</span></span><br><span class="line">  <span class="keyword">if</span> (ast.directives.length) &#123;</span><br><span class="line">    genAssets(ast.directives, <span class="string">&#x27;directive&#x27;</span>, context);</span><br><span class="line">    <span class="keyword">if</span> (ast.temps &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      newline();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 生成临时变量代码</span></span><br><span class="line">  <span class="keyword">if</span> (ast.temps &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    push(<span class="string">`let `</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; ast.temps; i++) &#123;</span><br><span class="line">      push(<span class="string">`<span class="subst">$&#123;i &gt; <span class="number">0</span> ? <span class="string">`, `</span> : <span class="string">``</span>&#125;</span>_temp<span class="subst">$&#123;i&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (ast.components.length || ast.directives.length || ast.temps) &#123;</span><br><span class="line">    push(<span class="string">`\n`</span>);</span><br><span class="line">    newline();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!ssr) &#123;</span><br><span class="line">    push(<span class="string">`return `</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 生成创建 VNode 树的表达式</span></span><br><span class="line">  <span class="keyword">if</span> (ast.codegenNode) &#123;</span><br><span class="line">    genNode(ast.codegenNode, context);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    push(<span class="string">`null`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (useWithBlock) &#123;</span><br><span class="line">    deindent();</span><br><span class="line">    push(<span class="string">`&#125;`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  deindent();</span><br><span class="line">  push(<span class="string">`&#125;`</span>);</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ast,</span><br><span class="line">    code: context.code,</span><br><span class="line">    map: context.map ? context.map.toJSON() : <span class="literal">undefined</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>generate 主要做五件事情：</p>
<ul>
<li>创建代码生成上下文</li>
<li>生成预设代码</li>
<li>生成渲染函数</li>
<li>生成资源声明代码</li>
<li>生成创建 VNode 树的表达式</li>
</ul>
<h4 id="创建代码生成上下文">创建代码生成上下文</h4>
<p>首先，是通过执行 createCodegenContext 创建代码生成上下文，我们来看它的实现：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createCodegenContext</span>(<span class="params">ast, &#123; mode = <span class="string">&#x27;function&#x27;</span>, prefixIdentifiers = mode === <span class="string">&#x27;module&#x27;</span>, sourceMap = <span class="literal">false</span>, filename = <span class="string">`template.vue.html`</span>, scopeId = <span class="literal">null</span>, optimizeBindings = <span class="literal">false</span>, runtimeGlobalName = <span class="string">`Vue`</span>, runtimeModuleName = <span class="string">`vue`</span>, ssr = <span class="literal">false</span> &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> context = &#123;</span><br><span class="line">    mode,</span><br><span class="line">    prefixIdentifiers,</span><br><span class="line">    sourceMap,</span><br><span class="line">    filename,</span><br><span class="line">    scopeId,</span><br><span class="line">    optimizeBindings,</span><br><span class="line">    runtimeGlobalName,</span><br><span class="line">    runtimeModuleName,</span><br><span class="line">    ssr,</span><br><span class="line">    source: ast.loc.source,</span><br><span class="line">    code: <span class="string">``</span>,</span><br><span class="line">    column: <span class="number">1</span>,</span><br><span class="line">    line: <span class="number">1</span>,</span><br><span class="line">    offset: <span class="number">0</span>,</span><br><span class="line">    indentLevel: <span class="number">0</span>,</span><br><span class="line">    pure: <span class="literal">false</span>,</span><br><span class="line">    map: <span class="literal">undefined</span>,</span><br><span class="line">    <span class="function"><span class="title">helper</span>(<span class="params">key</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">`_<span class="subst">$&#123;helperNameMap[key]&#125;</span>`</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">push</span>(<span class="params">code</span>)</span> &#123;</span><br><span class="line">      context.code += code</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">indent</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      newline(++context.indentLevel)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">deindent</span>(<span class="params">withoutNewLine = <span class="literal">false</span></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (withoutNewLine) &#123;</span><br><span class="line">        --context.indentLevel</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        newline(--context.indentLevel)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">newline</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      newline(context.indentLevel)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">newline</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">    context.push(<span class="string">&#x27;\n&#x27;</span> + <span class="string">`  `</span>.repeat(n))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> context</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个上下文对象 context 维护了 generate 过程的一些配置，比如 mode、prefixIdentifiers；也维护了 generate 过程的一些状态数据，比如当前生成的代码 code，当前生成代码的缩进 indentLevel 等。</p>
<p>此外，context 还包含了在 generate 过程中可能会调用的一些辅助函数，接下来我会介绍几个常用的方法，它们会在整个代码生成节点过程中经常被用到。</p>
<ul>
<li>
<p>push(code)，就是在当前的代码 context.code 后追加 code 来更新它的值。</p>
</li>
<li>
<p>indent()，它的作用就是增加代码的缩进，它会让上下文维护的代码缩进 context.indentLevel 加 1，内部会执行 newline 方法，添加一个换行符，以及两倍indentLevel 对应的空格来表示缩进的长度。</p>
</li>
<li>
<p>deindent()，和 indent 相反，它会减少代码的缩进，让上下文维护的代码缩进 context.indentLevel 减 1，在内部会执行 newline 方法去添加一个换行符，并减少两倍indentLevel 对应的空格的缩进长度。</p>
</li>
</ul>
<p>上下文创建完毕后，接下来就到了真正的代码生成阶段，在分析的过程中我会结合示例讲解，让你更直观地理解整个代码的生成过程，我们先来看生成预设代码。</p>
<h4 id="生成预设代码">生成预设代码</h4>
<p>如果 mode 是 module，所以会执行 genModulePreamble 生成预设代码，我们来看它的实现：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genModulePreamble</span>(<span class="params">ast, context, genScopeId</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; push, newline, optimizeBindings, runtimeModuleName &#125; = context</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 处理 scopeId</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (ast.helpers.length) &#123;</span><br><span class="line">     <span class="comment">// 生成 import 声明代码</span></span><br><span class="line">    <span class="keyword">if</span> (optimizeBindings) &#123;</span><br><span class="line">      push(<span class="string">`import &#123; <span class="subst">$&#123;ast.helpers</span></span></span><br><span class="line"><span class="string"><span class="subst">        .map(s =&gt; helperNameMap[s])</span></span></span><br><span class="line"><span class="string"><span class="subst">        .join(<span class="string">&#x27;, &#x27;</span>)&#125;</span> &#125; from <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(runtimeModuleName)&#125;</span>\n`</span>)</span><br><span class="line">      push(<span class="string">`\n// Binding optimization for webpack code-split\nconst <span class="subst">$&#123;ast.helpers</span></span></span><br><span class="line"><span class="string"><span class="subst">        .map(s =&gt; <span class="string">`_<span class="subst">$&#123;helperNameMap[s]&#125;</span> = <span class="subst">$&#123;helperNameMap[s]&#125;</span>`</span>)</span></span></span><br><span class="line"><span class="string"><span class="subst">        .join(<span class="string">&#x27;, &#x27;</span>)&#125;</span>\n`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      push(<span class="string">`import &#123; <span class="subst">$&#123;ast.helpers</span></span></span><br><span class="line"><span class="string"><span class="subst">        .map(s =&gt; <span class="string">`<span class="subst">$&#123;helperNameMap[s]&#125;</span> as _<span class="subst">$&#123;helperNameMap[s]&#125;</span>`</span>)</span></span></span><br><span class="line"><span class="string"><span class="subst">        .join(<span class="string">&#x27;, &#x27;</span>)&#125;</span> &#125; from <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(runtimeModuleName)&#125;</span>\n`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 处理 ssrHelpers</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 处理 imports</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 处理 scopeId</span></span><br><span class="line">  </span><br><span class="line">  genHoists(ast.hoists, context)</span><br><span class="line">  newline()</span><br><span class="line">  push(<span class="string">`export `</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面我们结合前面的示例来分析这个过程，此时 genScopeId 为 false，所以相关逻辑我们可以不看。ast.helpers 是在 transform 阶段通过 context.helper 方法添加的，它的值如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  <span class="built_in">Symbol</span>(resolveComponent),</span><br><span class="line">  <span class="built_in">Symbol</span>(createVNode),</span><br><span class="line">  <span class="built_in">Symbol</span>(createCommentVNode),</span><br><span class="line">  <span class="built_in">Symbol</span>(toDisplayString),</span><br><span class="line">  <span class="built_in">Symbol</span>(openBlock),</span><br><span class="line">  <span class="built_in">Symbol</span>(createBlock)</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>ast.helpers 存储了 Symbol 对象的数组，我们可以从 helperNameMap 中找到每个 Symbol 对象对应的字符串，helperNameMap 的定义如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> helperNameMap = &#123;</span><br><span class="line">  [FRAGMENT]: <span class="string">`Fragment`</span>,</span><br><span class="line">  [TELEPORT]: <span class="string">`Teleport`</span>,</span><br><span class="line">  [SUSPENSE]: <span class="string">`Suspense`</span>,</span><br><span class="line">  [KEEP_ALIVE]: <span class="string">`KeepAlive`</span>,</span><br><span class="line">  [BASE_TRANSITION]: <span class="string">`BaseTransition`</span>,</span><br><span class="line">  [OPEN_BLOCK]: <span class="string">`openBlock`</span>,</span><br><span class="line">  [CREATE_BLOCK]: <span class="string">`createBlock`</span>,</span><br><span class="line">  [CREATE_VNODE]: <span class="string">`createVNode`</span>,</span><br><span class="line">  [CREATE_COMMENT]: <span class="string">`createCommentVNode`</span>,</span><br><span class="line">  [CREATE_TEXT]: <span class="string">`createTextVNode`</span>,</span><br><span class="line">  [CREATE_STATIC]: <span class="string">`createStaticVNode`</span>,</span><br><span class="line">  [RESOLVE_COMPONENT]: <span class="string">`resolveComponent`</span>,</span><br><span class="line">  [RESOLVE_DYNAMIC_COMPONENT]: <span class="string">`resolveDynamicComponent`</span>,</span><br><span class="line">  [RESOLVE_DIRECTIVE]: <span class="string">`resolveDirective`</span>,</span><br><span class="line">  [WITH_DIRECTIVES]: <span class="string">`withDirectives`</span>,</span><br><span class="line">  [RENDER_LIST]: <span class="string">`renderList`</span>,</span><br><span class="line">  [RENDER_SLOT]: <span class="string">`renderSlot`</span>,</span><br><span class="line">  [CREATE_SLOTS]: <span class="string">`createSlots`</span>,</span><br><span class="line">  [TO_DISPLAY_STRING]: <span class="string">`toDisplayString`</span>,</span><br><span class="line">  [MERGE_PROPS]: <span class="string">`mergeProps`</span>,</span><br><span class="line">  [TO_HANDLERS]: <span class="string">`toHandlers`</span>,</span><br><span class="line">  [CAMELIZE]: <span class="string">`camelize`</span>,</span><br><span class="line">  [SET_BLOCK_TRACKING]: <span class="string">`setBlockTracking`</span>,</span><br><span class="line">  [PUSH_SCOPE_ID]: <span class="string">`pushScopeId`</span>,</span><br><span class="line">  [POP_SCOPE_ID]: <span class="string">`popScopeId`</span>,</span><br><span class="line">  [WITH_SCOPE_ID]: <span class="string">`withScopeId`</span>,</span><br><span class="line">  [WITH_CTX]: <span class="string">`withCtx`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于 optimizeBindings 是 false，所以会执行如下代码：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">push(<span class="string">`import &#123; <span class="subst">$&#123;ast.helpers</span></span></span><br><span class="line"><span class="string"><span class="subst">  .map(s =&gt; <span class="string">`<span class="subst">$&#123;helperNameMap[s]&#125;</span> as _<span class="subst">$&#123;helperNameMap[s]&#125;</span>`</span>)</span></span></span><br><span class="line"><span class="string"><span class="subst">  .join(<span class="string">&#x27;, &#x27;</span>)&#125;</span> &#125; from <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(runtimeModuleName)&#125;</span>\n`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终会生成这些代码，并更新到 context.code 中：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; resolveComponent <span class="keyword">as</span> _resolveComponent, createVNode <span class="keyword">as</span> _createVNode, createCommentVNode <span class="keyword">as</span> _createCommentVNode, toDisplayString <span class="keyword">as</span> _toDisplayString, openBlock <span class="keyword">as</span> _openBlock, createBlock <span class="keyword">as</span> _createBlock &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br></pre></td></tr></table></figure>
<p>通过生成的代码，我们可以直观地感受到，这里就是从 Vue 中引入了一些辅助方法，那么为什么需要引入这些辅助方法呢，这就和 Vue.js 3.0 的设计有关了。</p>
<p>在 Vue.js 2.x 中，创建 VNode 的方法比如 $createElement、_c 这些都是挂载在组件的实例上，在生成渲染函数的时候，直接从组件实例 vm 中访问这些方法即可。</p>
<p>而到了 Vue.js 3.0，创建 VNode 的方法 createVNode 是直接通过模块的方式导出，其它方法比如 resolveComponent、openBlock ，都是类似的，所以我们首先需要生成这些 import 声明的预设代码。</p>
<p>我们接着往下看，ssrHelpers 是 undefined，imports 的数组长度为空，genScopeId 为 false，所以这些内部逻辑都不会执行，接着执行 genHoists 生成静态提升的相关代码，我们来看它的实现：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genHoists</span>(<span class="params">hoists, context</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!hoists.length) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  context.pure = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">const</span> &#123; push, newline &#125; = context</span><br><span class="line">  </span><br><span class="line">  newline()</span><br><span class="line">  hoists.forEach(<span class="function">(<span class="params">exp, i</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (exp) &#123;</span><br><span class="line">      push(<span class="string">`const _hoisted_<span class="subst">$&#123;i + <span class="number">1</span>&#125;</span> = `</span>)</span><br><span class="line">      genNode(exp, context)</span><br><span class="line">      newline()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  </span><br><span class="line">  context.pure = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先通过执行 newline 生成一个空行，然后遍历 hoists 数组，生成静态提升变量定义的方法。此时 hoists 的值是这样的：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="number">15</span>, <span class="comment">/* JS_OBJECT_EXPRESSION */</span></span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="number">16</span>, <span class="comment">/* JS_PROPERTY */</span></span><br><span class="line">        <span class="string">&quot;key&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="number">4</span>, <span class="comment">/* SIMPLE_EXPRESSION */</span></span><br><span class="line">          <span class="string">&quot;isConstant&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="string">&quot;content&quot;</span>: <span class="string">&quot;class&quot;</span>,</span><br><span class="line">          <span class="string">&quot;isStatic&quot;</span>: <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="number">4</span>, <span class="comment">/* SIMPLE_EXPRESSION */</span></span><br><span class="line">          <span class="string">&quot;isConstant&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="string">&quot;content&quot;</span>: <span class="string">&quot;app&quot;</span>,</span><br><span class="line">          <span class="string">&quot;isStatic&quot;</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="number">15</span>, <span class="comment">/* JS_OBJECT_EXPRESSION */</span></span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="number">16</span>, <span class="comment">/* JS_PROPERTY */</span></span><br><span class="line">        <span class="string">&quot;key&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="number">4</span>, <span class="comment">/* SIMPLE_EXPRESSION */</span></span><br><span class="line">          <span class="string">&quot;isConstant&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="string">&quot;content&quot;</span>: <span class="string">&quot;key&quot;</span>,</span><br><span class="line">          <span class="string">&quot;isStatic&quot;</span>: <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="number">4</span>, <span class="comment">/* SIMPLE_EXPRESSION */</span></span><br><span class="line">          <span class="string">&quot;isConstant&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="string">&quot;content&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">          <span class="string">&quot;isStatic&quot;</span>: <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="number">13</span>, <span class="comment">/* VNODE_CALL */</span></span><br><span class="line">    <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;\&quot;p\&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;children&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="number">2</span>, <span class="comment">/* ELEMENT */</span></span><br><span class="line">      <span class="string">&quot;content&quot;</span>: <span class="string">&quot;static&quot;</span></span><br><span class="line">    &#125;,                                                  </span><br><span class="line">    <span class="string">&quot;patchFlag&quot;</span>: <span class="string">&quot;-1 /* HOISTED */&quot;</span>,</span><br><span class="line">    <span class="string">&quot;isBlock&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;disableTracking&quot;</span>: <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="number">13</span>, <span class="comment">/* VNODE_CALL */</span></span><br><span class="line">    <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;\&quot;p\&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;children&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="number">2</span>, <span class="comment">/* ELEMENT */</span></span><br><span class="line">      <span class="string">&quot;content&quot;</span>: <span class="string">&quot;static&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;patchFlag&quot;</span>: <span class="string">&quot;-1 /* HOISTED */&quot;</span>,</span><br><span class="line">    <span class="string">&quot;isBlock&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;disableTracking&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>这里，hoists 数组的长度为 4，前两个都是 JavaScript 对象表达式节点，后两个是 VNodeCall 节点，通过 genNode 我们可以把这些节点生成对应的代码，这个方法我们后续会详细说明，这里先略过。</p>
<p>然后通过遍历 hoists 我们生成如下代码：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; resolveComponent <span class="keyword">as</span> _resolveComponent, createVNode <span class="keyword">as</span> _createVNode, createCommentVNode <span class="keyword">as</span> _createCommentVNode, toDisplayString <span class="keyword">as</span> _toDisplayString, openBlock <span class="keyword">as</span> _openBlock, createBlock <span class="keyword">as</span> _createBlock &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"><span class="keyword">const</span> _hoisted_1 = &#123; <span class="attr">class</span>: <span class="string">&quot;app&quot;</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_2 = &#123; <span class="attr">key</span>: <span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_3 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">const</span> _hoisted_4 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br></pre></td></tr></table></figure>
<p>可以看到，除了从 Vue 中导入辅助方法，我们还创建了静态提升的变量。</p>
<p>我们回到 genModulePreamble，接着会执行newline()和push(export )，非常好理解，也就是添加了一个空行和 export 字符串。</p>
<p>至此，预设代码生成完毕，我们就得到了这些代码：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; resolveComponent <span class="keyword">as</span> _resolveComponent, createVNode <span class="keyword">as</span> _createVNode, createCommentVNode <span class="keyword">as</span> _createCommentVNode, toDisplayString <span class="keyword">as</span> _toDisplayString, openBlock <span class="keyword">as</span> _openBlock, createBlock <span class="keyword">as</span> _createBlock &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"><span class="keyword">const</span> _hoisted_1 = &#123; <span class="attr">class</span>: <span class="string">&quot;app&quot;</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_2 = &#123; <span class="attr">key</span>: <span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_3 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">const</span> _hoisted_4 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">export</span> </span><br></pre></td></tr></table></figure>
<h4 id="生成渲染函数">生成渲染函数</h4>
<p>接下来，就是生成渲染函数了，我们回到 generate 函数：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!ssr) &#123;</span><br><span class="line">push(<span class="string">`function render(_ctx, _cache) &#123;`</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">push(<span class="string">`function ssrRender(_ctx, _push, _parent, _attrs) &#123;`</span>);</span><br><span class="line">&#125;</span><br><span class="line">indent();</span><br></pre></td></tr></table></figure>
<p>由于 ssr 为 false, 所以生成如下代码：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; resolveComponent <span class="keyword">as</span> _resolveComponent, createVNode <span class="keyword">as</span> _createVNode, createCommentVNode <span class="keyword">as</span> _createCommentVNode, toDisplayString <span class="keyword">as</span> _toDisplayString, openBlock <span class="keyword">as</span> _openBlock, createBlock <span class="keyword">as</span> _createBlock &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"><span class="keyword">const</span> _hoisted_1 = &#123; <span class="attr">class</span>: <span class="string">&quot;app&quot;</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_2 = &#123; <span class="attr">key</span>: <span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_3 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">const</span> _hoisted_4 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">_ctx, _cache</span>) </span>&#123;  </span><br></pre></td></tr></table></figure>
<p>注意，<strong>这里代码的最后一行有 2 个空格的缩进</strong>。</p>
<p>另外，由于 useWithBlock 为 false，所以我们也不需生成 with 相关的代码。而且，这里我们创建了 render 的函数声明，接下来的代码都是在生成 render 的函数体。</p>
<h4 id="生成资源声明代码">生成资源声明代码</h4>
<p>在 render 函数体的内部，我们首先要生成资源声明代码：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成自定义组件声明代码</span></span><br><span class="line"><span class="keyword">if</span> (ast.components.length) &#123;</span><br><span class="line">  genAssets(ast.components, <span class="string">&#x27;component&#x27;</span>, context);</span><br><span class="line">  <span class="keyword">if</span> (ast.directives.length || ast.temps &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    newline();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 生成自定义指令声明代码</span></span><br><span class="line"><span class="keyword">if</span> (ast.directives.length) &#123;</span><br><span class="line">  genAssets(ast.directives, <span class="string">&#x27;directive&#x27;</span>, context);</span><br><span class="line">  <span class="keyword">if</span> (ast.temps &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    newline();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 生成临时变量代码</span></span><br><span class="line"><span class="keyword">if</span> (ast.temps &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  push(<span class="string">`let `</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; ast.temps; i++) &#123;</span><br><span class="line">    push(<span class="string">`<span class="subst">$&#123;i &gt; <span class="number">0</span> ? <span class="string">`, `</span> : <span class="string">``</span>&#125;</span>_temp<span class="subst">$&#123;i&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在我们的示例中，directives 数组长度为 0，temps 的值是 0，所以自定义指令和临时变量代码生成的相关逻辑跳过，而这里 components的值是[“hello”]。</p>
<p>接着就通过 genAssets 去生成自定义组件声明代码，我们来看一下它的实现：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genAssets</span>(<span class="params">assets, <span class="keyword">type</span>, &#123; helper, push, newline &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> resolver = helper(<span class="keyword">type</span> === <span class="string">&#x27;component&#x27;</span> ? RESOLVE_COMPONENT : RESOLVE_DIRECTIVE)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; assets.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> id = assets[i]</span><br><span class="line">    push(<span class="string">`const <span class="subst">$&#123;toValidAssetId(id, <span class="keyword">type</span>)&#125;</span> = <span class="subst">$&#123;resolver&#125;</span>(<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(id)&#125;</span>)`</span>)</span><br><span class="line">    <span class="keyword">if</span> (i &lt; assets.length - <span class="number">1</span>) &#123;</span><br><span class="line">      newline()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 helper 函数就是从前面提到的 helperNameMap 中查找对应的字符串，对于 component，返回的就是 resolveComponent。</p>
<p>接着会遍历 assets 数组，生成自定义组件声明代码，在这个过程中，它们会把变量通过 toValidAssetId 进行一层包装：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toValidAssetId</span>(<span class="params">name, <span class="keyword">type</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`_<span class="subst">$&#123;<span class="keyword">type</span>&#125;</span>_<span class="subst">$&#123;name.replace(<span class="regexp">/[^\w]/g</span>, <span class="string">&#x27;_&#x27;</span>)&#125;</span>`</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>比如 hello 组件，执行 toValidAssetId 就变成了 _component_hello。</p>
<p>因此对于我们的示例而言，genAssets 后生成的代码是这样的：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; resolveComponent <span class="keyword">as</span> _resolveComponent, createVNode <span class="keyword">as</span> _createVNode, createCommentVNode <span class="keyword">as</span> _createCommentVNode, toDisplayString <span class="keyword">as</span> _toDisplayString, openBlock <span class="keyword">as</span> _openBlock, createBlock <span class="keyword">as</span> _createBlock &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"><span class="keyword">const</span> _hoisted_1 = &#123; <span class="attr">class</span>: <span class="string">&quot;app&quot;</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_2 = &#123; <span class="attr">key</span>: <span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_3 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">const</span> _hoisted_4 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">_ctx, _cache</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> _component_hello = _resolveComponent(<span class="string">&quot;hello&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>这很好理解，通过 resolveComponent，我们就可以解析到注册的自定义组件对象，然后在后面创建组件 vnode 的时候当做参数传入。</p>
<p>回到 generate 函数，接下来会执行如下代码：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ast.components.length || ast.directives.length || ast.temps) &#123;</span><br><span class="line">  push(<span class="string">`\n`</span>);</span><br><span class="line">  newline();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!ssr) &#123;</span><br><span class="line">  push(<span class="string">`return `</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里是指，如果生成了资源声明代码，则在尾部添加一个换行符，然后再生成一个空行，并且如果不是 ssr，则再添加一个 return 字符串，此时得到的代码结果如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; resolveComponent <span class="keyword">as</span> _resolveComponent, createVNode <span class="keyword">as</span> _createVNode, createCommentVNode <span class="keyword">as</span> _createCommentVNode, toDisplayString <span class="keyword">as</span> _toDisplayString, openBlock <span class="keyword">as</span> _openBlock, createBlock <span class="keyword">as</span> _createBlock &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"><span class="keyword">const</span> _hoisted_1 = &#123; <span class="attr">class</span>: <span class="string">&quot;app&quot;</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_2 = &#123; <span class="attr">key</span>: <span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_3 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">const</span> _hoisted_4 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">_ctx, _cache</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> _component_hello = _resolveComponent(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> </span><br></pre></td></tr></table></figure>
<h4 id="生成创建-VNode-树的表达式">生成创建 VNode 树的表达式</h4>
<p>我们先来看它的实现：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成创建 VNode 树的表达式</span></span><br><span class="line"><span class="keyword">if</span> (ast.codegenNode) &#123;</span><br><span class="line">  genNode(ast.codegenNode, context);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  push(<span class="string">`null`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>前面我们在转换过程中给根节点添加了 codegenNode，所以接下来就是通过 genNode 生成创建 VNode 树的表达式，我们来看它的实现：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genNode</span>(<span class="params">node, context</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (shared.isString(node)) &#123;</span><br><span class="line">    context.push(node)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (shared.isSymbol(node)) &#123;</span><br><span class="line">    context.push(context.helper(node))</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">switch</span> (node.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span> <span class="comment">/* ELEMENT */</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">9</span> <span class="comment">/* IF */</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">11</span> <span class="comment">/* FOR */</span>:</span><br><span class="line">      genNode(node.codegenNode, context)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span> <span class="comment">/* TEXT */</span>:</span><br><span class="line">      genText(node, context)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span> <span class="comment">/* SIMPLE_EXPRESSION */</span>:</span><br><span class="line">      genExpression(node, context)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">5</span> <span class="comment">/* INTERPOLATION */</span>:</span><br><span class="line">      genInterpolation(node, context)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">12</span> <span class="comment">/* TEXT_CALL */</span>:</span><br><span class="line">      genNode(node.codegenNode, context)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">8</span> <span class="comment">/* COMPOUND_EXPRESSION */</span>:</span><br><span class="line">      genCompoundExpression(node, context)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span> <span class="comment">/* COMMENT */</span>:</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">13</span> <span class="comment">/* VNODE_CALL */</span>:</span><br><span class="line">      genVNodeCall(node, context)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">14</span> <span class="comment">/* JS_CALL_EXPRESSION */</span>:</span><br><span class="line">      genCallExpression(node, context)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">15</span> <span class="comment">/* JS_OBJECT_EXPRESSION */</span>:</span><br><span class="line">      genObjectExpression(node, context)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">17</span> <span class="comment">/* JS_ARRAY_EXPRESSION */</span>:</span><br><span class="line">      genArrayExpression(node, context)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">18</span> <span class="comment">/* JS_FUNCTION_EXPRESSION */</span>:</span><br><span class="line">      genFunctionExpression(node, context)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">19</span> <span class="comment">/* JS_CONDITIONAL_EXPRESSION */</span>:</span><br><span class="line">      genConditionalExpression(node, context)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">20</span> <span class="comment">/* JS_CACHE_EXPRESSION */</span>:</span><br><span class="line">      genCacheExpression(node, context)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="comment">// SSR only types</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">21</span> <span class="comment">/* JS_BLOCK_STATEMENT */</span>:</span><br><span class="line">      genNodeList(node.body, context, <span class="literal">true</span>, <span class="literal">false</span>)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">22</span> <span class="comment">/* JS_TEMPLATE_LITERAL */</span>:</span><br><span class="line">      genTemplateLiteral(node, context)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">23</span> <span class="comment">/* JS_IF_STATEMENT */</span>:</span><br><span class="line">      genIfStatement(node, context)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">24</span> <span class="comment">/* JS_ASSIGNMENT_EXPRESSION */</span>:</span><br><span class="line">      genAssignmentExpression(node, context)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">25</span> <span class="comment">/* JS_SEQUENCE_EXPRESSION */</span>:</span><br><span class="line">      genSequenceExpression(node, context)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">26</span> <span class="comment">/* JS_RETURN_STATEMENT */</span>:</span><br><span class="line">      genReturnStatement(node, context)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>genNode 主要的思路就是根据不同的节点类型，生成不同的代码，这里有十几种情况，我就不全部讲一遍了，仍然是以我们的示例为主，来分析它们的实现，没有分析到的分支我的建议是大致了解即可，未来如果遇到相关的场景，你再来详细看它们的实现也不迟。</p>
<p>现在，我们来看一下根节点 codegenNode 的值：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="keyword">type</span>: <span class="number">13</span>, <span class="comment">/* VNODE_CALL */</span></span><br><span class="line">  tag: <span class="string">&quot;div&quot;</span>,</span><br><span class="line">  children: [</span><br><span class="line">    <span class="comment">// 子节点</span></span><br><span class="line">  ],</span><br><span class="line">  props: &#123;</span><br><span class="line">    <span class="comment">// 属性表达式节点</span></span><br><span class="line">  &#125;,</span><br><span class="line">  directives: <span class="literal">undefined</span>,</span><br><span class="line">  disableTracking: <span class="literal">false</span>,</span><br><span class="line">  dynamicProps: <span class="literal">undefined</span>,</span><br><span class="line">  isBlock: <span class="literal">true</span>,</span><br><span class="line">  patchFlag: <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于根节点的 codegenNode 类型是 13，也就是一个 VNodeCall，所以会执行 genVNodeCall 生成创建 VNode 节点的表达式代码，它的实现如下 :</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genVNodeCall</span>(<span class="params">node, context</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; push, helper, pure &#125; = context</span><br><span class="line">  <span class="keyword">const</span> &#123; tag, props, children, patchFlag, dynamicProps, directives, isBlock, disableTracking &#125; = node</span><br><span class="line">  <span class="keyword">if</span> (directives) &#123;</span><br><span class="line">    push(helper(WITH_DIRECTIVES) + <span class="string">`(`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isBlock) &#123;</span><br><span class="line">    push(<span class="string">`(<span class="subst">$&#123;helper(OPEN_BLOCK)&#125;</span>(<span class="subst">$&#123;disableTracking ? <span class="string">`true`</span> : <span class="string">``</span>&#125;</span>), `</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (pure) &#123;</span><br><span class="line">    push(PURE_ANNOTATION)</span><br><span class="line">  &#125;</span><br><span class="line">  push(helper(isBlock ? CREATE_BLOCK : CREATE_VNODE) + <span class="string">`(`</span>, node)</span><br><span class="line">  genNodeList(genNullableArgs([tag, props, children, patchFlag, dynamicProps]), context)</span><br><span class="line">  push(<span class="string">`)`</span>)</span><br><span class="line">  <span class="keyword">if</span> (isBlock) &#123;</span><br><span class="line">    push(<span class="string">`)`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (directives) &#123;</span><br><span class="line">    push(<span class="string">`, `</span>)</span><br><span class="line">    genNode(directives, context)</span><br><span class="line">    push(<span class="string">`)`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据我们的示例来看，directives 没定义，不用处理，isBlock 为 true，disableTracking 为 false，那么生成如下打开 Block 的代码：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; resolveComponent <span class="keyword">as</span> _resolveComponent, createVNode <span class="keyword">as</span> _createVNode, createCommentVNode <span class="keyword">as</span> _createCommentVNode, toDisplayString <span class="keyword">as</span> _toDisplayString, openBlock <span class="keyword">as</span> _openBlock, createBlock <span class="keyword">as</span> _createBlock &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"><span class="keyword">const</span> _hoisted_1 = &#123; <span class="attr">class</span>: <span class="string">&quot;app&quot;</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_2 = &#123; <span class="attr">key</span>: <span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_3 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">const</span> _hoisted_4 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">_ctx, _cache</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> _component_hello = _resolveComponent(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> (_openBlock()</span><br></pre></td></tr></table></figure>
<p>接着往下看，会判断 pure 是否为 true，如果是则生成相关的注释，虽然这里的 pure 为 false，但是之前我们在生成静态提升变量相关代码的时候 pure 为 true，所以生成了注释代码 /#PURE/。</p>
<p>接下来会判断 isBlock，如果它为 true 则在生成创建 Block 相关代码，如果它为 false，则生成创建 VNode 的相关代码。</p>
<p>因为这里 isBlock 为 true，所以生成如下代码：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; resolveComponent <span class="keyword">as</span> _resolveComponent, createVNode <span class="keyword">as</span> _createVNode, createCommentVNode <span class="keyword">as</span> _createCommentVNode, toDisplayString <span class="keyword">as</span> _toDisplayString, openBlock <span class="keyword">as</span> _openBlock, createBlock <span class="keyword">as</span> _createBlock &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"><span class="keyword">const</span> _hoisted_1 = &#123; <span class="attr">class</span>: <span class="string">&quot;app&quot;</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_2 = &#123; <span class="attr">key</span>: <span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_3 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">const</span> _hoisted_4 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">_ctx, _cache</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> _component_hello = _resolveComponent(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> (_openBlock(), _createBlock(</span><br></pre></td></tr></table></figure>
<p>生成了一个_createBlock 的函数调用后，下面就需要生成函数的参数，通过如下代码生成：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">genNodeList(genNullableArgs([tag, props, children, patchFlag, dynamicProps]), context)</span><br></pre></td></tr></table></figure>
<p>依据代码的执行顺序，我们先来看 genNullableArgs 的实现：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genNullableArgs</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> i = args.length</span><br><span class="line">  <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">    <span class="keyword">if</span> (args[i] != <span class="literal">null</span>)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> args.slice(<span class="number">0</span>, i + <span class="number">1</span>).map(<span class="function"><span class="params">arg</span> =&gt;</span> arg || <span class="string">`null`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法很简单，就是倒序遍历参数数组，找到第一个不为空的参数，然后返回该参数前面的所有参数构成的新数组。</p>
<p>genNullableArgs 传入的参数数组依次是 tag、props、children、patchFlag 和 dynamicProps，对于我们的示例而言，此时 patchFlag 和 dynamicProps 为 undefined，所以 genNullableArgs 返回的是一个[tag, props, children]这样的数组。</p>
<p>其实这是很好理解的，对于一个 vnode 节点而言，构成它的主要几个部分就是节点的标签 tag，属性 props 以及子节点 children，我们的目标就是生成类似下面的代码：_createBlock(tag, props, children)。</p>
<p>因此接下来，我们再通过 genNodeList 来生成参数相关的代码，来看一下它的实现：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genNodeList</span>(<span class="params">nodes, context, multilines = <span class="literal">false</span>, comma = <span class="literal">true</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; push, newline &#125; = context</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; nodes.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> node = nodes[i]</span><br><span class="line">    <span class="keyword">if</span> (shared.isString(node)) &#123;</span><br><span class="line">      push(node)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (shared.isArray(node)) &#123;</span><br><span class="line">      genNodeListAsArray(node, context)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      genNode(node, context)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (i &lt; nodes.length - <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (multilines) &#123;</span><br><span class="line">        comma &amp;&amp; push(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">        newline()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        comma &amp;&amp; push(<span class="string">&#x27;, &#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>genNodeList 就是通过遍历 nodes，拿到每一个 node，然后判断 node 的类型，如果 node 是字符串，就直接添加到代码中；如果是一个数组，则执行 genNodeListAsArray 生成数组形式的代码，否则是一个对象，则递归执行 genNode 生成节点代码。</p>
<p>我们还是根据示例代码走完这个流程，此时 nodes 的值如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">&#x27;div&#x27;</span>, &#123;</span><br><span class="line">  <span class="keyword">type</span>: <span class="number">4</span>, <span class="comment">/* SIMPLE_EXPRESSION */</span></span><br><span class="line">  content: <span class="string">&#x27;_hoisted_1&#x27;</span>,</span><br><span class="line">  isConstant: <span class="literal">true</span>,</span><br><span class="line">  isStatic: <span class="literal">false</span>,</span><br><span class="line">  hoisted: &#123;</span><br><span class="line">    <span class="comment">// 对象表达式节点</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">type</span>: <span class="number">9</span>, <span class="comment">/* IF */</span></span><br><span class="line">      branches: [</span><br><span class="line">        <span class="comment">// v-if 解析出的 2 个分支对象</span></span><br><span class="line">      ],</span><br><span class="line">      codegenNode: &#123;</span><br><span class="line">        <span class="comment">// 代码生成节点</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>接下来我们依据 nodes 的值继续生成代码，首先 nodes 第一个元素的值是 ‘div’ 字符串，根据前面的逻辑，直接把字符串添加到代码上即可，由于 multilines 为 false，comma 为 true，因此生成如下代码：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; resolveComponent <span class="keyword">as</span> _resolveComponent, createVNode <span class="keyword">as</span> _createVNode, createCommentVNode <span class="keyword">as</span> _createCommentVNode, toDisplayString <span class="keyword">as</span> _toDisplayString, openBlock <span class="keyword">as</span> _openBlock, createBlock <span class="keyword">as</span> _createBlock &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"><span class="keyword">const</span> _hoisted_1 = &#123; <span class="attr">class</span>: <span class="string">&quot;app&quot;</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_2 = &#123; <span class="attr">key</span>: <span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_3 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">const</span> _hoisted_4 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">_ctx, _cache</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> _component_hello = _resolveComponent(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> (_openBlock(), _createBlock(<span class="string">&quot;div&quot;</span>,</span><br></pre></td></tr></table></figure>
<p>接下来看 nodes 第二个元素，它代表的是 vnode 的属性 props，是一个简单的对象表达式，就会递归执行 genNode，进一步执行 genExpression，来看一下它的实现：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genExpression</span>(<span class="params">node, context</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; content, isStatic &#125; = node</span><br><span class="line">  context.push(isStatic ? <span class="built_in">JSON</span>.stringify(content) : content, node)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里 genExpression 非常简单，就是往代码中添加 content 的内容。此时 node 中的 content 值是 _hoisted_1，再回到 genNodeList，由于 multilines 为 false，comma 为 true，因此生成如下代码：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; resolveComponent <span class="keyword">as</span> _resolveComponent, createVNode <span class="keyword">as</span> _createVNode, createCommentVNode <span class="keyword">as</span> _createCommentVNode, toDisplayString <span class="keyword">as</span> _toDisplayString, openBlock <span class="keyword">as</span> _openBlock, createBlock <span class="keyword">as</span> _createBlock &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"><span class="keyword">const</span> _hoisted_1 = &#123; <span class="attr">class</span>: <span class="string">&quot;app&quot;</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_2 = &#123; <span class="attr">key</span>: <span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_3 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">const</span> _hoisted_4 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">_ctx, _cache</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> _component_hello = _resolveComponent(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> (_openBlock(), _createBlock(<span class="string">&quot;div&quot;</span>, _hoisted_1,</span><br></pre></td></tr></table></figure>
<p>接下来我们再看 nodes 第三个元素，它代表的是子节点 chidren，是一个数组，那么会执行 genNodeListAsArray，来看它的实现：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genNodeListAsArray</span>(<span class="params">nodes, context</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> multilines = nodes.length &gt; <span class="number">3</span> || nodes.some(<span class="function"><span class="params">n</span> =&gt;</span> isArray(n) || !isText$<span class="number">1</span>(n))</span><br><span class="line">  context.push(<span class="string">`[`</span>)</span><br><span class="line">  multilines &amp;&amp; context.indent()</span><br><span class="line">  genNodeList(nodes, context, multilines);</span><br><span class="line">  multilines &amp;&amp; context.deindent()</span><br><span class="line">  context.push(<span class="string">`]`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>genNodeListAsArray 主要是把一个 node 列表生成一个类似数组形式的代码，所以前后会添加中括号，并且判断是否要生成多行代码，如果是多行，前后还需要加减代码的缩进，而中间部分的代码，则继续递归调用 genNodeList 生成。</p>
<p>那么针对我们的示例，此时参数 nodes 的值如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">type</span>: <span class="number">9</span>, <span class="comment">/* IF */</span></span><br><span class="line">    branches: [</span><br><span class="line">      <span class="comment">// v-if 解析出的 2 个分支对象</span></span><br><span class="line">    ],</span><br><span class="line">    codegenNode: &#123;</span><br><span class="line">      <span class="comment">// 代码生成节点</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>它是一个长度为 1 的数组，但是这个数组元素的类型是一个对象，所以 multilines 为 true。那么在执行 genNodeList 之前，生成的代码是这样的：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; resolveComponent <span class="keyword">as</span> _resolveComponent, createVNode <span class="keyword">as</span> _createVNode, createCommentVNode <span class="keyword">as</span> _createCommentVNode, toDisplayString <span class="keyword">as</span> _toDisplayString, openBlock <span class="keyword">as</span> _openBlock, createBlock <span class="keyword">as</span> _createBlock &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"><span class="keyword">const</span> _hoisted_1 = &#123; <span class="attr">class</span>: <span class="string">&quot;app&quot;</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_2 = &#123; <span class="attr">key</span>: <span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_3 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">const</span> _hoisted_4 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">_ctx, _cache</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> _component_hello = _resolveComponent(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> (_openBlock(), _createBlock(<span class="string">&quot;div&quot;</span>, _hoisted_1, [</span><br></pre></td></tr></table></figure>
<p>接下来就是递归执行 genNodeList 的过程，由于 nodes 数组只有一个对象类型的元素，则执行 genNode，并且这个对象的类型是 IF 表达式，回顾 genNode 的实现，此时会执行到genNode(node.codegenNode, context)，也就是取节点的 codegenNode，进一步执行 genNode，我们来看一下这个 codegenNode：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="keyword">type</span>: <span class="number">19</span>, <span class="comment">/* JS_CONDITIONAL_EXPRESSION */</span></span><br><span class="line">  consequent: &#123;</span><br><span class="line">    <span class="comment">// 主逻辑</span></span><br><span class="line">    <span class="keyword">type</span>: <span class="number">13</span>, <span class="comment">/* VNODE_CALL */</span></span><br><span class="line">    tag: <span class="string">&quot;_component_hello&quot;</span>,</span><br><span class="line">    children: <span class="literal">undefined</span>,</span><br><span class="line">    props: &#123;</span><br><span class="line">       <span class="comment">// 属性表达式节点</span></span><br><span class="line">    &#125;,</span><br><span class="line">    directives: <span class="literal">undefined</span>,</span><br><span class="line">    disableTracking: <span class="literal">false</span>,</span><br><span class="line">    dynamicProps: <span class="literal">undefined</span>,</span><br><span class="line">    isBlock: <span class="literal">false</span>,</span><br><span class="line">    patchFlag: <span class="literal">undefined</span></span><br><span class="line">  &#125;,</span><br><span class="line">  alternate: &#123;</span><br><span class="line">    <span class="comment">// 备选逻辑</span></span><br><span class="line">    <span class="keyword">type</span>: <span class="number">13</span>, <span class="comment">/* VNODE_CALL */</span></span><br><span class="line">    tag: <span class="string">&quot;div&quot;</span>,</span><br><span class="line">    children: [</span><br><span class="line">      <span class="comment">// 长度为 3 的子节点</span></span><br><span class="line">    ],</span><br><span class="line">    props: &#123;</span><br><span class="line">       <span class="comment">// 属性表达式节点</span></span><br><span class="line">    &#125;,</span><br><span class="line">    directives: <span class="literal">undefined</span>,</span><br><span class="line">    disableTracking: <span class="literal">false</span>,</span><br><span class="line">    dynamicProps: <span class="literal">undefined</span>,</span><br><span class="line">    isBlock: <span class="literal">true</span>,</span><br><span class="line">    patchFlag: <span class="literal">undefined</span></span><br><span class="line">  &#125;,</span><br><span class="line">  test: &#123;</span><br><span class="line">    <span class="comment">// 逻辑测试</span></span><br><span class="line">    <span class="keyword">type</span>: <span class="number">4</span>, <span class="comment">/* SIMPLE_EXPRESSION */</span></span><br><span class="line">    content: <span class="string">&quot;_ctx.flag&quot;</span>,</span><br><span class="line">    isConstant: <span class="literal">false</span>,</span><br><span class="line">    isStatic: <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  newline: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它是一个条件表达式节点，它主要包括 3 个重要的属性，其中 test 表示逻辑测试，它是一个表达式节点，consequent 表示主逻辑，它是一个 vnode 调用节点，alternate 表示备选逻辑，它也是一个 vnode 调用节点。</p>
<p>其实条件表达式节点要生成代码就是一个条件表达式，用伪代码表示是：test ? consequent : alternate。</p>
<p>genNode 遇到条件表达式节点会执行 genConditionalExpression，我们来看一下它的实现：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genConditionalExpression</span>(<span class="params">node, context</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; test, consequent, alternate, <span class="attr">newline</span>: needNewline &#125; = node</span><br><span class="line">  <span class="keyword">const</span> &#123; push, indent, deindent, newline &#125; = context</span><br><span class="line">  <span class="comment">// 生成条件表达式</span></span><br><span class="line">  <span class="keyword">if</span> (test.type === <span class="number">4</span> <span class="comment">/* SIMPLE_EXPRESSION */</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> needsParens = !isSimpleIdentifier(test.content)</span><br><span class="line">    needsParens &amp;&amp; push(<span class="string">`(`</span>)</span><br><span class="line">    genExpression(test, context)</span><br><span class="line">    needsParens &amp;&amp; push(<span class="string">`)`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    push(<span class="string">`(`</span>)</span><br><span class="line">    genNode(test, context)</span><br><span class="line">    push(<span class="string">`)`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 换行加缩进</span></span><br><span class="line">  needNewline &amp;&amp; indent()</span><br><span class="line">  context.indentLevel++</span><br><span class="line">  needNewline || push(<span class="string">` `</span>)</span><br><span class="line">  <span class="comment">// 生成主逻辑代码</span></span><br><span class="line">  push(<span class="string">`? `</span>)</span><br><span class="line">  genNode(consequent, context)</span><br><span class="line">  context.indentLevel--</span><br><span class="line">  needNewline &amp;&amp; newline()</span><br><span class="line">  needNewline || push(<span class="string">` `</span>)</span><br><span class="line">  <span class="comment">// 生成备选逻辑代码</span></span><br><span class="line">  push(<span class="string">`: `</span>)</span><br><span class="line">  <span class="keyword">const</span> isNested = alternate.type === <span class="number">19</span> <span class="comment">/* JS_CONDITIONAL_EXPRESSION */</span></span><br><span class="line">  <span class="keyword">if</span> (!isNested) &#123;</span><br><span class="line">    context.indentLevel++</span><br><span class="line">  &#125;</span><br><span class="line">  genNode(alternate, context)</span><br><span class="line">  <span class="keyword">if</span> (!isNested) &#123;</span><br><span class="line">    context.indentLevel--</span><br><span class="line">  &#125;</span><br><span class="line">  needNewline &amp;&amp; deindent(<span class="literal">true</span> <span class="comment">/* without newline */</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>genConditionalExpression 的主要目的就是生成条件表达式代码，所以首先它会生成逻辑测试的代码。对于示例，我们这里是一个简单表达式节点，所以生成的代码是这样的：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; resolveComponent <span class="keyword">as</span> _resolveComponent, createVNode <span class="keyword">as</span> _createVNode, createCommentVNode <span class="keyword">as</span> _createCommentVNode, toDisplayString <span class="keyword">as</span> _toDisplayString, openBlock <span class="keyword">as</span> _openBlock, createBlock <span class="keyword">as</span> _createBlock &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"><span class="keyword">const</span> _hoisted_1 = &#123; <span class="attr">class</span>: <span class="string">&quot;app&quot;</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_2 = &#123; <span class="attr">key</span>: <span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_3 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">const</span> _hoisted_4 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">_ctx, _cache</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> _component_hello = _resolveComponent(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> (_openBlock(), _createBlock(<span class="string">&quot;div&quot;</span>, _hoisted_1, [</span><br><span class="line">    (_ctx.flag)</span><br></pre></td></tr></table></figure>
<p>接下来就是生成一些换行和缩进，紧接着生成主逻辑代码，也就是把 consequent 这个 vnode 调用节点通过 genNode 转换生成代码，这又是一个递归过程，其中的细节我就不再赘述了，执行完后会生成如下代码：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; resolveComponent <span class="keyword">as</span> _resolveComponent, createVNode <span class="keyword">as</span> _createVNode, createCommentVNode <span class="keyword">as</span> _createCommentVNode, toDisplayString <span class="keyword">as</span> _toDisplayString, openBlock <span class="keyword">as</span> _openBlock, createBlock <span class="keyword">as</span> _createBlock &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"><span class="keyword">const</span> _hoisted_1 = &#123; <span class="attr">class</span>: <span class="string">&quot;app&quot;</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_2 = &#123; <span class="attr">key</span>: <span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_3 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">const</span> _hoisted_4 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">_ctx, _cache</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> _component_hello = _resolveComponent(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> (_openBlock(), _createBlock(<span class="string">&quot;div&quot;</span>, _hoisted_1, [</span><br><span class="line">    (_ctx.flag)</span><br><span class="line">      ? _createVNode(_component_hello, &#123; <span class="attr">key</span>: <span class="number">0</span> &#125;)</span><br></pre></td></tr></table></figure>
<p>接下来就是生成备选逻辑的代码，即把 alternate 这个 vnode 调用节点通过 genNode 转换生成代码，同样内部的细节我就不赘述了，感兴趣同学可以自行调试。</p>
<p>需要注意的是，<strong>alternate 对应的节点的 isBlock 属性是 true，所以会生成创建 Block 相关的代码，最终生成的代码如下</strong>：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; resolveComponent <span class="keyword">as</span> _resolveComponent, createVNode <span class="keyword">as</span> _createVNode, createCommentVNode <span class="keyword">as</span> _createCommentVNode, toDisplayString <span class="keyword">as</span> _toDisplayString, openBlock <span class="keyword">as</span> _openBlock, createBlock <span class="keyword">as</span> _createBlock &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"><span class="keyword">const</span> _hoisted_1 = &#123; <span class="attr">class</span>: <span class="string">&quot;app&quot;</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_2 = &#123; <span class="attr">key</span>: <span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_3 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">const</span> _hoisted_4 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">_ctx, _cache</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> _component_hello = _resolveComponent(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> (_openBlock(), _createBlock(<span class="string">&quot;div&quot;</span>, _hoisted_1, [</span><br><span class="line">    (_ctx.flag)</span><br><span class="line">      ? _createVNode(_component_hello, &#123; <span class="attr">key</span>: <span class="number">0</span> &#125;)</span><br><span class="line">      : (_openBlock(), _createBlock(<span class="string">&quot;div&quot;</span>, _hoisted_2, [</span><br><span class="line">          _createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;&gt;hello &quot;</span> + _toDisplayString(_ctx.msg + _ctx.test), <span class="number">1</span> <span class="comment">/* TEXT */</span>),</span><br><span class="line">          _hoisted_3,</span><br><span class="line">          _hoisted_4</span><br><span class="line">        ]))</span><br></pre></td></tr></table></figure>
<p>接下来我们回到 genNodeListAsArray 函数，处理完 children，那么下面就会减少缩进，并添加闭合的中括号，就会生成如下的代码：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; resolveComponent <span class="keyword">as</span> _resolveComponent, createVNode <span class="keyword">as</span> _createVNode, createCommentVNode <span class="keyword">as</span> _createCommentVNode, toDisplayString <span class="keyword">as</span> _toDisplayString, openBlock <span class="keyword">as</span> _openBlock, createBlock <span class="keyword">as</span> _createBlock &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"><span class="keyword">const</span> _hoisted_1 = &#123; <span class="attr">class</span>: <span class="string">&quot;app&quot;</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_2 = &#123; <span class="attr">key</span>: <span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_3 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">const</span> _hoisted_4 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">_ctx, _cache</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> _component_hello = _resolveComponent(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> (_openBlock(), _createBlock(<span class="string">&quot;div&quot;</span>, _hoisted_1, [</span><br><span class="line">    (_ctx.flag)</span><br><span class="line">      ? _createVNode(_component_hello, &#123; <span class="attr">key</span>: <span class="number">0</span> &#125;)</span><br><span class="line">      : (_openBlock(), _createBlock(<span class="string">&quot;div&quot;</span>, _hoisted_2, [</span><br><span class="line">          _createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;&gt;hello &quot;</span> + _toDisplayString(_ctx.msg + _ctx.test), <span class="number">1</span> <span class="comment">/* TEXT */</span>),</span><br><span class="line">          _hoisted_3,</span><br><span class="line">          _hoisted_4</span><br><span class="line">        ]))</span><br><span class="line">  ]</span><br></pre></td></tr></table></figure>
<p>genNodeListAsArray 处理完子节点后，回到 genNodeList，发现所有 nodes 也处理完了，则回到 genVNodeCall 函数，接下来的逻辑就是补齐函数调用的右括号，此时生成的代码是这样的：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; resolveComponent <span class="keyword">as</span> _resolveComponent, createVNode <span class="keyword">as</span> _createVNode, createCommentVNode <span class="keyword">as</span> _createCommentVNode, toDisplayString <span class="keyword">as</span> _toDisplayString, openBlock <span class="keyword">as</span> _openBlock, createBlock <span class="keyword">as</span> _createBlock &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"><span class="keyword">const</span> _hoisted_1 = &#123; <span class="attr">class</span>: <span class="string">&quot;app&quot;</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_2 = &#123; <span class="attr">key</span>: <span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_3 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">const</span> _hoisted_4 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">_ctx, _cache</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> _component_hello = _resolveComponent(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> (_openBlock(), _createBlock(<span class="string">&quot;div&quot;</span>, _hoisted_1, [</span><br><span class="line">    (_ctx.flag)</span><br><span class="line">      ? _createVNode(_component_hello, &#123; <span class="attr">key</span>: <span class="number">0</span> &#125;)</span><br><span class="line">      : (_openBlock(), _createBlock(<span class="string">&quot;div&quot;</span>, _hoisted_2, [</span><br><span class="line">          _createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;&gt;hello &quot;</span> + _toDisplayString(_ctx.msg + _ctx.test), <span class="number">1</span> <span class="comment">/* TEXT */</span>),</span><br><span class="line">          _hoisted_3,</span><br><span class="line">          _hoisted_4</span><br><span class="line">        ]))</span><br><span class="line">  ]))</span><br></pre></td></tr></table></figure>
<p>那么至此，根节点 vnode 树的表达式就创建好了。我们再回到 generate 函数，接下来就需要添加右括号 “}” 来闭合渲染函数，最终生成如下代码：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; resolveComponent <span class="keyword">as</span> _resolveComponent, createVNode <span class="keyword">as</span> _createVNode, createCommentVNode <span class="keyword">as</span> _createCommentVNode, toDisplayString <span class="keyword">as</span> _toDisplayString, openBlock <span class="keyword">as</span> _openBlock, createBlock <span class="keyword">as</span> _createBlock &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span></span><br><span class="line"><span class="keyword">const</span> _hoisted_1 = &#123; <span class="attr">class</span>: <span class="string">&quot;app&quot;</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_2 = &#123; <span class="attr">key</span>: <span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">const</span> _hoisted_3 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">const</span> _hoisted_4 = <span class="comment">/*#__PURE__*/</span>_createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;static&quot;</span>, -<span class="number">1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">_ctx, _cache</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> _component_hello = _resolveComponent(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> (_openBlock(), _createBlock(<span class="string">&quot;div&quot;</span>, _hoisted_1, [</span><br><span class="line">    (_ctx.flag)</span><br><span class="line">      ? _createVNode(_component_hello, &#123; <span class="attr">key</span>: <span class="number">0</span> &#125;)</span><br><span class="line">      : (_openBlock(), _createBlock(<span class="string">&quot;div&quot;</span>, _hoisted_2, [</span><br><span class="line">          _createVNode(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;hello &quot;</span> + _toDisplayString(_ctx.msg + _ctx.test), <span class="number">1</span> <span class="comment">/* TEXT */</span>),</span><br><span class="line">          _hoisted_3,</span><br><span class="line">          _hoisted_4</span><br><span class="line">        ]))</span><br><span class="line">  ]))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这就是示例 template 编译生成的最终代码，虽然我们忽略了其中子节点的一些实现细节，但是整体流程还是很容易理解的，主要就是一个递归的思想，遇到不同类型的节点，执行相应的代码生成函数生成代码即可。</p>
<p>节点生成代码的所需的信息可以从节点的属性中获取，这完全得益于前面 transform 的语法分析阶段生成的 codegenNode，根据这些信息就能很容易地生成对应的代码了。</p>
<p>至此，我们已经了解了模板的编译到代码的全部流程。相比 Vue.js 2.x，Vue.js 3.0 在编译阶段设计了 Block 的概念，我们上述示例编译出来的代码就是通过创建一个 Block 来创建对应的 vnode。</p>
<p>那么，这个 Block 在运行时是怎么玩的呢？为什么它会对性能优化起到很大的作用呢？接下来我们就来分析它背后的实现原理。</p>
<h3 id="运行时优化">运行时优化</h3>
<p>首先，我们来看一下 openBlock 的实现：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Open a block.</span></span><br><span class="line"><span class="comment"> * This must be called before `createBlock`. It cannot be part of `createBlock`</span></span><br><span class="line"><span class="comment"> * because the children of the block are evaluated before `createBlock` itself</span></span><br><span class="line"><span class="comment"> * is called. The generated code typically looks like this:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ```js</span></span><br><span class="line"><span class="comment"> * function render() &#123;</span></span><br><span class="line"><span class="comment"> *   return (openBlock(),createBlock(&#x27;div&#x27;, null, [...]))</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> * ```</span></span><br><span class="line"><span class="comment"> * disableTracking is true when creating a v-for fragment block, since a v-for</span></span><br><span class="line"><span class="comment"> * fragment always diffs its children.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> blockStack = []</span><br><span class="line"><span class="keyword">let</span> currentBlock = <span class="literal">null</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">openBlock</span>(<span class="params">disableTracking = <span class="literal">false</span></span>) </span>&#123;</span><br><span class="line">  blockStack.push((currentBlock = disableTracking ? <span class="literal">null</span> : []));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Vue.js 3.0 在运行时设计了一个 blockStack 和 currentBlock，其中 blockStack 表示一个 Block Tree，因为要考虑嵌套 Block 的情况，而currentBlock 表示当前的 Block。</p>
<p>openBlock 的实现很简单，往当前 blockStack push 一个新的 Block，作为 currentBlock。</p>
<p>那么设计 Block 的目的是什么呢？主要就是收集动态的 vnode 的节点，这样才能在 patch 阶段只比对这些动态 vnode 节点，避免不必要的静态节点的比对，优化了性能。</p>
<p>那么动态 vnode 节点是什么时候被收集的呢？其实是在 createVNode 阶段，我们来回顾一下它的实现：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createVNode</span>(<span class="params"><span class="keyword">type</span>, props = <span class="literal">null</span></span></span></span><br><span class="line"><span class="function"><span class="params">,children = <span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 处理 props 相关逻辑，标准化 class 和 style</span></span><br><span class="line">  <span class="comment">// 对 vnode 类型信息编码 </span></span><br><span class="line">  <span class="comment">// 创建 vnode 对象</span></span><br><span class="line">  <span class="comment">// 标准化子节点，把不同数据类型的 children 转成数组或者文本类型。</span></span><br><span class="line">  <span class="comment">// 添加动态 vnode 节点到 currentBlock 中</span></span><br><span class="line">  <span class="keyword">if</span> (shouldTrack &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">    !isBlockNode &amp;&amp;</span><br><span class="line">    currentBlock &amp;&amp;</span><br><span class="line">    patchFlag !== <span class="number">32</span> <span class="comment">/* HYDRATE_EVENTS */</span> &amp;&amp;</span><br><span class="line">    (patchFlag &gt; <span class="number">0</span> ||</span><br><span class="line">      shapeFlag &amp; <span class="number">128</span> <span class="comment">/* SUSPENSE */</span> ||</span><br><span class="line">      shapeFlag &amp; <span class="number">64</span> <span class="comment">/* TELEPORT */</span> ||</span><br><span class="line">      shapeFlag &amp; <span class="number">4</span> <span class="comment">/* STATEFUL_COMPONENT */</span> ||</span><br><span class="line">      shapeFlag &amp; <span class="number">2</span> <span class="comment">/* FUNCTIONAL_COMPONENT */</span>)) &#123;</span><br><span class="line">    currentBlock.push(vnode);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> vnode</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注释中写的前面几个过程，我们在之前的章节已经讲过了，我们来看函数的最后，这里会判断 vnode 是不是一个动态节点，如果是则把它添加到 currentBlock 中，这就是动态 vnode 节点的收集过程。</p>
<p>我们接着来看 createBlock 的实现：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createBlock</span>(<span class="params"><span class="keyword">type</span>, props, children, patchFlag, dynamicProps</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> vnode = createVNode(<span class="keyword">type</span>, props, children, patchFlag, dynamicProps, <span class="literal">true</span> <span class="comment">/* isBlock: 阻止这个 block 收集自身 */</span>)</span><br><span class="line">  <span class="comment">// 在 vnode 上保留当前 Block 收集的动态子节点</span></span><br><span class="line">  vnode.dynamicChildren = currentBlock || EMPTY_ARR</span><br><span class="line">  blockStack.pop()</span><br><span class="line">  <span class="comment">// 当前 Block 恢复到父 Block</span></span><br><span class="line">  currentBlock = blockStack[blockStack.length - <span class="number">1</span>] || <span class="literal">null</span></span><br><span class="line">  <span class="comment">// 节点本身作为父 Block 收集的子节点</span></span><br><span class="line">  <span class="keyword">if</span> (currentBlock) &#123;</span><br><span class="line">    currentBlock.push(vnode)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> vnode</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这时候你可能会好奇，为什么要设计 openBlock 和 createBlock 两个函数呢？比如下面这个函数render()：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (openBlock(),createBlock(<span class="string">&#x27;div&#x27;</span>, <span class="literal">null</span>, [<span class="comment">/*...*/</span>]))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为什么不把 openBlock 和 createBlock 放在一个函数中执行呢，像下面这样：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (createBlock(<span class="string">&#x27;div&#x27;</span>, <span class="literal">null</span>, [<span class="comment">/*...*/</span>]))</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createBlock</span>(<span class="params"><span class="keyword">type</span>, props, children, patchFlag, dynamicProps</span>) </span>&#123;</span><br><span class="line">  openBlock()</span><br><span class="line">  <span class="comment">// 创建 vnode</span></span><br><span class="line">  <span class="keyword">const</span> vnode = createVNode(<span class="keyword">type</span>, props, children, patchFlag, dynamicProps, <span class="literal">true</span>)</span><br><span class="line">  <span class="comment">/* isBlock: prevent a block from tracking itself */</span></span><br><span class="line">  <span class="comment">// ...  </span></span><br><span class="line">  <span class="keyword">return</span> vnode</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样是不行的！其中原因其实很简单，createBlock 函数的第三个参数是 children，这些 children 中的元素也是经过 createVNode 创建的，显然一个函数的调用需要先去执行参数的计算，也就是优先去创建子节点的 vnode，然后才会执行父节点的 createBlock 或者是 createVNode。</p>
<p>所以在父节点的 createBlock 函数执行前，子节点就已经通过 createVNode 创建了对应的 vnode ，如果把 openBlock 的逻辑放在了 createBlock 中，就相当于在子节点创建后才创建 currentBlock，这样就不能正确地收集子节点中的动态 vnode 了。</p>
<p>再回到 createBlock 函数内部，这个时候你要明白动态子节点已经被收集到 currentBlock 中了。</p>
<p>函数首先会执行 createVNode 创建一个 vnode 节点，注意最后一个参数是 true，这表明它是一个 Block node，所以就不会把自身当作一个动态 vnode 收集到 currentBlock 中。</p>
<p>接着把收集动态子节点的 currentBlock 保留到当前的 Block vnode 的 dynamicChildren 中，为后续 patch 过程访问这些动态子节点所用。</p>
<p>最后把当前 Block 恢复到父 Block，如果父 Block 存在的话，则把当前这个 Block node 作为动态节点添加到父 Block 中。</p>
<p>Block Tree 的构造过程我们搞清楚了，那么接下来我们就来看它在 patch 阶段具体是如何工作的。</p>
<p>我们之前分析过，在 patch 阶段更新节点元素的时候，会执行 patchElement 函数，我们再来回顾一下它的实现：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> patchElement = <span class="function">(<span class="params">n1, n2, parentComponent, parentSuspense, isSVG, optimized</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> el = (n2.el = n1.el)</span><br><span class="line">  <span class="keyword">const</span> oldProps = (n1 &amp;&amp; n1.props) || EMPTY_OBJ</span><br><span class="line">  <span class="keyword">const</span> newProps = n2.props || EMPTY_OBJ</span><br><span class="line">  <span class="comment">// 更新 props</span></span><br><span class="line">  patchProps(el, n2, oldProps, newProps, parentComponent, parentSuspense, isSVG)</span><br><span class="line">  <span class="keyword">const</span> areChildrenSVG = isSVG &amp;&amp; n2.type !== <span class="string">&#x27;foreignObject&#x27;</span></span><br><span class="line">  <span class="comment">// 更新子节点</span></span><br><span class="line">  <span class="keyword">if</span> (n2.dynamicChildren) &#123;</span><br><span class="line">    patchBlockChildren(n1.dynamicChildren, n2.dynamicChildren, currentContainer, parentComponent, parentSuspense, isSVG);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (!optimized) &#123;</span><br><span class="line">    patchChildren(n1, n2, currentContainer, currentAnchor, parentComponent, parentSuspense, isSVG);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们在前面组件更新的章节分析过这个流程，在分析子节点更新的部分，当时并没有考虑到优化的场景，所以只分析了全量比对更新的场景。</p>
<p>而实际上，如果这个 vnode 是一个 Block vnode，那么我们不用去通过 patchChildren 全量比对，只需要通过 patchBlockChildren 去比对并更新 Block 中的动态子节点即可。</p>
<p>我们来看一下它的实现：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> patchBlockChildren = <span class="function">(<span class="params">oldChildren, newChildren, fallbackContainer, parentComponent, parentSuspense, isSVG</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; newChildren.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> oldVNode = oldChildren[i]</span><br><span class="line">    <span class="keyword">const</span> newVNode = newChildren[i]</span><br><span class="line">    <span class="comment">// 确定待更新节点的容器</span></span><br><span class="line">    <span class="keyword">const</span> container =</span><br><span class="line">      <span class="comment">// 对于 Fragment，我们需要提供正确的父容器</span></span><br><span class="line">      oldVNode.type === Fragment ||</span><br><span class="line">      <span class="comment">// 在不同节点的情况下，将有一个替换节点，我们也需要正确的父容器</span></span><br><span class="line">      !isSameVNodeType(oldVNode, newVNode) ||</span><br><span class="line">      <span class="comment">// 组件的情况，我们也需要提供一个父容器</span></span><br><span class="line">      oldVNode.shapeFlag &amp; <span class="number">6</span> <span class="comment">/* COMPONENT */</span></span><br><span class="line">        ? hostParentNode(oldVNode.el)</span><br><span class="line">        :</span><br><span class="line">        <span class="comment">// 在其他情况下，父容器实际上并没有被使用，所以这里只传递 Block 元素即可</span></span><br><span class="line">        fallbackContainer</span><br><span class="line">    patch(oldVNode, newVNode, container, <span class="literal">null</span>, parentComponent, parentSuspense, isSVG, <span class="literal">true</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>patchBlockChildren 的实现很简单，遍历新的动态子节点数组，拿到对应的新旧动态子节点，并执行 patch 更新子节点即可。</p>
<p>这样一来，更新的复杂度就变成和动态节点的数量正相关，而不与模板大小正相关，如果一个模板的动静比越低，那么性能优化的效果就越明显。</p>
<h3 id="总结">总结</h3>
<p>好的，到这里我们这一节的学习也要结束啦，通过这节课的学习，你应该了解了 AST 是如何生成可运行的代码，也应该明白了 Vue.js 3.0 是如何通过 Block 的方式实现了运行时组件更新的性能优化。</p>
<p>我也推荐你写一些其他的示例，通过断点调试的方式，看看不同的场景的代码生成过程。</p>
<h3 id="题外">题外</h3>
<h4 id="最后，给你留一道思考题目，Block-数组是一维的，但是动态的子节点可能有嵌套关系，patchBlockChildren-内部也是递归执行了-patch-函数，那么在整个更新的过程中，会出现子节点重复更新的情况吗，为什么？">最后，给你留一道思考题目，Block 数组是一维的，但是动态的子节点可能有嵌套关系，patchBlockChildren 内部也是递归执行了 patch 函数，那么在整个更新的过程中，会出现子节点重复更新的情况吗，为什么？</h4>
<p>个人感觉不会</p>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/en/微前端-字节跳动是如何落地微前端的/" data-toggle="tooltip" data-placement="top" title="[微前端] 字节跳动是如何落地微前端的">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/en/vue3-【源码解读】AST转换/" data-toggle="tooltip" data-placement="top" title="[vue3 源码解读] AST转换">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. If the images used in the blog infringe your copyright, please contact the author to delete them. Thank you !
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->

  <!-- gitalk start -->
  <!-- Docs:https://github.com/gitalk/gitalk/blob/master/readme-cn.md -->

  <div id="gitalk-container"></div>

  
    <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.js"></script> -->
    <script src="/js/comment/gitalk.js"></script>
  

  <script>
    var gitalk = new Gitalk({
      clientID: 'be77013e3cb3cb9e89f1',
      clientSecret: '39e9b02a8070f1366c5e87418220c8f375864ab8',
      repo: 'jasonluox',
      owner: 'JasonLuox',
      admin: 'JasonLuox',
      id: 'Sat Sep 25 2021 17:10:17 GMT+0800', // Ensure uniqueness and length less than 50
      distractionFreeMode: false, // Facebook-like distraction free mode
      perPage: 10,
      pagerDirection: 'last',
      createIssueManually: false,
      language: 'en',
      proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token'
    });
    gitalk.render('gitalk-container');

    var gtFolded = () => {
      setTimeout(function () {
        let markdownBody = document.getElementsByClassName("markdown-body");
        let list = Array.from(markdownBody);
        list.forEach(item => {
          if (item.clientHeight > 250) {
            item.classList.add('gt-comment-body-folded');
            item.style.maxHeight = '250px';
            item.title = 'Click to Expand';
            item.onclick = function () {
              item.classList.remove('gt-comment-body-folded');
              item.style.maxHeight = '';
              item.title = '';
              item.onclick = null;
            };
          }
        })
      }, 800);
    }
  </script>

  <!-- gitalk end -->


<!-- 2. gitment comment -->


<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%BA%90%E7%A0%81%E5%9C%B0%E5%9D%80"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">源码地址</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#generate-%E5%87%BD%E6%95%B0"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">generate 函数</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%9B%E5%BB%BA%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">创建代码生成上下文</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E7%94%9F%E6%88%90%E9%A2%84%E8%AE%BE%E4%BB%A3%E7%A0%81"><span class="toc-nav-number">2.2.</span> <span class="toc-nav-text">生成预设代码</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E7%94%9F%E6%88%90%E6%B8%B2%E6%9F%93%E5%87%BD%E6%95%B0"><span class="toc-nav-number">2.3.</span> <span class="toc-nav-text">生成渲染函数</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E7%94%9F%E6%88%90%E8%B5%84%E6%BA%90%E5%A3%B0%E6%98%8E%E4%BB%A3%E7%A0%81"><span class="toc-nav-number">2.4.</span> <span class="toc-nav-text">生成资源声明代码</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E7%94%9F%E6%88%90%E5%88%9B%E5%BB%BA-VNode-%E6%A0%91%E7%9A%84%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-nav-number">2.5.</span> <span class="toc-nav-text">生成创建 VNode 树的表达式</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E4%BC%98%E5%8C%96"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">运行时优化</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">总结</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E9%A2%98%E5%A4%96"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">题外</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%9C%80%E5%90%8E%EF%BC%8C%E7%BB%99%E4%BD%A0%E7%95%99%E4%B8%80%E9%81%93%E6%80%9D%E8%80%83%E9%A2%98%E7%9B%AE%EF%BC%8CBlock-%E6%95%B0%E7%BB%84%E6%98%AF%E4%B8%80%E7%BB%B4%E7%9A%84%EF%BC%8C%E4%BD%86%E6%98%AF%E5%8A%A8%E6%80%81%E7%9A%84%E5%AD%90%E8%8A%82%E7%82%B9%E5%8F%AF%E8%83%BD%E6%9C%89%E5%B5%8C%E5%A5%97%E5%85%B3%E7%B3%BB%EF%BC%8CpatchBlockChildren-%E5%86%85%E9%83%A8%E4%B9%9F%E6%98%AF%E9%80%92%E5%BD%92%E6%89%A7%E8%A1%8C%E4%BA%86-patch-%E5%87%BD%E6%95%B0%EF%BC%8C%E9%82%A3%E4%B9%88%E5%9C%A8%E6%95%B4%E4%B8%AA%E6%9B%B4%E6%96%B0%E7%9A%84%E8%BF%87%E7%A8%8B%E4%B8%AD%EF%BC%8C%E4%BC%9A%E5%87%BA%E7%8E%B0%E5%AD%90%E8%8A%82%E7%82%B9%E9%87%8D%E5%A4%8D%E6%9B%B4%E6%96%B0%E7%9A%84%E6%83%85%E5%86%B5%E5%90%97%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-nav-number">5.1.</span> <span class="toc-nav-text">最后，给你留一道思考题目，Block 数组是一维的，但是动态的子节点可能有嵌套关系，patchBlockChildren 内部也是递归执行了 patch 函数，那么在整个更新的过程中，会出现子节点重复更新的情况吗，为什么？</span></a></li></ol></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">FEATURED TAGS</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#vue3源码" title="vue3源码">vue3源码</a>
            
            <a class="tag" href="/tags/#vue3" title="vue3">vue3</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          

          

          

          

          

          

          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          Jason Luo
          2021
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="/js/hux-blog.min.js"></script>
  <!-- catalog -->
  <script async="true" type="text/javascript" src="/js/catalog.js"></script>
  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="/js/scroll.js"></script>
    <!-- Scroll end -->
  

  
    <!-- LangSelect start -->
    <script type="text/javascript" src="/js/langselect.js"></script>
    <!-- LangSelect end -->
  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="/js/mouseclick.js" content='我要变强，为此不惜一切...,一念往，尽作尘泥罢...,玻璃晴朗，橘子辉煌...,我心即地狱，管他罪孽滔天...,我要这天，再遮不住我眼...,我要这地，再埋不了我心...,斯若晴空，何惧冰寒...,这灯红酒绿的世界啊...,不要放弃，哪怕付出所有...' color='#CDF0EA,#F9F9F9,#F7DBF0,#BEAEE2,#F38181,#FCE38A,#EAFFD0,#95E1D3,#80D6FF'></script>
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="/js/ribbonDynamic.js"></script>
  

  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("https://jasonluox.github.io/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="SEARCH..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"mobile":{"show":"fasle"},"display":{"hOffset":-40,"vOffset":-80},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
